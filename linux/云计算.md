# äº‘è®¡ç®—

 KVM 

 ä»€ä¹ˆæ˜¯è™šæ‹ŸåŒ– 

åœ¨è®¡ç®—æœºæŠ€æœ¯ä¸­ï¼Œè™šæ‹ŸåŒ–ï¼ˆæŠ€æœ¯ï¼‰æˆ–è™šæ‹ŸæŠ€æœ¯ï¼ˆè‹±è¯­ï¼šVirtualizationï¼‰æ˜¯ä¸€ç§èµ„æºç®¡ç†æŠ€æœ¯ï¼Œæ˜¯å°†è®¡ç®—æœºçš„å„ç§å®ä½“èµ„æºï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ç©ºé—´ã€ç½‘ç»œé€‚é…å™¨ç­‰ï¼‰ï¼Œäºˆä»¥æŠ½è±¡ã€è½¬æ¢åå‘ˆç°å‡ºæ¥å¹¶å¯ä¾›åˆ†åŒºã€ç»„åˆä¸ºä¸€ä¸ªæˆ–å¤šä¸ªç”µè„‘é…ç½®ç¯å¢ƒã€‚



ç”±æ­¤ï¼Œæ‰“ç ´å®ä½“ç»“æ„é—´çš„ä¸å¯åˆ‡å‰²çš„éšœç¢ï¼Œä½¿ç”¨æˆ·å¯ä»¥æ¯”åŸæœ¬çš„é…ç½®æ›´å¥½çš„æ–¹å¼æ¥åº”ç”¨è¿™äº›ç”µè„‘ç¡¬ä»¶èµ„æºã€‚è¿™äº›èµ„æºçš„æ–°è™šæ‹Ÿéƒ¨åˆ†æ˜¯ä¸å—ç°æœ‰èµ„æºçš„æ¶è®¾æ–¹å¼ï¼Œåœ°åŸŸæˆ–ç‰©ç†é…ç½®æ‰€é™åˆ¶ã€‚

ä¸€èˆ¬æ‰€æŒ‡çš„è™šæ‹ŸåŒ–èµ„æºåŒ…æ‹¬è®¡ç®—èƒ½åŠ›å’Œæ•°æ®å­˜å‚¨ã€‚

ç”±äºç›®å‰ä¿¡æ¯æŠ€æœ¯é¢†åŸŸçš„å¾ˆå¤šä¼ä¸šéƒ½æ›¾åœ¨å®£ä¼ ä¸­å°†è¯¥ä¼ä¸šçš„æŸç§æŠ€æœ¯ç§°ä¸ºè™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œè¿™äº›æŠ€æœ¯æ¶µç›–çš„èŒƒå›´å¯ä»¥ä»Javaè™šæ‹ŸæœºæŠ€æœ¯åˆ°ç³»ç»Ÿç®¡ç†è½¯ä»¶ï¼Œè¿™å°±ä½¿å¾—å‡†ç¡®çš„ç•Œå®šè™šæ‹ŸæŠ€æœ¯å˜å¾—å›°éš¾ã€‚å› æ­¤å„ç§ç›¸å…³å­¦æœ¯è®ºæ–‡åœ¨è°ˆåˆ°è™šæ‹ŸæŠ€æœ¯æ—¶å¸¸å¸¸æåˆ°çš„ä¾¿æ˜¯å¦‚å‰é¢æ‰€æåˆ°çš„é‚£ä¸ªä¸ä¸¥æ ¼çš„å®šä¹‰ã€‚

```plain
è™šæ‹ŸåŒ–å°±æ˜¯é€šè¿‡æ¨¡æ‹Ÿè®¡ç®—æœºç¡¬ä»¶ï¼ˆcpuï¼Œå†…å­˜ï¼Œç¡¬ç›˜ï¼Œç½‘å¡ç­‰ï¼‰æ¥å®ç°åœ¨ä¸€å°ç‰©ç†æœºä¸Šè¿è¡Œå¤šä¸ªä¸åŒçš„æ“ä½œç³»ç»Ÿï¼Œä¸”ä½¿å¾—æ¯ä¸ªæ“ä½œç³»ç»Ÿä¹‹é—´éƒ½æ˜¯éš”ç¦»çš„ã€‚
```

# ä¸ºä»€ä¹ˆç”¨è™šæ‹ŸåŒ–

åŒä¸€å°ç‰©ç†æœºè¿è¡Œå¤šä¸ªä¸åŒç‰ˆæœ¬åº”ç”¨è½¯ä»¶

ç¡¬ä»¶ä¾èµ–æ€§è¾ƒä½å’Œä¾¿äºæ•°æ®è¿ç§»

```plain
è™šæ‹ŸåŒ–æŠ€æœ¯å¯ä½¿å½“å‰çš„ x86 æœåŠ¡å™¨è¿è¡Œå¤šä¸ªæ“ä½œç³»ç»Ÿå’Œåº”ç”¨ï¼Œè®©æ‚¨çš„æ•°æ®ä¸­å¿ƒå˜å¾—æ›´åŠ é«˜æ•ˆã€‚å·¥ä½œè´Ÿè½½èƒ½å¤Ÿæ›´å¿«éƒ¨ç½²ï¼Œæ€§èƒ½å’Œå¯ç”¨æ€§å¯å¾—åˆ°æå‡ï¼Œæ“ä½œå¯è‡ªåŠ¨è¿›è¡Œï¼Œè¿™äº›éƒ½æœ‰åŠ©äºç®€åŒ– IT çš„ç®¡ç†ï¼Œå¹¶é™ä½å…¶æ‹¥æœ‰å’Œè¿ç»´æˆæœ¬ã€‚
VmwareæœåŠ¡å™¨è™šæ‹ŸåŒ–(VMware Vsphere)
ã€€ã€€å¯¹æ“ä½œç³»ç»Ÿå’Œåº”ç”¨è¿›è¡ŒæŠ½è±¡åŒ–ï¼Œä½¿å…¶ä¸ç‰©ç†ç¡¬ä»¶åˆ†ç¦»ï¼Œä½¿æ‚¨å¯ä»¥è·å¾—ä¸€ä¸ªæ›´åŠ ç»æµé«˜æ•ˆã€æ•æ·å’Œç®€åŒ–çš„æœåŠ¡å™¨ç¯å¢ƒã€‚å€ŸåŠ©æœåŠ¡å™¨è™šæ‹ŸåŒ–ï¼Œå¤šä¸ªæ“ä½œç³»ç»Ÿèƒ½å¤Ÿä»¥è™šæ‹Ÿæœºæ–¹å¼è¿è¡Œåœ¨ä¸€ä¸ªç‰©ç†æœåŠ¡å™¨ä¸Šï¼Œæ¯ä¸ªè™šæ‹Ÿæœºå‡å¯è®¿é—®åº•å±‚æœåŠ¡å™¨è®¡ç®—èµ„æºã€‚ 
ã€€ã€€
ã€€ã€€ç›®å‰ï¼Œå¤§å¤šæ•°æœåŠ¡å™¨çš„å®¹é‡çš„åˆ©ç”¨ç‡ä¸è¶³ 15%ï¼Œè¿™å¯¼è‡´æœåŠ¡å™¨æ•°é‡å‰§å¢ä»¥åŠå¢åŠ äº†å¤æ‚æ€§ã€‚æœåŠ¡å™¨è™šæ‹ŸåŒ–å¯ä»¥è§£å†³è¿™äº›æ•ˆç‡ä½ä¸‹é—®é¢˜ã€‚VMware vSphere æä¾›å…¨é¢çš„æœåŠ¡å™¨è™šæ‹ŸåŒ–å¹³å°ï¼Œå¯å®ç°ä»¥ä¸‹æˆæ•ˆï¼š
ã€€ã€€â—æœåŠ¡å™¨èµ„æºåˆ©ç”¨ç‡æå‡80%
ã€€ã€€â—èµ„é‡‘å’Œè¿ç»´æˆæœ¬èŠ‚çœé«˜è¾¾50%
ã€€ã€€â—10ï¼š1æˆ–æ›´é«˜çš„æœåŠ¡å™¨æ•´åˆç‡
```

![img](äº‘è®¡ç®—.assets/1610861870909-57be9cf9-aa03-431a-8c38-856a6d64da3d.png)

è™šæ‹Ÿè®¡ç®—èµ„æºæ± 

åœ¨å®ä½“æœåŠ¡å™¨æ²¡æœ‰è™šæ‹ŸåŒ–æŠ€æœ¯æˆä¸ºäº‘æœåŠ¡å™¨ä¹‹å‰ï¼Œå½“æ—¶ä¼ä¸šéƒ½æ˜¯ä»¥ç‰©ç†æœåŠ¡å™¨ä¹Ÿå°±æ˜¯å®ä½“æœºæ¥è¿è¡Œã€‚é‚£ä¸ªæ—¶å€™æˆ‘ä»¬æ²¡æœ‰å……åˆ†çš„åˆ©ç”¨èµ·æœåŠ¡å™¨â€œè®¡ç®—â€çš„èƒ½åŠ›ï¼Œè€Œä¸”ä¹Ÿå› ä¸ºå®ä½“æœºæ³›æ»¥ä¹Ÿé€ æˆç”µè´¹é£™å‡ï¼Œæ‰€ä»¥å½“æ—¶è·ŸITæ²¾è¾¹çš„äº§ä¸šå…¶ä»·æ ¼å‡ä¸è²ã€‚

![img](äº‘è®¡ç®—.assets/1610861870910-5347a2d2-73f8-4745-9656-17ff76d4249a.png)

# è™šæ‹ŸåŒ–æŠ€æœ¯çš„ä¼˜åŠ¿

 1.é™ä½è¿è¥æˆæœ¬

ã€€ã€€æœåŠ¡å™¨è™šæ‹ŸåŒ–é™ä½äº†ITåŸºç¡€è®¾æ–½çš„è¿è¥æˆæœ¬ï¼Œä»¤ç³»ç»Ÿç®¡ç†å‘˜æ‘†è„±äº†ç¹é‡çš„ç‰©ç†æœåŠ¡å™¨ã€OSã€ä¸­é—´ä»¶åŠå…¼å®¹æ€§çš„ç®¡ç†å·¥ä½œï¼Œå‡å°‘äººå·¥å¹²é¢„é¢‘ç‡ï¼Œä½¿ç®¡ç†æ›´åŠ å¼ºå¤§ã€ä¾¿æ·ã€‚

ã€€ã€€2.æé«˜åº”ç”¨å…¼å®¹æ€§

ã€€ã€€æœåŠ¡å™¨è™šæ‹ŸåŒ–æä¾›çš„å°è£…æ€§å’Œéš”ç¦»æ€§ä½¿å¤§é‡åº”ç”¨ç‹¬ç«‹è¿è¡Œäºå„ç§ç¯å¢ƒä¸­ï¼Œç®¡ç†äººå‘˜ä¸éœ€é¢‘ç¹æ ¹æ®åº•å±‚ç¯å¢ƒè°ƒæ•´åº”ç”¨ï¼Œåªéœ€æ„å»ºä¸€ä¸ªåº”ç”¨ç‰ˆæœ¬å¹¶å°†å…¶å‘å¸ƒåˆ°è™šæ‹ŸåŒ–åçš„ä¸åŒç±»å‹å¹³å°ä¸Šå³å¯ã€‚

ã€€ã€€3.åŠ é€Ÿåº”ç”¨éƒ¨ç½²

ã€€ã€€é‡‡ç”¨æœåŠ¡å™¨è™šæ‹ŸåŒ–æŠ€æœ¯åªéœ€è¾“å…¥æ¿€æ´»é…ç½®å‚æ•°ã€æ‹·è´è™šæ‹Ÿæœºã€å¯åŠ¨è™šæ‹Ÿæœºã€æ¿€æ´»è™šæ‹Ÿæœºå³å¯å®Œæˆéƒ¨ç½²ï¼Œå¤§å¤§ç¼©çŸ­äº†éƒ¨ç½²æ—¶é—´ï¼Œå…é™¤äººå·¥å¹²é¢„ï¼Œé™ä½äº†éƒ¨ç½²æˆæœ¬ã€‚

ã€€ã€€4.æé«˜æœåŠ¡å¯ç”¨æ€§

ã€€ã€€ç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°å¤‡ä»½è™šæ‹Ÿæœºï¼Œåœ¨è¿›è¡Œè™šæ‹ŸæœºåŠ¨æ€è¿ç§»åï¼Œå¯ä»¥æ–¹ä¾¿çš„æ¢å¤å¤‡ä»½ï¼Œæˆ–è€…åœ¨å…¶ä»–ç‰©ç†æœºä¸Šè¿è¡Œå¤‡ä»½ï¼Œå¤§å¤§æé«˜äº†æœåŠ¡çš„å¯ç”¨æ€§ã€‚

ã€€ã€€5.æå‡èµ„æºåˆ©ç”¨ç‡

ã€€ã€€é€šè¿‡æœåŠ¡å™¨è™šæ‹ŸåŒ–çš„æ•´åˆï¼Œæé«˜äº†CPUã€å†…å­˜ã€å­˜å‚¨ã€ç½‘ç»œç­‰è®¾å¤‡çš„åˆ©ç”¨ç‡ï¼ŒåŒæ—¶ä¿è¯åŸæœ‰æœåŠ¡çš„å¯ç”¨æ€§ï¼Œä½¿å…¶å®‰å…¨æ€§åŠæ€§èƒ½ä¸å—å½±å“ã€‚

ã€€ã€€6.åŠ¨æ€è°ƒåº¦èµ„æº

ã€€ã€€åœ¨æœåŠ¡å™¨è™šæ‹ŸåŒ–æŠ€æœ¯ä¸­ï¼Œæ•°æ®ä¸­å¿ƒä»ä¼ ç»Ÿçš„å•ä¸€æœåŠ¡å™¨å˜æˆäº†ç»Ÿä¸€çš„èµ„æºæ± ï¼Œç”¨æˆ·å¯ä»¥å³æ—¶åœ°è°ƒæ•´è™šæ‹Ÿæœºèµ„æºï¼ŒåŒæ—¶æ•°æ®ä¸­å¿ƒç®¡ç†ç¨‹åºå’Œæ•°æ®ä¸­å¿ƒç®¡ç†å‘˜å¯ä»¥çµæ´»æ ¹æ®è™šæ‹Ÿæœºå†…éƒ¨èµ„æºä½¿ç”¨æƒ…å†µçµæ´»åˆ†é…è°ƒæ•´ç»™è™šæ‹Ÿæœºçš„èµ„æºã€‚

ã€€ã€€7.é™ä½èƒ½æºæ¶ˆè€—

ã€€ã€€é€šè¿‡å‡å°‘è¿è¡Œçš„ç‰©ç†æœåŠ¡å™¨æ•°é‡ï¼Œå‡å°‘CPUä»¥å¤–å„å•å…ƒçš„è€—ç”µé‡ï¼Œè¾¾åˆ°èŠ‚èƒ½å‡æ’çš„ç›®çš„ã€‚

## **ä¸åŒç±»å‹çš„æœåŠ¡å™¨è™šæ‹ŸåŒ–**

åœ¨æœåŠ¡å™¨è™šæ‹ŸåŒ–ä¸–ç•Œä¸­ï¼Œå®ä½“æœåŠ¡å™¨ç§°ä¸ºä¸»æœºï¼Œå¹¶è¿è¡Œä¸»æœºæ“ä½œç³»ç»Ÿã€‚æ¯ä¸ªVMéƒ½æ˜¯ä¸€ä¸ªæ¥å®¾ï¼Œå¹¶è¿è¡Œä¸€ä¸ªæ¥å®¾æ“ä½œç³»ç»Ÿã€‚æ¥å®¾å½¼æ­¤åˆ†éš”ã€‚

é€šè¿‡åŸºäºæ ‡å‡†è™šæ‹Ÿæœºç®¡ç†ç¨‹åºçš„è™šæ‹ŸåŒ–ï¼Œè™šæ‹Ÿæœºç®¡ç†ç¨‹åºæˆ–è™šæ‹Ÿæœºç›‘è§†å™¨ï¼ˆVMMï¼‰ä½äºä¸»æœºæ“ä½œç³»ç»Ÿå’Œåº•å±‚ç¡¬ä»¶å±‚ä¹‹é—´ï¼Œä¸ºæ¥å®¾æ“ä½œç³»ç»Ÿæä¾›å¿…è¦çš„èµ„æº

åœ¨å®‰è£…åˆ°è™šæ‹Ÿæœºä¹‹å‰ï¼ŒåŠè™šæ‹ŸåŒ–å’Œå®Œå…¨è™šæ‹ŸåŒ–ä¼šä¿®æ”¹å®¢æˆ·æœºæ“ä½œç³»ç»Ÿã€‚ç”±äºä¿®æ”¹åçš„æ¥å®¾æ“ä½œç³»ç»Ÿç›´æ¥ä¸è™šæ‹Ÿæœºç®¡ç†ç¨‹åºè¿›è¡Œé€šä¿¡ï¼Œå› æ­¤å¯ä»¥æé«˜æ€§èƒ½ï¼Œä»è€Œæ¶ˆé™¤äº†ä»¿çœŸå¼€é”€ã€‚

ç¡¬ä»¶è¾…åŠ©çš„è™šæ‹ŸåŒ–è¿˜è¯•å›¾å‡å°‘è™šæ‹Ÿæœºç›‘æ§ç¨‹åºçš„å¼€é”€ï¼Œä½†æ˜¯è¿™æ ·åšæ˜¯é€šè¿‡ç¡¬ä»¶æ‰©å±•è€Œä¸æ˜¯è½¯ä»¶ä¿®æ”¹æ¥å®ç°çš„ã€‚

## KVMå†…æ ¸çº§çš„è™šæ‹Ÿæœº

ä½¿ç”¨å†…æ ¸çº§è™šæ‹ŸåŒ–ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç®¡ç†ç¨‹åºï¼Œæ‚¨å¯ä»¥è¿è¡Œå•ç‹¬ç‰ˆæœ¬çš„Linuxå†…æ ¸ã€‚è¿™ä½¿å¾—ä½¿ç”¨ç”¨äºåœ¨ä¸»è¦Linuxå†…æ ¸å’Œè™šæ‹Ÿæœºä¹‹é—´è¿›è¡Œé€šä¿¡çš„è®¾å¤‡é©±åŠ¨ç¨‹åºè½»æ¾åœ¨å•ä¸ªä¸»æœºä¸Šè¿è¡Œå¤šä¸ªè™šæ‹Ÿæœºã€‚

æœ€åï¼Œé€šè¿‡ç³»ç»Ÿçº§æˆ–OSè™šæ‹ŸåŒ–ï¼Œæ‚¨å¯ä»¥åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸çš„å•ä¸ªå®ä¾‹ä¸Šè¿è¡Œå¤šä¸ªä½†é€»è¾‘ä¸Šä¸åŒçš„ç¯å¢ƒã€‚ä½¿ç”¨ç³»ç»Ÿçº§è™šæ‹ŸåŒ–ï¼Œæ‰€æœ‰VMå¿…é¡»å…±äº«æ“ä½œç³»ç»Ÿçš„åŒä¸€å‰¯æœ¬ï¼Œè€ŒæœåŠ¡å™¨è™šæ‹ŸåŒ–å…è®¸ä¸åŒçš„VMå…·æœ‰ä¸åŒçš„æ“ä½œç³»ç»Ÿã€‚

è‹¥æ˜¯ç”¨çš„VMwareè™šæ‹Ÿæœºï¼Œåˆ™æ˜¾ç¤ºçš„æ˜¯VMware

å…¬æœ‰äº‘çš„æœåŠ¡å™¨ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯KVMäº†ã€‚

![img](äº‘è®¡ç®—.assets/1610861870914-beef53aa-459c-4122-9840-24b31f7243cc.png)

ç›®å‰å›½å†…çš„å…¬æœ‰äº‘åº•å±‚é‡‡ç”¨çš„éƒ½æ˜¯kvmè™šæ‹ŸåŒ–ï¼Œç»è¿‡å¤šå¹´çš„å‘å±•ï¼Œkvmè®¡ç®—å·²ç»éå¸¸æˆç†Ÿï¼Œkvmå·²ç»æ˜¯å†…æ ¸è™šæ‹ŸåŒ–çš„æ ‡é…ã€‚

# KVMç®€ä»‹

![img](äº‘è®¡ç®—.assets/1610861870914-683f1163-2f43-46c8-87e7-626f7b5b6e9d.png)

ã€€ã€€KVMï¼ŒåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœºï¼ˆè‹±è¯­ï¼š*Kernel-based Virtual Machine*ï¼Œç¼©å†™ä¸º KVMï¼‰ï¼Œæ˜¯ä¸€ç§ç”¨äºLinuxå†…æ ¸ä¸­çš„è™šæ‹ŸåŒ–åŸºç¡€è®¾æ–½ï¼Œå¯ä»¥å°†Linuxå†…æ ¸è½¬åŒ–ä¸ºä¸€ä¸ªhypervisorã€‚KVMåœ¨2007å¹´2æœˆè¢«å¯¼å…¥Linux 2.6.20æ ¸å¿ƒä¸­ï¼Œä»¥å¯åŠ è½½æ ¸å¿ƒæ¨¡å—çš„æ–¹å¼è¢«ç§»æ¤åˆ°FreeBSDåŠillumosä¸Šã€‚

ã€€ã€€KVMåœ¨å…·å¤‡Intel VTæˆ–AMD-VåŠŸèƒ½çš„x86å¹³å°ä¸Šè¿è¡Œã€‚å®ƒä¹Ÿè¢«ç§»æ¤åˆ°S/390ï¼ŒPowerPCä¸IA-64å¹³å°ä¸Šã€‚åœ¨Linuxå†…æ ¸3.9ç‰ˆä¸­ï¼ŒåŠ å…¥ARMæ¶æ„çš„æ”¯æŒã€‚

ã€€ã€€KVMç›®å‰ç”±Red Hatç­‰å‚å•†å¼€å‘ï¼Œå¯¹CentOS/Fedora/RHELç­‰Red Hatç³»å‘è¡Œç‰ˆæ”¯æŒæä½³ã€‚

## å…³äºKVM

1. KVMæ˜¯å¼€æºè½¯ä»¶ï¼Œå…¨ç§°æ˜¯kernel-based virtual machineï¼ˆåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœºï¼‰ã€‚
2. æ˜¯x86æ¶æ„ä¸”ç¡¬ä»¶æ”¯æŒè™šæ‹ŸåŒ–æŠ€æœ¯ï¼ˆå¦‚ intel VT æˆ– AMD-Vï¼‰çš„Linuxå…¨è™šæ‹ŸåŒ–è§£å†³æ–¹æ¡ˆã€‚
3. å®ƒåŒ…å«ä¸€ä¸ªä¸ºå¤„ç†å™¨æä¾›åº•å±‚è™šæ‹ŸåŒ– å¯åŠ è½½çš„æ ¸å¿ƒæ¨¡å—kvm.koï¼ˆkvm-intel.koæˆ–kvm-AMD.koï¼‰ã€‚
4. KVMè¿˜éœ€è¦ä¸€ä¸ªç»è¿‡ä¿®æ”¹çš„QEMUè½¯ä»¶ï¼ˆqemu-kvmï¼‰ï¼Œä½œä¸ºè™šæ‹Ÿæœºä¸Šå±‚æ§åˆ¶å’Œç•Œé¢ã€‚
5. KVMèƒ½åœ¨ä¸æ”¹å˜linuxæˆ–windowsé•œåƒçš„æƒ…å†µä¸‹åŒæ—¶è¿è¡Œå¤šä¸ªè™šæ‹Ÿæœºï¼Œï¼ˆå®ƒçš„æ„æ€æ˜¯å¤šä¸ªè™šæ‹Ÿæœºä½¿ç”¨åŒä¸€é•œåƒï¼‰å¹¶ä¸ºæ¯ä¸€ä¸ªè™šæ‹Ÿæœºé…ç½®ä¸ªæ€§åŒ–ç¡¬ä»¶ç¯å¢ƒï¼ˆç½‘å¡ã€ç£ç›˜ã€å›¾å½¢é€‚é…å™¨â€¦â€¦ï¼‰åŒæ—¶KVMè¿˜èƒ½å¤Ÿä½¿ç”¨ksmæŠ€æœ¯å¸®åŠ©å®¿ä¸»æœåŠ¡å™¨èŠ‚çº¦å†…å­˜ã€‚
6. åœ¨ä¸»æµçš„Linuxå†…æ ¸ï¼Œå¦‚2.6.20ä»¥ä¸Šçš„å†…æ ¸å‡å·²åŒ…å«äº†KVMæ ¸å¿ƒã€‚

# å®‰è£…KVM

## ç³»ç»Ÿç¯å¢ƒè¯´æ˜

ä¸»æœºå ip ç³»ç»Ÿ å†…å­˜ ç¡¬ç›˜

kvm01 10.0.1.50 centos7 4G 50G

**æ³¨æ„å¼€å¯vmwareé‡Œçš„cpuè®¾ç½®ï¼Œå¼€å¯è™šæ‹ŸåŒ–Intel VT-xï¼Œæ— è®ºæ˜¯macï¼Œè¿˜æ˜¯windows**

æ³¨æ„ä½¿ç”¨kvmçš„æœºå™¨ï¼Œä¸è¦ä½¿ç”¨lvmåˆ†åŒºï¼Œå¦åˆ™ç‰¹åˆ«å¡ï¼Œä½¿ç”¨æ ‡å‡†åˆ†åŒºï¼Œä¸”ä¸éœ€è¦swapåˆ†åŒº

ç¡¬ç›˜ç»™å¤§ä¸€ç‚¹ï¼Œå› ä¸ºåé¢è¦è¿˜è¦åˆ›å»ºè™šæ‹Ÿæœº

äº‘æœåŠ¡å™¨ä¹Ÿéƒ½æ²¡æœ‰ä½¿ç”¨lvm

ç³»ç»Ÿåˆå§‹åŒ–ï¼Œå…³é—­é˜²ç«å¢™ï¼Œç­‰

æˆ‘ä»¬è¿™é‡Œçš„å­¦ä¹ æ¶æ„æ˜¯

```plain
vmware åˆ›å»ºè™šæ‹Ÿæœº > kvm01
```

## å®‰è£…kvmç®¡ç†å·¥å…·

![img](äº‘è®¡ç®—.assets/1610861870909-177c6c42-c6ff-4d61-b987-47c5cb3c72db.png)

ã€€åœ¨ç”µè„‘è¿ç®—ä¸­ï¼Œçº¢å¸½å…¬å¸çš„Virtual Machine Manageræ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºç®¡ç†å‘˜ï¼Œå¯ä»¥è®©ç”¨æˆ·ç®¡ç†å¤šä¸ªè™šæ‹Ÿæœºã€‚

ã€€ã€€åŸºäºå†…æ ¸çš„è™šæ‹Ÿæœºlibvirtä¸Virtual Machine Managerã€‚

**Virtual Machine Managerå¯ä»¥è®©ç”¨æˆ·**ï¼š

ã€€ã€€ğŸƒ åˆ›å»ºã€ç¼–è¾‘ã€å¼•å¯¼æˆ–åœæ­¢è™šæ‹Ÿæœºã€‚

ã€€ã€€ğŸƒ æŸ¥çœ‹å¹¶æ§åˆ¶æ¯ä¸ªè™šæ‹Ÿæœºçš„æ§åˆ¶å°ã€‚

ã€€ã€€ğŸƒ æŸ¥çœ‹æ¯éƒ¨è™šæ‹Ÿæœºçš„æ€§èƒ½ä»¥åŠä½¿ç”¨ç‡ã€‚

ã€€ã€€ğŸƒ æŸ¥çœ‹æ¯éƒ¨æ­£åœ¨è¿è¡Œä¸­çš„è™šæ‹Ÿæœºä»¥åŠä¸»æ§ç«¯çš„å³æ—¶æ€§èƒ½åŠä½¿ç”¨ç‡ä¿¡æ¯ã€‚

ã€€ã€€ğŸƒ ä¸è®ºæ˜¯åœ¨æœ¬æœºæˆ–è¿œç¨‹ï¼Œçš†å¯ä½¿ç”¨KVMã€Xenã€QEMUã€‚

### å…¶ä»–è™šæ‹ŸåŒ–è½¯ä»¶

KVMåªéœ€è¦CPUæ”¯æŒè™šæ‹ŸåŒ–ï¼Œä¸éœ€è¦ä½¿ç”¨ä¸“é—¨çš„ä¿®æ”¹å†…æ ¸ï¼Œå…¼å®¹æ€§å¥½ï¼Œæ€§èƒ½å¥½

**ğŸª Xen**

æ€§èƒ½ç‰¹åˆ«å¥½ï¼Œä½†æ˜¯éœ€è¦ä½¿ç”¨ä¸“é—¨ä¿®æ”¹ä¹‹åçš„å†…æ ¸ï¼Œå…¼å®¹æ€§å·®

ã€€ã€€Xenæ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç è™šæ‹Ÿæœºç›‘è§†å™¨ï¼Œç”±XenProjectå¼€å‘ã€‚å®ƒæ‰“ç®—åœ¨å•ä¸ªè®¡ç®—æœºä¸Šè¿è¡Œå¤šè¾¾128ä¸ªæœ‰å®Œå…¨åŠŸèƒ½çš„æ“ä½œç³»ç»Ÿã€‚

ã€€ã€€åœ¨æ—§ï¼ˆæ— è™šæ‹Ÿç¡¬ä»¶ï¼‰çš„å¤„ç†å™¨ä¸Šæ‰§è¡ŒXenï¼Œæ“ä½œç³»ç»Ÿå¿…é¡»è¿›è¡Œæ˜¾å¼åœ°ä¿®æ”¹ï¼ˆâ€œç§»æ¤â€ï¼‰ä»¥åœ¨Xenä¸Šè¿è¡Œï¼ˆä½†æ˜¯æä¾›å¯¹ç”¨æˆ·åº”ç”¨çš„å…¼å®¹æ€§ï¼‰ã€‚è¿™ä½¿å¾—Xenæ— éœ€ç‰¹æ®Šç¡¬ä»¶æ”¯æŒï¼Œå°±èƒ½è¾¾åˆ°é«˜æ€§èƒ½çš„è™šæ‹ŸåŒ–ã€‚

**ğŸª QEMU**

Qemu è½¯ä»¶çº¯æ¨¡æ‹Ÿå…¨è™šæ‹ŸåŒ–ï¼Œç‰¹åˆ«æ…¢

ã€€ã€€QEMUæ˜¯ä¸€å¥—ç”±Fabrice Bellardæ‰€ç¼–å†™çš„æ¨¡æ‹Ÿå¤„ç†å™¨çš„è‡ªç”±è½¯ä»¶ã€‚å®ƒä¸Bochsï¼ŒPearPCè¿‘ä¼¼ï¼Œä½†å…¶å…·æœ‰æŸäº›åä¸¤è€…æ‰€ä¸å…·å¤‡çš„ç‰¹æ€§ï¼Œå¦‚é«˜é€Ÿåº¦åŠè·¨å¹³å°çš„ç‰¹æ€§ã€‚ç»ç”±KVMï¼ˆæ—©æœŸä¸ºkqemuåŠ é€Ÿå™¨ï¼Œç°åœ¨kqemuå·²è¢«KVMå–ä»£ï¼‰è¿™ä¸ªå¼€æºçš„åŠ é€Ÿå™¨ï¼ŒQEMUèƒ½æ¨¡æ‹Ÿè‡³æ¥è¿‘çœŸå®ç”µè„‘çš„é€Ÿåº¦ã€‚QEMUæœ‰ä¸¤ç§ä¸»è¦è¿ä½œæ¨¡å¼ï¼š

ã€€ã€€**User modeæ¨¡æ‹Ÿæ¨¡å¼**ï¼Œäº¦å³æ˜¯ç”¨æˆ·æ¨¡å¼ã€‚

ã€€ã€€QEMUèƒ½å¼•å¯¼é‚£äº›ä¸ºä¸åŒä¸­å¤®å¤„ç†å™¨ç¼–è¯‘çš„Linuxç¨‹åºã€‚è€ŒWineåŠDosemuæ˜¯å…¶ä¸»è¦ç›®æ ‡ã€‚

ã€€ã€€**System modeæ¨¡æ‹Ÿæ¨¡å¼**ï¼Œäº¦å³æ˜¯ç³»ç»Ÿæ¨¡å¼ã€‚

ã€€ã€€QEMUèƒ½æ¨¡æ‹Ÿæ•´ä¸ªç”µè„‘ç³»ç»Ÿï¼ŒåŒ…æ‹¬ä¸­å¤®å¤„ç†å™¨åŠå…¶ä»–å‘¨è¾¹è®¾å¤‡ã€‚å®ƒä½¿å¾—ä¸ºç³»ç»Ÿæºä»£ç è¿›è¡Œæµ‹è¯•åŠé™¤é”™å·¥ä½œå˜å¾—å®¹æ˜“ã€‚å…¶äº¦èƒ½ç”¨æ¥åœ¨ä¸€éƒ¨ä¸»æœºä¸Šæ¨¡æ‹Ÿæ•°éƒ¨ä¸åŒè™šæ‹Ÿç”µè„‘ã€‚

## å®‰è£…å‘½ä»¤

```plain
# ä¸ºäº†åŠ é€Ÿä¸‹è½½ï¼Œå¯ä»¥æŒ‚è½½æœ¬åœ°å…‰ç›˜é•œåƒï¼Œæ³¨æ„è¦å…ˆè¿æ¥dvd
[root@kvm01 ~]# mount /dev/cdrom /mnt
mount: /dev/sr0 is write-protected, mounting read-only
[root@kvm01 ~]# ls /mnt
CentOS_BuildTag  EULA  images    LiveOS    repodata              RPM-GPG-KEY-CentOS-Testing-7
EFI              GPL   isolinux  Packages  RPM-GPG-KEY-CentOS-7  TRANS.TBL
# ç¼–å†™ä¸€ä¸ªæœ¬åœ°é•œåƒä»“åº“repoæ–‡ä»¶
[root@kvm01 yum.repos.d]# ls
bak  local.repo
[root@kvm01 yum.repos.d]# cat local.repo
[local]
name=local repo
baseurl=file:///mnt
gpgcheck=0
# ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–å®‰è£…ï¼Œå®‰è£…é€Ÿåº¦ï¼Œéä¸€èˆ¬çš„æ„Ÿè§‰
yum install gcc gcc-c++ autoconf automake make zlib zlib-devel openssl openssl-devel pcre pcre-devel wget http-tools vim net-tools -y
# å®‰è£…kvmå·¥å…·
yum install libvirt virt-install qemu-kvm -y 
libvirt ç®¡ç†kvmè™šæ‹Ÿæœºçš„ç”Ÿå‘½å‘¨æœŸ
virt-install  åˆ›å»ºè™šæ‹Ÿæœº
qemu-kvm ä½¿ç”¨qemu-imgä¸ºè™šæ‹Ÿæœºæä¾›ç¡¬ç›˜çš„å·¥å…·
```

## å®‰è£…kvmè™šæ‹Ÿæœºçš„å‡†å¤‡

éœ€è¦å®‰è£…VNCå·¥å…·

ä¸‹è½½vncè½¯ä»¶æ–¹æ³•ï¼Œtightvncå®˜ç½‘ï¼š[http://www.tightvnc.com](http://www.tightvnc.com/)

ã€€ã€€VNCè½¯ä»¶ï¼Œç”¨äºVNCï¼ˆVirtual Network Computingï¼‰ï¼Œä¸ºä¸€ç§ä½¿ç”¨RFBåè®®çš„æ˜¾ç¤ºå±ç”»é¢åˆ†äº«åŠè¿œç¨‹æ“ä½œè½¯ä»¶ã€‚æ­¤è½¯ä»¶å€Ÿç”±ç½‘ç»œï¼Œå¯å‘é€é”®ç›˜ä¸é¼ æ ‡çš„åŠ¨ä½œåŠå³æ—¶çš„æ˜¾ç¤ºå±ç”»é¢ã€‚

ã€€ã€€VNCä¸æ“ä½œç³»ç»Ÿæ— å…³ï¼Œå› æ­¤å¯è·¨å¹³å°ä½¿ç”¨ï¼Œä¾‹å¦‚å¯ç”¨Windowsè¿æ¥åˆ°æŸLinuxçš„ç”µè„‘ï¼Œåä¹‹äº¦åŒã€‚ç”šè‡³åœ¨æ²¡æœ‰å®‰è£…å®¢æˆ·ç«¯ç¨‹åºçš„ç”µè„‘ä¸­ï¼Œåªè¦æœ‰æ”¯æŒJAVAçš„æµè§ˆå™¨ï¼Œä¹Ÿå¯ä½¿ç”¨ã€‚

ã€€ã€€å®‰è£…VNCæ—¶ï¼Œä½¿ç”¨é»˜è®¤å®‰è£…å³å¯ï¼Œæ— éœ€å®‰è£…serverç«¯ã€‚

```plain
# å¯åŠ¨libvirtd
[root@kvm01 ~]# systemctl start libvirtd.service
# å¯åŠ¨æ—¥å¿—
[root@kvm01 yum.repos.d]# systemctl status libvirtd.service
â— libvirtd.service - Virtualization daemon
   Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled; vendor preset: enabled)
   Active: active (running) since Tue 2020-09-01 23:04:58 CST; 25s ago
     Docs: man:libvirtd(8)
           https://libvirt.org
 Main PID: 2254 (libvirtd)
    Tasks: 19 (limit: 32768)
   CGroup: /system.slice/libvirtd.service
           â”œâ”€2254 /usr/sbin/libvirtd
           â”œâ”€2398 /usr/sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/default.conf --leasef...
           â””â”€2400 /usr/sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/default.conf --leasef...
Sep 01 23:04:58 kvm01 systemd[1]: Started Virtualization daemon.
Sep 01 23:04:59 kvm01 dnsmasq[2398]: started, version 2.76 cachesize 150
Sep 01 23:04:59 kvm01 dnsmasq[2398]: compile time options: IPv6 GNU-getopt DBus no-i18n IDN...ify
Sep 01 23:04:59 kvm01 dnsmasq-dhcp[2398]: DHCP, IP range 192.168.122.2 -- 192.168.122.254, ... 1h
Sep 01 23:04:59 kvm01 dnsmasq-dhcp[2398]: DHCP, sockets bound exclusively to interface virbr0
Sep 01 23:04:59 kvm01 dnsmasq[2398]: reading /etc/resolv.conf
Sep 01 23:04:59 kvm01 dnsmasq[2398]: using nameserver 1.2.4.8#53
Sep 01 23:04:59 kvm01 dnsmasq[2398]: read /etc/hosts - 2 addresses
Sep 01 23:04:59 kvm01 dnsmasq[2398]: read /var/lib/libvirt/dnsmasq/default.addnhosts - 0 ad...ses
Sep 01 23:04:59 kvm01 dnsmasq-dhcp[2398]: read /var/lib/libvirt/dnsmasq/default.hostsfile
Hint: Some lines were ellipsized, use -l to show in full.
# libvirtå¯åŠ¨è¿˜å¸¦ç€dhcpæœåŠ¡ï¼Œç”¨äºç»™kvmè™šæ‹Ÿæœºåˆ†é…ip
```

å®‰è£…å®Œæ¯•vncå®¢æˆ·ç«¯å³å¯

## åˆ›å»ºç¬¬ä¸€ä¸ªKVMè™šæ‹Ÿæœº

åˆ›å»ºå‘½ä»¤

æ³¨æ„ï¼Œè¦å…ˆå§é•œåƒæ–‡ä»¶ï¼Œæ‹·è´åˆ°`/data/CentOS-7-x86_64-DVD-1804.iso`

é•œåƒå¯ä»¥æ‰¾è¶…å“¥è¦

ä¸Šä¼ é•œåƒ

```plain
# å®¢æˆ·ç«¯æœ¬åœ°ä¸Šä¼ ,windowså¯ä»¥ä½¿ç”¨xftpä¸Šä¼ ï¼Œä¸è¦ä½¿ç”¨lrzszä¼šæŠ¥é”™
[yuchao@yumac è½¯ä»¶åŒ…]$scp CentOS-7-x86_64-DVD-1804.iso root@10.0.1.50:/data/
root@10.0.1.50's password:
CentOS-7-x86_64-DVD-1804.iso                                                    100% 4263MB  61.5MB/s   01:09
[yuchao@yumac è½¯ä»¶åŒ…]$
# linuxæœåŠ¡ç«¯æ£€æŸ¥
[root@kvm01 data]# ll -h
total 4.2G
-rwxr-xr-x 1 root root 4.2G Sep  1 23:18 CentOS-7-x86_64-DVD-1804.iso
```

å‚æ•°è§£é‡Š

| **å‚æ•°**                                    | **å‚æ•°è¯´æ˜**                                                 |
| ------------------------------------------- | ------------------------------------------------------------ |
| **--virt-type HV_TYPE**                     | è¦ä½¿ç”¨çš„ç®¡ç†ç¨‹åºåç§° (kvm, qemu, xen, ...)                   |
| **--os-type**                               | ç³»ç»Ÿç±»å‹                                                     |
| **--os-variant DISTRO_VARIANT**             | åœ¨å®¢æˆ·æœºä¸Šå®‰è£…çš„æ“ä½œç³»ç»Ÿï¼Œä¾‹å¦‚ï¼š'fedora18'ã€'rhel6'ã€'winxp' ç­‰ã€‚ |
| **-n NAME, --name NAME**                    | å®¢æˆ·æœºå®ä¾‹åç§°                                               |
| **--memory MEMORY**                         | é…ç½®å®¢æˆ·æœºè™šæ‹Ÿå†…å­˜å¤§å°                                       |
| **--vcpus VCPUS**                           | é…ç½®å®¢æˆ·æœºè™šæ‹Ÿ CPU(vcpu) æ•°é‡ã€‚                              |
| **--disk DISK**                             | æŒ‡å®šå­˜å‚¨çš„å„ç§é€‰é¡¹ã€‚                                         |
| **-cdrom CDROM**                            | å…‰é©±å®‰è£…ä»‹è´¨                                                 |
| **-w NETWORK, --network NETWORK**           | é…ç½®å®¢æˆ·æœºç½‘ç»œæ¥å£ã€‚                                         |
| **--graphics GRAPHICS**                     | é…ç½®å®¢æˆ·æœºæ˜¾ç¤ºè®¾ç½®ï¼Œlinuxé»˜è®¤é»‘å±ï¼ŒæŒ‡å®šç”¨vncè¾“å‡ºå›¾å½¢åŒ–       |
| **è™šæ‹ŸåŒ–å¹³å°é€‰é¡¹:**                         |                                                              |
| **-v, --hvm**                               | è¿™ä¸ªå®¢æˆ·æœºåº”è¯¥æ˜¯ä¸€ä¸ªå…¨è™šæ‹ŸåŒ–å®¢æˆ·æœº                           |
| **-p, --paravirt**                          | è¿™ä¸ªå®¢æˆ·æœºåº”è¯¥æ˜¯ä¸€ä¸ªåŠè™šæ‹ŸåŒ–å®¢æˆ·æœº                           |
| **--container**                             | è¿™ä¸ªå®¢æˆ·æœºåº”è¯¥æ˜¯ä¸€ä¸ªå®¹å™¨å®¢æˆ·æœº                               |
| **--virt-type HV_TYPE**                     | è¦ä½¿ç”¨çš„ç®¡ç†ç¨‹åºåç§° (kvm, qemu, xen, ...)                   |
| **--arch ARCH**                             | æ¨¡æ‹Ÿ CPU æ¶æ„                                                |
| **--machine MACHINE**                       | æœºå™¨ç±»å‹ä¸ºä»¿çœŸç±»å‹                                           |
| **å…¶å®ƒé€‰é¡¹:**                               |                                                              |
| **--noautoconsole**                         | ä¸è¦è‡ªåŠ¨å°è¯•è¿æ¥åˆ°å®¢æˆ·ç«¯æ§åˆ¶å°                               |
| **--autostart**                             | ä¸»æœºå¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨åŸŸã€‚                                       |
| **--noreboot**                              | å®‰è£…å®Œæˆåä¸å¯åŠ¨å®¢æˆ·æœºã€‚                                     |
| ä»¥ä¸Šä¿¡æ¯é€šè¿‡ " virt-install --help " è·å¾—ã€‚ |                                                              |

åˆ›å»ºè™šæ‹Ÿæœºå‘½ä»¤

```plain
# å‘½ä»¤å¦‚ä¸‹ï¼Œè¿™ä¸€ç³»åˆ—å‘½ä»¤ï¼Œå°±å¦‚åŒvmwareåˆ›å»ºè™šæ‹Ÿæœºæ—¶å€™çš„ä¸‹ä¸€æ­¥ï¼Œä¸‹ä¸€æ­¥é€‰é¡¹
virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name centos7 --memory 1024 --vcpus 1 --disk /data/centos2.raw,format=raw,size=10 --cdrom /data/CentOS-7-x86_64-DVD-1804.iso --network network=default --graphics vnc,listen=0.0.0.0,port=5900 --noautoconsole
```

å¦‚æœå‚æ•°å†™é”™äº†ï¼Œæˆ–è€…cpuæœªå¼€å¯è™šæ‹ŸåŒ–æ”¯æŒï¼Œéƒ½ä¼šæŠ¥é”™

æ­£ç¡®ç»“æœå¦‚ä¸‹

```plain
[root@kvm01 data]# virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name centos7 --memory 1024 --vcpus 1 --disk /data/centos2.raw,format=raw,size=10 --cdrom /data/CentOS-7-x86_64-DVD-1804.iso --network network=default --graphics vnc,listen=0.0.0.0,port=5900 --noautoconsole
Starting install...
Allocating 'centos2.raw'                                                  |  10 GB  00:00:00
Domain installation still in progress. You can reconnect to
the console to complete the installation process.
```

æ³¨æ„ï¼Œå¼€å¯åï¼Œæœ‰60sçš„æ—¶é—´ï¼ŒæŠ“ç´§æ‰“å¼€vpnè¿›è¡Œè¿æ¥ï¼Œå› ä¸ºè¦è¿›è¡Œç³»ç»Ÿå®‰è£…

![img](äº‘è®¡ç®—.assets/1610861870924-56d93eca-0ef7-4b97-85c9-f8c074987deb.png)

è¿æ¥vpnåï¼Œçœ‹åˆ°æ­£ç¡®çš„ç³»ç»Ÿå®‰è£…é¡µé¢

![img](äº‘è®¡ç®—.assets/1610861870925-2ea724a4-9838-44cf-94e2-7d2ea68c62ea.png)

è£…ç³»ç»Ÿå’Œä»¥å‰æ²¡æœ‰åŒºåˆ«ï¼ŒåŒºåˆ«åœ¨äºåˆ†åŒºçš„æ—¶å€™ï¼Œkvmçš„è™šæ‹Ÿæœºä¸éœ€è¦swapåˆ†åŒºï¼Œç›´æ¥æ‰€æœ‰çš„å®¹é‡éƒ½ç»™æ ¹ç›®å½•å³å¯ã€‚

![img](äº‘è®¡ç®—.assets/1610861870923-fc0abcfa-fc6b-4126-8813-452dc0d4ddf4.png)

æœ€ç»ˆè™šæ‹Ÿæœºå®‰è£…ç•Œé¢

![img](äº‘è®¡ç®—.assets/1610861870933-580e4e1f-1cf8-4f64-a44d-b2b553bfca6f.png)

ç­‰å¾…å®‰è£…å®Œæ¯•ï¼Œå®‰è£…å®Œæ¯•åï¼Œä¼šè‡ªåŠ¨é‡å¯ï¼Œé‡æ–°å¼€æœºå³å¯vncè¿œç¨‹è¿æ¥ä½¿ç”¨

```plain
[root@kvm01 data]# virsh  start centos7
Domain centos7 started
[root@kvm01 data]# virsh vncdisplay centos7
:0
# ç«¯å£é»˜è®¤ä»5900å¼€å§‹ï¼Œä»¥æ­¤ç±»æ¨ 5901
```

è£…å¥½çš„kvmè™šæ‹Ÿæœºï¼Œvncè¿œç¨‹è¿æ¥ï¼Œä½ ç”¨æˆ–è€…ä¸ç”¨ï¼Œå®ƒä¸å…³æœºéƒ½åœ¨å“ªé‡Œã€‚ã€‚

![img](äº‘è®¡ç®—.assets/1610861870935-107bbde7-a9fc-44b1-a62f-d6088d223a4a.png)

# kvmè™šæ‹Ÿæœºç®¡ç†

virshå‘½ä»¤å¸¸ç”¨å‚æ•°æ€»ç»“

| **å‚æ•°**                            | **å‚æ•°è¯´æ˜**                                 |
| ----------------------------------- | -------------------------------------------- |
| **åŸºç¡€æ“ä½œ**                        |                                              |
| **list**                            | æŸ¥çœ‹è™šæ‹Ÿæœºåˆ—è¡¨ï¼Œåˆ—å‡ºåŸŸ                       |
| **start**                           | å¯åŠ¨è™šæ‹Ÿæœºï¼Œå¼€å§‹ä¸€ä¸ªï¼ˆä»¥å‰å®šä¹‰çš„ï¼‰éæ´»è·ƒçš„åŸŸ |
| **shutdown**                        | å…³é—­è™šæ‹Ÿæœºï¼Œå…³é—­ä¸€ä¸ªåŸŸ                       |
| **destroy(\****å±é™©)**              | å¼ºåˆ¶å…³é—­è™šæ‹Ÿæœºï¼Œé”€æ¯ï¼ˆåœæ­¢ï¼‰åŸŸ               |
| **vncdisplay**                      | æŸ¥è¯¢è™šæ‹Ÿæœºvncç«¯å£å·                          |
| **é…ç½®ç®¡ç†æ“ä½œ**                    |                                              |
| **dumpxml**                         | å¯¼å‡ºä¸»æœºé…ç½®ä¿¡æ¯                             |
| **undefine**                        | åˆ é™¤ä¸»æœº                                     |
| **define**                          | å¯¼å…¥ä¸»æœºé…ç½®                                 |
| **domrename**                       | å¯¹è™šæ‹Ÿæœºè¿›è¡Œé‡å‘½å                           |
| **æŒ‚èµ·ä¸æ¢å¤**                      |                                              |
| **suspend**                         | æŒ‚èµ·è™šæ‹Ÿæœº                                   |
| **resume**                          | æ¢å¤è™šæ‹Ÿæœº                                   |
| **è‡ªå¯åŠ¨ç®¡ç†**                      |                                              |
| **autostart**                       | è™šæ‹Ÿæœºå¼€æœºå¯åŠ¨                               |
| **autostart --disable**             | å–æ¶ˆè™šæ‹Ÿæœºå¼€æœºå¯åŠ¨                           |
| **ä»¥ä¸Šå‚æ•°é€šè¿‡virsh --help** è·å¾—ã€‚ |                                              |

## kvmè™šæ‹Ÿæœºæ“ä½œè¿‡ç¨‹

kvmè™šæ‹Ÿæœºé…ç½®æ–‡ä»¶ä½ç½®

```plain
[root@kvm01 data]# ll /etc/libvirt/qemu/centos7.xml
-rw------- 1 root root 3907 Sep  1 23:36 /etc/libvirt/qemu/centos7.xml
```

ä¿®æ”¹è™šæ‹Ÿæœºé…ç½®å‘½ä»¤

```plain
[root@kvm01 data]# virsh edit centos7
Domain centos7 XML configuration not changed.
```

**ä½¿ç”¨è¯¥å‘½ä»¤å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œè¯­æ³•æ ¡éªŒï¼Œæ”¹é”™äº†ä¼šè‡ªåŠ¨æç¤º**

### å¤‡ä»½ä¸æ¢å¤è™šæ‹Ÿæœº

```plain
1.å¤‡ä»½è™šæ‹Ÿæœºé…ç½®ï¼Œæ³¨æ„å…³æœºæ—¶å¤‡ä»½
[root@kvm01 data]# virsh dumpxml centos7 > bak_centos7.xml
2.åˆ—å‡ºæ‰€æœ‰è™šæ‹ŸæœºçŠ¶æ€
[root@kvm01 data]# virsh list --all
 Id    Name                           State
----------------------------------------------------
 -     centos7                        shut off
3.åˆ é™¤è™šæ‹Ÿæœºé…ç½®ï¼Œæ³¨æ„åˆ é™¤å‘½ä»¤ï¼Œåšå¥½å¤‡ä»½åå†æ‰§è¡Œ
[root@kvm01 data]# virsh undefine centos7
Domain centos7 has been undefined # centos7å·²ç»è¢«å–æ¶ˆå®šä¹‰
4.å¯¼å…¥è™šæ‹Ÿæœºï¼Œä»xmlé…ç½®æ–‡ä»¶ï¼Œå†æ¬¡å¯¼å…¥
[root@kvm01 data]# virsh define bak_centos7.xml
Domain centos7 defined from bak_centos7.xml
å†æ¬¡æŸ¥çœ‹
[root@kvm01 data]# virsh list --all
 Id    Name                           State
----------------------------------------------------
 -     centos7                        shut off
 5.ç»™è™šæ‹Ÿæœºé‡å‘½å
 [root@kvm01 data]# virsh domrename centos7 cckvm7
Domain successfully renamed
[root@kvm01 data]# virsh list --all
 Id    Name                           State
----------------------------------------------------
 -     cckvm7                         shut off
 6.è™šæ‹Ÿæœºçš„å¼€æœºå’Œå…³æœº
 [root@kvm01 data]# virsh start cckvm7
Domain cckvm7 started
[root@kvm01 data]# virsh list
 Id    Name                           State
----------------------------------------------------
 3     cckvm7                         running
 å¼€æœºåå¯ä»¥è¿œç¨‹vpnè¿æ¥
# å…³æœº
[root@kvm01 data]# virsh shutdown cckmv7
# å±é™©å‘½ä»¤ï¼Œå¼ºåˆ¶å…³é—­è™šæ‹Ÿæœºä¸”æ‘§æ¯ï¼Œç›´æ¥æ‹”ç”µæº
[root@kvm01 data]# virsh destroy cckvm7
Domain cckvm7 destroyed
# è‹¥æ˜¯è¯¥è™šæ‹Ÿæœºä¸åœ¨ä½¿ç”¨äº†ï¼Œå¯ä»¥åˆ é™¤ï¼Œè½»æ˜“åˆ«åˆ é™¤ï¼Œå¦åˆ™è¿˜å¾—åœ¨å®‰è£…
[root@kvm01 data]# virsh undefine cckvm7
Domain cckvm7 has been undefined
7.è™šæ‹Ÿæœºçš„æŒ‚èµ·å’Œæ¢å¤
[root@kvm01 data]# virsh suspend centos7
Domain centos7 suspended
[root@kvm01 data]# virsh list  
 Id    Name                           State
----------------------------------------------------
 6     centos7                        paused        # æ­¤æ—¶æ˜¯æš‚åœçš„çŠ¶æ€äº†
# é‡æ–°æ¢å¤è™šæ‹Ÿæœº
[root@kvm01 data]# virsh resume centos7
Domain centos7 resumed
[root@kvm01 data]# virsh list
 Id    Name                           State
----------------------------------------------------
 6     centos7                        running
 8.æŸ¥è¯¢è™šæ‹Ÿæœºç«¯å£
 [root@kvm01 data]# virsh vncdisplay centos7
:0
# :0 å³ ä¸º 5900 ç«¯å£ï¼Œä»¥æ­¤ç±»æ¨ :1ä¸º5901 ã€‚
[root@kvm01 data]# netstat -tunlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:5900            0.0.0.0:*               LISTEN      3205/qemu-kvm
9.è®¾ç½®kvmå¼€æœºè‡ªå¯
[root@kvm01 data]# systemctl enable libvirtd
[root@kvm01 data]# systemctl is-enabled libvirtd
enabled
10.è®¾ç½®è™šæ‹Ÿæœºå¼€æœºè‡ªå¯
[root@kvm01 data]# virsh autostart centos7
Domain centos7 marked as autostarted
# å…¶å®è¿™æ¡å‘½ä»¤æ˜¯è®¾ç½®äº†è½¯è¿æ¥
[root@kvm01 data]# ll /etc/libvirt/qemu/autostart/centos7.xml
lrwxrwxrwx 1 root root 29 Sep  2 00:40 /etc/libvirt/qemu/autostart/centos7.xml -> /etc/libvirt/qemu/centos7.xml
# å–æ¶ˆå¼€æœºè‡ªå¯ï¼Œè½¯è¿æ¥ä¹Ÿå°±åˆ é™¤äº†
[root@kvm01 data]# virsh  autostart --disable centos7
Domain centos7 unmarked as autostarted
```

# kvmè™šæ‹Ÿæœºconsoleç™»å½•

1ï¼šå¸¸è§„æƒ…å†µä¸‹ï¼Œå®‰è£…å®Œ KVM ä¹‹åï¼Œå¯èƒ½éƒ½ä¼šé€šè¿‡ VNC è¿æ¥åˆ° KVM è™šæ‹Ÿæœºé‡Œé¢å»ä¿®æ”¹ IP ç­‰ä¿¡æ¯ã€‚ä½†æ˜¯ä¸€æ—¦è™šæ‹Ÿæœºæ¯”è¾ƒå¤šçš„è¯ï¼Œæ‰“å¼€è¿‡å¤šçš„ç«¯å£ä¼šé€ æˆå®‰å…¨é—®é¢˜

2ï¼šå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡è·³æ¿æœºè¿æ¥çš„å®¿ä¸»æœºï¼Œä½ çš„windowå’Œkvmå®¿ä¸»æœºæ²¡æœ‰ç›´è¾¾çš„è·¯ç”±ï¼Œè¿™æ—¶å€™vncéƒ½ç”¨ä¸äº†ï¼Œå¦‚ä½•å¿«é€Ÿè¿›å…¥åˆ° KVM è™šæ‹Ÿæœºé‡Œé¢å»æ’æŸ¥é—®é¢˜å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼Œå¯ä»¥ä½¿ç”¨consoleåŠŸèƒ½ç™»å½•kvmè™šæ‹Ÿæœºã€‚

## terminalå’Œconsoleçš„åŒºåˆ«

terminalæ˜¯æ”¯æŒå½©è‰²æ˜¾ç¤ºï¼Œå°†ä¸»æœºçš„ç¨‹åºè¾“å‡ºåœ¨å±å¹•ä¸Šçš„ä¸€ä¸ªè®¾å¤‡ã€‚

ä½†æ˜¯åœ¨ç³»ç»Ÿæ­£ç¡®å¯åŠ¨ä¹‹å‰ï¼Œterminalæ˜¯æ— æ³•è¿æ¥åˆ°ä¸»æœºçš„ï¼Œä¸ºäº†è®°å½•å‡ºä¸»æœºå¼€æœºè¿‡ç¨‹æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•ç»´æŠ¤ï¼Œä¹Ÿå°±å¤šäº†ä¸€ä¸ªæ§åˆ¶å°çš„åŠŸèƒ½ï¼Œä¸€å°è®¡ç®—æœºåªæœ‰ä¸€ä¸ªæ§åˆ¶å°ï¼Œä¹Ÿå°±æ˜¯consoleåŠŸèƒ½äº†ã€‚

é»˜è®¤consoleåŠŸèƒ½æ˜¯æ— æ³•ä½¿ç”¨çš„ï¼Œéœ€è¦ä¿®æ”¹æœåŠ¡å™¨é…ç½®ã€‚

## centos7é…ç½®consoleç™»å½•

```plain
1.è¿›å…¥kvmè™šæ‹Ÿæœºå†…ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå…ˆç™»å½•kvmè™šæ‹Ÿæœº
[root@kvm01 data]# ssh root@192.168.122.60
The authenticity of host '192.168.122.60 (192.168.122.60)' can't be established.
ECDSA key fingerprint is SHA256:2/5RZL0Kwpq8TyHmT2mxOoA8tiMEZSoeSn7ZZGv797Y.
ECDSA key fingerprint is MD5:0c:77:0c:b8:cf:a4:b6:ad:bc:4e:63:e4:cf:68:0f:50.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.122.60' (ECDSA) to the list of known hosts.
root@192.168.122.60's password:
Last login: Wed Sep  2 00:25:39 2020
[root@localhost ~]#
2.ç™»å½•è¿›æ¥åï¼Œæ‰§è¡Œå‘½ä»¤
[root@localhost ~]# grubby --update-kernel=ALL --args="console=ttyS0,115200n8"
[root@localhost ~]# reboot
Connection to 192.168.122.60 closed by remote host.
Connection to 192.168.122.60 closed.
```

è¿›å…¥kvmçš„consoleç•Œé¢

```plain
[root@kvm01 data]# virsh console centos7
```

è‹¥æ˜¯æƒ³è¦é€€å‡ºconsoleï¼Œéœ€è¦æ‰§è¡Œç»„åˆé”®`ctrl + ]`



# kvmç£ç›˜&å¿«ç…§&å…‹éš†

# KVMè™šæ‹Ÿæœºç£ç›˜æ ¼å¼è½¬æ¢

åˆšæ‰æˆ‘ä»¬å‘ç°ï¼Œkvmåˆ›å»ºçš„è™šæ‹Ÿæœºæ–‡ä»¶ï¼Œå¦‚ä¸‹æ ¼å¼

```plain
[root@kvm01 data]# ls
centos2.raw  CentOS-7-x86_64-DVD-1804.iso
```

è¿™ä¸ªrawå°±æ˜¯æˆ‘ä»¬çš„è™šæ‹Ÿæœºæ–‡ä»¶

æœ‰å…³è™šæ‹Ÿæœºæ–‡ä»¶çš„å…¶ä»–æ ¼å¼è¿˜æœ‰

## raw

å®˜æ–¹è§£é‡Šï¼šï¼ˆé»˜è®¤ï¼‰åŸå§‹æ ¼å¼æ˜¯å…‰ç›˜æ˜ åƒçš„çº¯äºŒè¿›åˆ¶æ˜ åƒï¼Œå¹¶ä¸”éå¸¸ä¾¿äºç§»æ¤ã€‚ åœ¨æ”¯æŒç¨€ç–æ–‡ä»¶çš„æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œè¿™ç§æ ¼å¼çš„å›¾åƒä»…ä½¿ç”¨è®°å½•åœ¨å…¶ä¸­çš„æ•°æ®å®é™…ä½¿ç”¨çš„ç©ºé—´ã€‚

rawæ ¼å¼çš„é•œåƒæ–‡ä»¶ï¼Œç‰¹ç‚¹å°±æ˜¯èµ¤è£¸è£¸ï¼Œå ç”¨ç©ºé—´è¾ƒå¤§ï¼Œä¸é€‚åˆè¿œç¨‹ä¼ è¾“ï¼Œä¸æ”¯æŒå¿«ç…§snapshotåŠŸèƒ½ï¼Œä½†æ˜¯æ€§èƒ½è¾ƒå¥½ã€‚

KVMå’ŒXENé»˜è®¤çš„é•œåƒæ ¼å¼å°±æ˜¯rawï¼Œå¥½å¤„åœ¨äºä¾‹å¦‚éœ€è¦è½¬æ¢ä¸ºå…¶ä»–æ ¼å¼çš„è™šæ‹Ÿæœºé•œåƒæ˜¯å¾ˆç®€å•çš„ã€‚

ä»ç©ºé—´ä½¿ç”¨ä¸Šæ¥çœ‹ï¼Œrawé•œåƒå¾ˆåƒç£ç›˜ï¼Œä½¿ç”¨å¤šå°‘å³æ˜¯å¤šå°‘ï¼Œä¾‹å¦‚

```plain
[root@kvm01 data]# du -h centos2.raw
1.8G    centos2.raw
```

ä½†æ˜¯å¦‚æœè¦æŠŠæ•´å—ç£ç›˜éƒ½æ‹¿èµ°çš„è¯ï¼Œå°±å¾—å…¨ç›˜æ“ä½œï¼Œä¾‹å¦‚copyé•œåƒï¼Œå°±æ˜¯æ‹·è´10Gå¤§å°ï¼Œéå¸¸æ¶ˆè€—ç½‘ç»œå®½å¸¦å’ŒI/Oã€‚

è¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯ï¼Œå¦‚æœrawæ ¼å¼çš„è™šæ‹Ÿæœºç£ç›˜ä¸å¤Ÿç”¨äº†ï¼Œå¯ä»¥åœ¨åŸæœ‰ç£ç›˜ä¸Šç›´æ¥è¿½åŠ ç©ºé—´ï¼Œæ¯”è¾ƒçŠ€åˆ©ã€‚

## cow

å®˜æ–¹è§£é‡Šï¼šå†™å…¥æ—¶å¤åˆ¶æ ¼å¼ï¼Œä»…å‡ºäºå†å²åŸå› å—æ”¯æŒï¼Œå¹¶ä¸”ä¸é€‚ç”¨äºWindowsä¸Šçš„QEMU

è¯¥æ ¼å¼è¢«é—å¼ƒï¼Œåæ¥è¢«qcowæ ¼å¼å–ä»£ã€‚

## qcow

copy on writeï¼Œå†™å…¥æ—¶å¤åˆ¶ï¼Œå ç”¨ç©ºé—´å°ï¼Œé€‚åˆä¼ è¾“ï¼Œæ”¯æŒå¿«ç…§ï¼Œä½†æ˜¯æ€§èƒ½æ¯”rawå·®ä¸€ç‚¹ã€‚

## qcow2

ç›®å‰æ¯”è¾ƒä¸»æµçš„è™šæ‹ŸåŒ–é•œåƒæ ¼å¼ï¼Œæ€§èƒ½æ¥è¿‘rawçš„è£¸æ ¼å¼ï¼Œæœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š

- æ›´å°çš„å­˜å‚¨ç©ºé—´
- æ”¯æŒsnapshotï¼Œå¿«ç…§ï¼Œä¸”å¯ä»¥ç®¡ç†å†å²å¿«ç…§
- æ”¯æŒzlibç£ç›˜å‹ç¼©
- æ”¯æŒAESåŠ å¯†

## vmdk

è¿™æ˜¯vmwareåˆ›å»ºçš„è™šæ‹Ÿæœºé•œåƒæ–‡ä»¶æ ¼å¼ï¼Œæˆ‘ä»¬å¯ä»¥ç‚¹å¼€è‡ªå·±çš„è™šæ‹Ÿæœºç›®å½•çœ‹ä¸€ä¸‹å³å¯ã€‚

vmdkæ ¼å¼æ— è®ºæ˜¯ä»æ€§èƒ½ï¼Œè¿˜æ˜¯åŠŸèƒ½ï¼Œå¿«ç…§ç­‰ï¼Œéƒ½æ˜¯éå¸¸å‡ºè‰²çš„ã€‚

## ç»ƒä¹ ç®¡ç†ç£ç›˜æ˜ åƒæ–‡ä»¶

```plain
# åˆ›å»ºqcow2æ ¼å¼ç£ç›˜æ–‡ä»¶  -f æŒ‡å®šé•œåƒæ ¼å¼  æŒ‡å®šç£ç›˜å¤§å°æ˜¯2G
[root@kvm01 data]# qemu-img create -f qcow2 chaoge.qcow2 2G
Formatting 'chaoge.qcow2', fmt=qcow2 size=2147483648 encryption=off cluster_size=65536 lazy_refcounts=off
# æŸ¥çœ‹å½“å‰è™šæ‹Ÿæœºä¿¡æ¯
[root@kvm01 data]# qemu-img info centos2.raw
image: centos2.raw
file format: raw
virtual size: 10G (10737418240 bytes)
disk size: 1.7G
# æŸ¥çœ‹æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„qcow2ç£ç›˜æ–‡ä»¶ä¿¡æ¯
[root@kvm01 data]# qemu-img info chaoge.qcow2
image: chaoge.qcow2
file format: qcow2
virtual size: 2.0G (2147483648 bytes)
disk size: 196K
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
# è°ƒæ•´ç£ç›˜æ˜ åƒæ–‡ä»¶å¤§å°
[root@kvm01 data]# qemu-img resize chaoge.qcow2 +5G
Image resized.
# ç£ç›˜æ˜ åƒæ ¼å¼è½¬æ¢
-f æŒ‡å®šæºæ ¼å¼  -O æŒ‡å®šè¾“å‡ºæ ¼å¼ 
[root@kvm01 data]# qemu-img convert -f qcow2 -O raw chaoge.qcow2 chaoge.raw
```

## è½¬æ¢ç°æœ‰è™šæ‹Ÿæœºç£ç›˜æ ¼å¼

```plain
# ç°æœ‰è™šæ‹Ÿæœºç£ç›˜æ–‡ä»¶
[root@kvm01 data]# ll
total 6175880
-rw------- 1 qemu qemu 10737418240 Sep  2 15:30 centos2.raw
-rwxr-xr-x 1 qemu qemu  4470079488 Sep  1 23:18 CentOS-7-x86_64-DVD-1804.iso
-rw-r--r-- 1 root root      262656 Sep  2 15:19 chaoge.qcow2
-rw-r--r-- 1 root root  7516192768 Sep  2 15:32 chaoge.raw
# å…³é—­è™šæ‹Ÿæœº
[root@kvm01 data]# virsh shutdown centos7
Domain centos7 is being shutdown
# æŸ¥çœ‹è™šæ‹Ÿæœºé…ç½®ä¿¡æ¯ï¼Œç”¨çš„ç£ç›˜æ–‡ä»¶æ˜¯é‚£ä¸ªä¸€ä¸ª
[root@kvm01 data]# virsh edit centos7
Domain centos7 XML configuration not changed.
æ‰¾åˆ°é…ç½®  <source file='/data/centos2.raw'/>
# è½¬æ¢ç£ç›˜æ ¼å¼
# æ³¨æ„åŒºåˆ«ï¼Œæºæ ¼å¼æ˜¯rawï¼Œçœ‹ä¸‹å®¹é‡æ˜¯
[root@kvm01 data]# ll |grep centos2
total 6175880
-rw------- 1 root root 10737418240 Sep  2 15:40 centos2.raw
# è½¬æ¢æ ¼å¼å‘½ä»¤
[root@kvm01 data]# qemu-img convert -f raw -O qcow2 centos2.raw centos7.qcow2
# è½¬æ¢åçš„å®¹é‡
[root@kvm01 data]# ll -h|grep centos7
-rw-r--r-- 1 root root 1.8G Sep  2 15:43 centos7.qcow2
# è½¬æ¢åå¾—ä¿®æ”¹è™šæ‹Ÿæœºé…ç½®æ–‡ä»¶ï¼Œè®©å…¶è¯»å–æ–°çš„ç£ç›˜æ˜ åƒæ–‡ä»¶
[root@kvm01 data]# virsh edit centos7
Domain centos7 XML configuration edited.
éœ€è¦ä¿®æ”¹çš„å‚æ•°
      <driver name='qemu' type='qcow2'/>
      <source file='/data/centos7.qcow2'/>
# å¯ä»¥åˆ é™¤æ—§çš„rawç£ç›˜æ–‡ä»¶ï¼ŒæŸ¥çœ‹æ˜¯å¦ä¼šè¯»å–æ–°çš„qcow2æ ¼å¼ç£ç›˜ï¼Œæ­£ç¡®å¯åŠ¨è™šæ‹Ÿæœº
[root@kvm01 data]# rm -rf centos2.raw
[root@kvm01 data]# virsh start centos7
Domain centos7 started
# æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ç”¨vncæˆ–è€…sshæˆ–è€…consoleç™»å½•kvmè™šæ‹Ÿæœºéƒ½å¯ä»¥ï¼Œç„¶åå†™å…¥æ–‡ä»¶ï¼ŒæŸ¥çœ‹ç£ç›˜é•œåƒå¤§å°
[root@kvm01 data]# ssh root@192.168.122.60
root@192.168.122.60's password:
Last login: Wed Sep  2 15:47:03 2020 from gateway
[root@localhost ~]# dd if=/dev/zero of=/tmp/test.raw bs=500M count=1
# åˆ·æ–°ç£ç›˜å®¹é‡
[root@localhost ~]# sync
# é€€å‡ºè™šæ‹Ÿæœºåï¼Œå†æ¬¡æŸ¥çœ‹ç£ç›˜é•œåƒç©ºé—´å¤§å°ï¼Œqcow2æ ¼å¼å°±æ˜¯ç”¨å¤šå°‘ç©ºé—´ï¼Œå å¤šå°‘ç©ºé—´ï¼Œå†™å…¥æ—¶å¤åˆ¶
[root@kvm01 data]# ll -h |grep centos7
-rw-r--r-- 1 qemu qemu 2.2G Sep  2 15:52 centos7.qcow2
```

# KVMè™šæ‹Ÿæœºæ·»åŠ ç¡¬ç›˜

```plain
1.è¿›å…¥ç£ç›˜ç›®å½•ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç¡¬ç›˜
[root@kvm01 data]# qemu-img create -f qcow2 chaoge-add01.qcow2 3G
Formatting 'chaoge-add01.qcow2', fmt=qcow2 size=3221225472 encryption=off cluster_size=65536 lazy_refcounts=off
2.æŸ¥çœ‹åˆ›å»ºçš„ç£ç›˜ä¿¡æ¯
[root@kvm01 data]# qemu-img info chaoge-add01.qcow2
image: chaoge-add01.qcow2
file format: qcow2
virtual size: 3.0G (3221225472 bytes)
disk size: 196K
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
3.ä¸ºè™šæ‹Ÿæœºæ·»åŠ ç¡¬ç›˜
# å…ˆå…³æœº
[root@kvm01 data]# virsh shutdown centos7
Domain centos7 is being shutdown
# å¯ä»¥çƒ­æ·»åŠ ç¡¬ç›˜ï¼Œæ— é¡»å…³æœº
[root@kvm01 data]#  virsh attach-disk centos7 /data/chaoge-add01.qcow2 vdb --live --cache=none --subdriver=qcow2
Disk attached successfully
4.å¯ä»¥è¿›å…¥kvmè™šæ‹Ÿæœºå†…ï¼ŒæŸ¥çœ‹ç£ç›˜ä¿¡æ¯ï¼Œå‘ç°å¤šäº†ä¸€å—vdbç£ç›˜ï¼Œ3Gå¤§å°
[root@localhost ~]# fdisk -l
Disk /dev/vda: 10.7 GB, 10737418240 bytes, 20971520 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0x000afefe
   Device Boot      Start         End      Blocks   Id  System
/dev/vda1   *        2048    20971519    10484736   83  Linux
Disk /dev/vdb: 3221 MB, 3221225472 bytes, 6291456 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
5.è‹¥æ˜¯ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæƒ³è¦è°ƒæ•´ç£ç›˜å¤§å°ï¼Œå¯ä»¥å¸è½½ï¼Œé‡æ–°è°ƒæ•´ç£ç›˜å¤§å°
[root@kvm01 data]# virsh detach-disk centos7 vdb
Disk detached successfully
# å¸è½½åï¼Œkvmè™šæ‹Ÿæœºå†…çš„ç£ç›˜ä¹Ÿå°±æ¶ˆå¤±äº†ã€‚
6.å¢åŠ ç£ç›˜å®¹é‡ï¼Œåˆšæ‰æ˜¯3Gï¼Œå†åŠ ä¸¤G
[root@kvm01 data]# qemu-img resize chaoge-add01.qcow2 +2G
Image resized.
7.é‡æ–°æ·»åŠ ç£ç›˜ç»™kvmè™šæœº
[root@kvm01 data]# virsh attach-disk centos7 /data/chaoge-add01.qcow2 vdb --live --cache=none --subdriver=qcow2
Disk attached successfully
# å¯ä»¥è¿›å…¥kvmå†æ¬¡æŸ¥çœ‹ï¼Œè™šæ‹Ÿæœºç£ç›˜
[root@localhost ~]# fdisk -l|grep vdb
Disk /dev/vdb: 5368 MB, 5368709120 bytes, 10485760 sectors
8.åœ¨è™šæ‹Ÿæœºå†…ï¼Œå¯ä»¥å¯¹ç£ç›˜è¿›è¡Œæ ¼å¼åŒ–ä½¿ç”¨
[root@localhost ~]# mkfs.xfs /dev/vdb
meta-data=/dev/vdb               isize=512    agcount=4, agsize=327680 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=0, sparse=0
data     =                       bsize=4096   blocks=1310720, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal log           bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
æŒ‚è½½ç£ç›˜ä½¿ç”¨
[root@localhost ~]# mount /dev/vdb  /mnt
[root@localhost ~]# df -h |grep vdb
/dev/vdb        5.0G   33M  5.0G   1% /mnt
# åˆ·æ–°centos7ç£ç›˜ä¿¡æ¯
[root@localhost ~]# xfs_growfs /mnt
meta-data=/dev/vdb               isize=512    agcount=4, agsize=327680 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=0 spinodes=0
data     =                       bsize=4096   blocks=1310720, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal               bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
```

| **å‚æ•°**        | **å‚æ•°è¯´æ˜** |
| --------------- | ------------ |
| **vdb**         | ç¬¬äºŒå—ç¡¬ç›˜   |
| **--live**      | çƒ­æ·»åŠ        |
| **--subdriver** | é©±åŠ¨ç±»å‹     |

# KVMå¿«ç…§ç®¡ç†

æ³¨æ„ï¼šrawæ ¼å¼çš„ç£ç›˜æ— æ³•åˆ›å»ºå¿«ç…§ï¼Œä¸æ”¯æŒã€‚

æƒ³è¦ä½¿ç”¨å¿«ç…§åŠŸèƒ½ï¼Œç£ç›˜æ ¼å¼å¿…é¡»æ˜¯qcow2

å°±å¥½æ¯”æˆ‘ä»¬ä½¿ç”¨vmwareçš„å¿«ç…§åŠŸèƒ½ï¼Œç°åœ¨è½¬åŒ–ä¸ºå‘½ä»¤è¡Œäº†

kvmå¿«ç…§å‘½ä»¤å‚æ•°

```plain
ä½¿ç”¨virshè¿›è¡ŒKVMè™šæ‹Ÿæœºå¿«ç…§ç›¸å…³å‘½ä»¤ï¼š
    iface-begin                       åˆ›å»ºä¸€ä¸ªå½“å‰ç½‘å¡çš„å¿«ç…§ï¼Œå®ƒå¯ä»¥ç”¨æ¥ç¨åæäº¤æˆ–è€…æ¢å¤
    snapshot-create                åˆ›å»ºä¸€ä¸ªå¿«ç…§
    snapshot-create-as           ä½¿ç”¨ä¸€ç»„å‚æ•°åˆ›å»ºä¸€ä¸ªå¿«ç…§
    snapshot-current              å–å¾—å½“å‰å¿«ç…§çš„é›†åˆ
    snapshot-delete                åˆ é™¤ä¸€ä¸ªå¿«ç…§
    snapshot-dumpxml          ä»ä¸€ä¸ªè™šæ‹Ÿæœºçš„å¿«ç…§å¯¼å‡ºxmlæ–‡ä»¶
    snapshot-edit                   ç¼–è¾‘ä¸€ä¸ªå¿«ç…§çš„xmlæ–‡ä»¶
    snapshot-info                   å¿«ç…§ä¿¡æ¯
    snapshot-list                     åˆ—å‡ºè™šæ‹Ÿæœºçš„å¿«ç…§åˆ—è¡¨
    snapshot-parent               è·å–ä¸€ä¸ªå¿«ç…§çš„çˆ¶å¿«ç…§åç§°
    snapshot-revert                å°†è™šæ‹Ÿæœºæ¢å¤åˆ°ä¸€ä¸ªå¿«ç…§
```

å®è·µ

```plain
1.åˆ›å»ºå¿«ç…§
[root@kvm01 data]# virsh snapshot-create centos7
Domain snapshot 1599034267 created
2.æŸ¥çœ‹å¿«ç…§åˆ—è¡¨
[root@kvm01 data]# virsh snapshot-list centos7
 Name                 Creation Time             State
------------------------------------------------------------
 1599034267           2020-09-02 16:11:07 +0800 running
3.æŸ¥çœ‹å¿«ç…§ä¿¡æ¯
[root@kvm01 data]# virsh snapshot-info centos7 --snapshotname  1599034267
Name:           1599034267
Domain:         centos7
Current:        yes
State:          running
Location:       internal
Parent:         -
Children:       0
Descendants:    0
Metadata:       yes
4.ç™»å½•è™šæ‹Ÿæœºï¼Œè¿›è¡Œåˆ ä¿®æ”¹ä½œï¼Œç„¶åå¯ä»¥ç”¨å¿«ç…§è¿˜åŸ
[root@kvm01 data]# ssh root@192.168.122.60
[root@localhost opt]# ls
a.txt  c.txt  e.txt  g.txt  i.txt  k.txt  m.txt  o.txt  q.txt  s.txt  u.txt  w.txt  y.txt
b.txt  d.txt  f.txt  h.txt  j.txt  l.txt  n.txt  p.txt  r.txt  t.txt  v.txt  x.txt  z.txt
5.è¿˜åŸå¿«ç…§
[root@kvm01 data]# virsh snapshot-revert centos7 --snapshotname 1599034267
6.å†æ¬¡è¿›å…¥kvmè™šæœºï¼ŒæŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼Œå·²ç»è¿˜åŸ
[root@localhost ~]# cd /opt/
[root@localhost opt]# ls
[root@localhost opt]#
7.å¿«ç…§ç®¡ç†
[root@kvm01 data]# ll /var/lib/libvirt/qemu/snapshot/centos7/
total 8
-rw------- 1 root root 5032 Sep  2 16:34 1599034267.xml
8.åˆ é™¤å¿«ç…§
[root@kvm01 data]# virsh snapshot-delete centos7 --snapshotname 1599034267
Domain snapshot 1599034267 deleted
[root@kvm01 data]# ll /var/lib/libvirt/qemu/snapshot/centos7/
total 0
```

# KVMè™šæ‹Ÿæœºå…‹éš†

å¤åˆ¶ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œéœ€ä¿®æ”¹å¦‚ MAC åœ°å€ï¼Œåç§°ç­‰æ‰€æœ‰ä¸»æœºç«¯å”¯ä¸€çš„é…ç½®ã€‚

è™šæ‹Ÿæœºçš„å†…å®¹å¹¶æ²¡æœ‰æ”¹å˜ï¼švirt-clone ä¸ä¿®æ”¹ä»»ä½•å®¢æˆ·æœºç³»ç»Ÿå†…éƒ¨çš„é…ç½®ï¼Œå®ƒåªå¤åˆ¶ç£ç›˜å’Œä¸»æœºç«¯çš„ä¿®æ”¹ã€‚

æ‰€ä»¥åƒä¿®æ”¹å¯†ç ï¼Œä¿®æ”¹é™æ€ IP åœ°å€ç­‰æ“ä½œéƒ½åœ¨æœ¬å·¥å…·å¤åˆ¶èŒƒå›´å†…ã€‚

å¦‚ä½•ä¿®æ”¹æ­¤ç±»å‹çš„é…ç½®ï¼Œè¯·å‚è€ƒ virt-sysprepã€‚

å…‹éš†å‘½ä»¤

```plain
# å…‹éš†æ—¶ï¼Œè™šæ‹Ÿæœºå¿…é¡»å…³é—­
[root@kvm01 data]# virt-clone --auto-clone -o centos7
ERROR    Domain with devices to clone must be paused or shutoff.
# å…‹éš†å¼€å§‹
[root@kvm01 data]# virt-clone --auto-clone -o centos7
WARNING  Setting the graphics device port to autoport, in order to avoid conflicting.
Allocating 'centos7-clone.qcow2'                20% [=======                              ] 206 MB/s | 2.0 GB  00:00:39 ETA
# å…‹éš†å®Œæˆ
[root@kvm01 data]# virt-clone --auto-clone -o centos7
WARNING  Setting the graphics device port to autoport, in order to avoid conflicting.
Allocating 'centos7-clone.qcow2'                                                                     |  10 GB  00:00:09
Allocating 'chaoge-add01-clone.qcow2'                                                                | 5.0 GB  00:00:00
Clone 'centos7-clone' created successfully.
# å…‹éš†çŒ´ï¼Œä¼šç”Ÿæˆæ–°çš„ç£ç›˜æ–‡ä»¶
[root@kvm01 data]# ll
total 8727752
-rw------- 1 root root 1830289408 Sep  2 17:13 centos7-clone.qcow2
-rw-r--r-- 1 root root 2624389120 Sep  2 16:47 centos7.qcow2
# å¯åŠ¨å…‹éš†åçš„è™šæœº
[root@kvm01 data]# virsh start centos7-clone
Domain centos7-clone started
[root@kvm01 data]# virsh list
 Id    Name                           State
----------------------------------------------------
 9     centos7-clone                  running
# ä¿®æ”¹å…‹éš†çš„è™šæœºåç§°ï¼Œå¯ä»¥å½“åšç¬¬äºŒä¸ªè™šæœºä½¿ç”¨ï¼Œæ³¨æ„å¾—å…³æœºåæ”¹å
[root@kvm01 data]# virsh domrename centos7-clone cc-centos7
Domain successfully renamed
# å¯¹æ¯”è™šæœºé…ç½®æ–‡ä»¶å·®å¼‚
é…ç½®æ–‡ä»¶ç›®å½•
[root@kvm01 data]# ll /etc/libvirt/qemu/
total 16
drwxr-xr-x 2 root root    6 Sep  2 00:40 autostart
-rw------- 1 root root 4359 Sep  2 17:13 cc-centos7.xml
-rw------- 1 root root 4342 Sep  2 16:34 centos7.xml
drwx------ 3 root root   42 Sep  1 23:04 networks
# å¯¼å‡ºé…ç½®æ–‡ä»¶ï¼Œå¯¹æ¯”é…ç½®ä¿¡æ¯
[root@kvm01 data]# virsh dumpxml centos7 > centos7.xml.dump
[root@kvm01 data]# virsh dumpxml cc-centos7 > cc.xml.dump
[root@kvm01 data]# vimdiff centos7.xml.dump cc.xml.dump
2 files to edit
```

| **å‚æ•°**                                          | **å‚æ•°è¯´æ˜**                                   |
| ------------------------------------------------- | ---------------------------------------------- |
| **--auto-clone**                                  | ä»åŸå§‹å®¢æˆ·æœºé…ç½®ä¸­è‡ªåŠ¨ç”Ÿæˆå…‹éš†åç§°å’Œå­˜å‚¨è·¯å¾„ã€‚ |
| **-o ORIGINAL_GUEST,**--original ORIGINAL_GUEST** | åŸå§‹å®¢æˆ·æœºåç§°ï¼›å¿…é¡»ä¸ºå…³é—­æˆ–è€…æš‚åœçŠ¶æ€ã€‚       |



# kvmç½‘ç»œ&è¿ç§»

# KVMæ¡¥æ¥

æˆ‘ä»¬è¿è¡Œè™šæ‹Ÿæœºçš„ç›®çš„æ˜¯ï¼Œåœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œæˆ‘ä»¬çš„ä¸šåŠ¡ï¼Œç°åœ¨ä¸šåŠ¡æ‰€éœ€è¦çš„æœåŠ¡éƒ½å·²ç»è¿è¡Œäº†ï¼Œå¯æ˜¯é™¤äº†åœ¨å®¿ä¸»æœºä¸Šèƒ½è®¿é—®ï¼Œå…¶ä»–äººéƒ½è®¿é—®ä¸äº†ï¼ï¼ï¼

æˆ‘ä»¬ä¼šåˆ©ç”¨kvmï¼Œåˆ›å»ºè™šæ‹Ÿæœºï¼Œè¿è¡Œä¸šåŠ¡æœåŠ¡ï¼Œå¦‚tomcatï¼Œlnmpï¼Œmysqlç­‰ç­‰

```plain
[root@kvm01 data]# virsh start centos7
Domain centos7 started
[root@kvm01 data]# virsh list
 Id    Name                           State
----------------------------------------------------
 11    centos7                        running
[root@kvm01 data]# virsh vncdisplay centos7
:0
# è¿›å…¥è™šæœºï¼Œå¯åŠ¨ä¸€ä¸ªwebæœåŠ¡
[root@localhost ~]# curl -I  127.0.0.1
HTTP/1.1 200 OK
Server: nginx/1.16.1
Date: Wed, 02 Sep 2020 11:29:42 GMT
Content-Type: text/html
Content-Length: 4833
Last-Modified: Fri, 16 May 2014 15:12:48 GMT
Connection: keep-alive
ETag: "53762af0-12e1"
Accept-Ranges: bytes
# ç¦»å¼€äº†è™šæœºï¼Œå°±æ— æ³•è®¿é—®nginxäº†
```

å› æ­¤ï¼Œæˆ‘ä»¬å¾—é…ç½®è™šæœºç½‘ç»œï¼Œå¦åˆ™è™šæœºä¹Ÿå°±æ²¡æœ‰æ„ä¹‰äº†

# é…ç½®kvmæ¡¥æ¥

æ¡¥æ¥ç½‘ç»œï¼Œå¤§å®¶åº”è¯¥éƒ½è¿˜è®°å¾—ï¼Œä¹Ÿå°±æ˜¯å’Œå®¿ä¸»æœºå¤„äºåŒä¸€ä¸ªç½‘ç»œç¯å¢ƒã€‚æˆ‘ä»¬vmwareé‡Œæ˜¯å¸¸ç”¨æ¡¥æ¥çš„ã€‚

```plain
1.åˆ›å»ºæ¡¥æ¥ç½‘ç»œï¼Œåœ¨å®¿ä¸»æœºä¸Šæ‰§è¡Œï¼Œæ³¨æ„è¿™ä¸ªens33ï¼Œæ˜¯æ ¹æ®ä½ å®¿ä¸»æœºçš„ç½‘å¡åå­—æ¥å†™ï¼Œç„¶ååˆ›å»ºbr0ç½‘ç»œ
[root@kvm01 ~]# virsh iface-bridge ens33  br0
2.æ‰§è¡Œåç½‘ç»œä¼šè‡ªåŠ¨é‡å¯ï¼Œç½‘å¡é…ç½®æ–‡ä»¶ä¼šè‡ªåŠ¨è¢«ä¿®æ”¹
[root@kvm01 ~]# cat /etc/sysconfig/network-scripts/ifcfg-ens33
DEVICE=ens33
ONBOOT=yes
BRIDGE="br0"
[root@kvm01 ~]# cat /etc/sysconfig/network-scripts/ifcfg-br0
DEVICE="br0"
ONBOOT="yes"
TYPE="Bridge" # ä»¥å‰æ˜¯ä»¥å¤ªç½‘ï¼Œç°åœ¨æ˜¯æ¡¥æ¥æ¨¡å¼äº†
BOOTPROTO="none"
IPADDR="10.0.1.50"
NETMASK="255.255.255.0"
GATEWAY="10.0.1.2"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
DHCPV6C="no"
STP="on"
DELAY="0"
3.æŸ¥çœ‹å®¿ä¸»æœºç½‘æ¡¥ä¿¡æ¯
[root@kvm01 ~]# brctl show
bridge name    bridge id        STP enabled    interfaces
br0        8000.000c29610466    yes        ens33
                            vnet0
virbr0        8000.525400e8129d    yes        virbr0-nic
```

ä¿®æ”¹è™šæœºé…ç½®

```plain
3.åŸºäºæ¡¥æ¥ç½‘ç»œåˆ›å»ºè™šæœºï¼Œæˆ–è€…ä¿®æ”¹å½“å‰è™šæœºï¼Œä½¿ç”¨æ¡¥æ¥ç½‘ç»œ
ä¿®æ”¹è™šæœºé…ç½®æ–‡ä»¶
# ä¿®æ”¹å‰é…ç½®
     77     <interface type='network'>
     78       <mac address='52:54:00:92:78:2b'/>
     79       <source network='default'/>
     80       <model type='virtio'/>
     81       <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>
     82     </interface>
# ä¿®æ”¹åé…ç½®
    <interface type='bridge'>
      <mac address='52:54:00:92:78:2b'/>
      <source bridge='br0'/>
      <model type='virtio'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>
    </interface>
 4.æŸ¥çœ‹è™šæœºç«¯å£
 [root@kvm01 ~]# virsh vncdisplay centos7
:0
```

## æ³¨æ„ç½‘ç»œç¯å¢ƒ

æˆ‘ä»¬è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨kvmè™šæœºé»˜è®¤ç½‘ç»œæƒ…å†µä¸‹ï¼Œæ˜¯dhcpåŠ¨æ€åˆ†é…çš„192.168ç½‘æ®µåœ°å€

é‚£ä¹ˆç°åœ¨ï¼Œæˆ‘ä»¬é…ç½®kvmè™šæœºå’Œå®¿ä¸»æœºè¿›è¡Œç½‘ç»œæ¡¥æ¥ï¼Œå¤„äºåŒä¸€ä¸ªç½‘æ®µ

**é‚£ä¹ˆï¼Œå¦‚æœä½ çš„å®¿ä¸»æœºæ˜¯åŠ¨æ€åˆ†é…ipåœ°å€ï¼Œé‚£å®Œå…¨æ²¡é—®é¢˜ï¼Œè™šæœºä¼šè‡ªåŠ¨åˆ†é…ip**

**å¦‚æœä½ çš„å®¿ä¸»æœºæ˜¯åˆ†é…é™æ€ipåœ°å€ï¼Œkvmè™šæœºä¹Ÿå¾—é…ç½®é™æ€ip**

```plain
è¶…å“¥è¿™é‡Œçš„ç½‘ç»œç¯å¢ƒæ˜¯ï¼Œå®¿ä¸»æœºä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰natï¼Œè®¾ç½®é™æ€ip
# è¶…å“¥çš„kvmè™šæœºç½‘ç»œé…ç½®æ–‡ä»¶
[root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0
TYPE="Ethernet"
PROXY_METHOD="none"
BROWSER_ONLY="no"
BOOTPROTO="static"
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="eth0"
UUID="d684faa2-5a62-4065-94e3-68769f9ffcee"
DEVICE="eth0"
ONBOOT="yes"
IPADDR="10.0.1.51"
NETMASK=255.255.255.0
GATEWAY=10.0.1.2
DNS1=1.2.4.8
# é‡å¯ç½‘ç»œå³å¯
[root@localhost ~]# systemctl restart network
# æ³¨æ„ï¼Œä¸€ä¸ªå‘ï¼Œå…³é—­kvmè™šæœºå†…çš„é˜²ç«å¢™
[root@localhost ~]# iptables -F
[root@localhost ~]# setenforce 0 # æ³¨æ„å»æ°¸ä¹…å…³é—­
[root@localhost ~]# systemctl stop firewalld
[root@localhost ~]# systemctl disable firewalld
Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.
Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.
# ä¿®æ”¹nginxé¡µé¢
[root@localhost ~]# echo "<meta charset=utf-8> è¶…å“¥æ•™ä½ å­¦kvm" > /usr/share/nginx/html/index.html
```

## ä¸€å®šæ³¨æ„å…³é—­kvmè™šæœºçš„é˜²ç«å¢™

## æ­¤æ—¶å·²ç»å¯ä»¥æ­£ç¡®è®¿é—®è™šæœºå†…æœåŠ¡

![img](äº‘è®¡ç®—.assets/1610861934345-4e5462b6-6b26-4583-88e6-fd005057fe30.png)

## kvmç½‘ç»œæ‹“æ‰‘å›¾

é»˜è®¤ç½‘ç»œï¼Œdefaultï¼Œnatæ¨¡å¼

![img](äº‘è®¡ç®—.assets/1610861934350-14d01485-3519-4290-9b9b-3df498c220c4.png)

æ¡¥æ¥æ¨¡å¼

![img](äº‘è®¡ç®—.assets/1610861934346-3dc735ff-60d8-4f63-bef9-ec098bb9b1f7.png)

# kvmçƒ­æ·»åŠ æŠ€æœ¯

çƒ­æ·»åŠ æŠ€æœ¯å°±æ˜¯ä¸åœæœºçš„æƒ…å†µä¸‹ï¼Œåœ¨çº¿çƒ­æ·»åŠ ç¡¬ç›˜ï¼Œå†…å­˜ï¼Œcpuï¼Œç½‘å¡ç­‰è®¾å¤‡ï¼Œçƒ­æ·»åŠ æŠ€æœ¯ä¸€èˆ¬éƒ½æ˜¯åœ¨è™šæ‹Ÿæœºèµ„æºä¸å¤Ÿäº†ï¼Œåˆä¸èƒ½åœæœºçš„æƒ…å†µä¸‹ä½¿ç”¨çš„ï¼Œçƒ­æ·»åŠ æŠ€æœ¯æ˜¯è™šæ‹Ÿæœºç›¸å¯¹äºç‰©ç†æœºçš„ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜åŠ¿ï¼Œå®ƒè®©èµ„æºåˆ†é…å˜å¾—æ›´çµæ´»ï¼

```plain
1.åˆ›å»ºç¡¬ç›˜
[root@kvm01 data]# qemu-img create -f qcow2 centos7-add01.qcow2 5G
Formatting 'centos7-add01.qcow2', fmt=qcow2 size=5368709120 encryption=off cluster_size=65536 lazy_refcounts=off
2.æŸ¥çœ‹æ–°ç¡¬ç›˜ä¿¡æ¯
[root@kvm01 data]# qemu-img info centos7-add01.qcow2
image: centos7-add01.qcow2
file format: qcow2
virtual size: 5.0G (5368709120 bytes)
disk size: 196K
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
3.æ£€æŸ¥è™šæœºå†…ç¡¬ç›˜ä¿¡æ¯
[root@kvm01 ~]# !ssh
ssh root@10.0.1.51
root@10.0.1.51's password:
Last login: Wed Sep  2 20:15:42 2020 from 10.0.1.50
# è™šæœºå†…çš„ä¿¡æ¯
[root@localhost ~]# fdisk -l
Disk /dev/vda: 10.7 GB, 10737418240 bytes, 20971520 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0x000afefe
   Device Boot      Start         End      Blocks   Id  System
/dev/vda1   *        2048    20971519    10484736   83  Linux
Disk /dev/vdb: 5368 MB, 5368709120 bytes, 10485760 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
4.å‘ç°è™šæœºå†…å·²ç»æ˜¯2å—ç¡¬ç›˜äº†ï¼Œæ³¨æ„ç¡¬ç›˜çš„åå­—
# æ–°æ·»åŠ ç¡¬ç›˜ï¼Œåå­—æ˜¯vdcï¼Œçƒ­æ·»åŠ ï¼ˆå¼€æœºæ—¶æ·»åŠ ï¼‰ï¼Œé©±åŠ¨åå­—æ˜¯qcow2
[root@kvm01 data]# virsh attach-disk centos7 /data/centos7-add01.qcow2 vdc --live --cache=none --subdriver=qcow2
Disk attached successfully
5.å†å»è™šæœºå†…æŸ¥çœ‹ä¿¡æ¯
[root@localhost ~]# fdisk -l |grep "/dev/vd*"
Disk /dev/vda: 10.7 GB, 10737418240 bytes, 20971520 sectors
/dev/vda1   *        2048    20971519    10484736   83  Linux
Disk /dev/vdb: 5368 MB, 5368709120 bytes, 10485760 sectors
Disk /dev/vdc: 5368 MB, 5368709120 bytes, 10485760 sectors
6.æˆ‘ä»¬å¯ä»¥ç»™ç¡¬ç›˜è¿›è¡Œåˆ†åŒºï¼Œæ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‚è½½ä½¿ç”¨
ä¹Ÿå¯ä»¥ä¸åˆ†åŒºï¼Œç›´æ¥æ ¼å¼åŒ–ä½¿ç”¨ï¼ŒæŸ¥çœ‹æ˜¯å¦å¯ä»¥ä½¿ç”¨ç£ç›˜çš†å¯ã€‚
è¿™è·Ÿå†œæ°‘ä¼¯ä¼¯ç§åœ°æ˜¯ä¸€ä¸ªé“ç†ã€‚
æŠŠä¸€äº©åœ°åˆ†æˆåä¸ªç•¦æ˜¯ä¸ºäº†æµ‡æ°´çš„æ—¶å€™æ–¹ä¾¿ï¼Œä½†æ˜¯è¿™ä¸æ„å‘³è¿™ä¸åˆ†ç•¦å°±ä¸èƒ½ç§åº„ç¨¼ã€‚
```

# çƒ­æ·»åŠ ç½‘å¡

æˆ‘ä»¬è¿™äº›æ“ä½œï¼Œéƒ½æ˜¯çº¯å‘½ä»¤è¡Œæ“ä½œï¼Œè‹¥æ˜¯vmwareè¿™æ ·çš„è½¯ä»¶ï¼Œæä¾›äº†å›¾å½¢åŒ–ç‚¹å‡»ï¼Œå°±ç®€å•å¤šäº†

```plain
1.å‘½ä»¤,æ³¨æ„å‘½ä»¤çš„æ­£ç¡®
[root@kvm01 data]# virsh attach-interface centos7 --type bridge --model virtio --source br0
Interface attached successfully
2.æ·»åŠ å®Œäº†ä¹‹åï¼Œsshè¿œç¨‹æ£€æŸ¥è™šæœºå†…é…ç½®
[root@kvm01 data]# ssh root@10.0.1.51 ip addr show
root@10.0.1.51's password:
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:92:78:2b brd ff:ff:ff:ff:ff:ff
    inet 10.0.1.51/24 brd 10.0.1.255 scope global noprefixroute eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::7cbc:14d3:6233:1dec/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:f3:d5:74 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::ca86:9b12:c215:10d9/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
3.è¦æ³¨æ„å‘½ä»¤æ·»åŠ çš„ç½‘å¡ï¼Œéƒ½æ˜¯ä¸´æ—¶ç”Ÿæ•ˆï¼Œæƒ³è¦æ°¸ä¹…ï¼Œè¿˜å¾—æ”¹é…ç½®æ–‡ä»¶
[root@kvm01 data]# virsh edit centos7
Domain centos7 XML configuration edited.
# æ·»åŠ é…ç½® 83~86
     77     <interface type='bridge'>
     78       <mac address='52:54:00:92:78:2b'/>
     79       <source bridge='br0'/>
     80       <model type='virtio'/>
     81       <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>
     82     </interface>
     83     <interface type='bridge'>
     84       <source bridge='br0'/>
     85       <model type='virtio'/>
     86     </interface>
4.é‡å¯kvmè™šæœºï¼ŒæŸ¥çœ‹æ˜¯å¦è¿˜æœ‰ç½‘å¡2
[root@kvm01 data]# virsh shutdown centos7
Domain centos7 is being shutdown
[root@kvm01 data]#
[root@kvm01 data]#
[root@kvm01 data]#
[root@kvm01 data]# virsh start  centos7
Domain centos7 started
# å³ä½¿é‡å¯åï¼Œkvmä¹Ÿå¤šäº†ä¸€ä¸ªç½‘å¡çš„é…ç½®
[root@localhost ~]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:92:78:2b brd ff:ff:ff:ff:ff:ff
    inet 10.0.1.51/24 brd 10.0.1.255 scope global noprefixroute eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::7cbc:14d3:6233:1dec/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:1f:8a:93 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::7558:4ee3:be5e:c53a/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
5.åªéœ€è¦ç»™è¯¥ç½‘å¡æ·»åŠ é…ç½®å‚æ•°ï¼Œå³å¯ä½¿ç”¨
[root@localhost network-scripts]# uuidgen eth1
6f586f3d-a33f-4822-9c62-16600321458b
# ç½‘å¡é…ç½®ä¿®æ”¹å¦‚ä¸‹
[root@localhost network-scripts]# cat ifcfg-eth1
TYPE="Ethernet"
PROXY_METHOD="none"
BROWSER_ONLY="no"
BOOTPROTO="static"
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="eth1"
UUID="6f586f3d-a33f-4822-9c62-16600321458b"
DEVICE="eth1"
ONBOOT="yes"
IPADDR="10.0.1.52"
NETMASK=255.255.255.0
GATEWAY=10.0.1.2
DNS1=1.2.4.8
6.é‡å¯ç½‘å¡å³å¯ï¼Œä½¿ç”¨
systemctl restart network
```

# çƒ­æ·»åŠ CPU

```plain
1. é»˜è®¤åˆ›å»ºçš„è™šæœºï¼Œæœ€å¤§cpuæ ¸æ•°å°±æ˜¯1ï¼Œå¾—æå‰æŒ‡å®šæœ€å¤§æ ¸æ•°
# æ³¨æ„è¿™é‡Œçš„æ“ä½œï¼Œæ˜¯å…ˆå½»åº•åˆ é™¤æ—§çš„è™šæœºï¼Œç•™ä¸‹ç£ç›˜æ–‡ä»¶å³å¯
# ç„¶åæ–°çš„è™šæœºå¯åŠ¨æ—¶ï¼Œç”¨è¯¥ç£ç›˜å¯åŠ¨ï¼Œå³å¯å¿«é€Ÿå¼€æœº
virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name web01 --memory 1024 --vcpus 1,maxvcpus=4 --disk /data/centos7.qcow2,format=qcow2,size=10 --boot hd --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole
# æ£€æŸ¥å½“å‰cpuæ•°é‡
2.çƒ­æ·»åŠ cpuå‘½ä»¤
[root@kvm01 data]# virsh setvcpus web01 --count=2
```

å½“å‰è™šæœºçš„cpuæ•°é‡ï¼Œåªæœ‰ä¸€ä¸ª

![img](äº‘è®¡ç®—.assets/1610861934351-32dddeed-4226-4a36-ab8b-bf56af523a4a.png)

æ‰§è¡Œå®Œæ¯•çƒ­æ·»åŠ å‘½ä»¤ï¼Œå†æ£€æŸ¥

```plain
[root@kvm01 data]# ssh root@10.0.1.51 lscpu |grep "^CPU(s)"
root@10.0.1.51's password:
CPU(s):                2
```

# çƒ­æ·»åŠ å†…å­˜

```plain
1.å…ˆæŸ¥çœ‹å½“å‰è™šæ‹Ÿæœºçš„å†…å­˜æƒ…å†µ
[root@kvm01 data]# ssh root@10.0.1.51 "free -m"
root@10.0.1.51's password:
              total        used        free      shared  buff/cache   available
Mem:            991          68         828           6          94         796
Swap:             0           0           0
2.æƒ³è¦èƒ½å¤Ÿä¿®æ”¹å†…å­˜ï¼Œè¿˜å¾—å†åˆ›å»ºçš„æ—¶å€™ï¼ŒæŒ‡å®šå¥½æœ€å¤§å†…å­˜å‚æ•°
# åŸºäºè™šæœºçš„ç£ç›˜ï¼Œå–æ¶ˆå½“å‰è™šæœºï¼Œç„¶åå†é‡æ–°åˆ›å»º
[root@kvm01 data]# virsh destroy web01
Domain web01 destroyed
[root@kvm01 data]#
[root@kvm01 data]#
[root@kvm01 data]# virsh undefine web01
Domain web01 has been undefined
# é‡æ–°åˆ›å»ºï¼Œæ³¨æ„å‚æ•°
[root@kvm01 data]# virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name web01 --memory 512,maxmemory=2048 --vcpus=1,maxvcpus=2 --disk /data/centos7.qcow2,format=qcow2,size=10 --boot hd --network bridge=br0 --graphics vnc,listen=0.0.0.0  --noautoconsole
Starting install...
Domain creation completed.
# çƒ­æ·»åŠ å†…å­˜
[root@kvm01 data]# ssh root@10.0.1.51 "free -m"
root@10.0.1.51's password:
              total        used        free      shared  buff/cache   available
Mem:            302          69          86           8         146          76
Swap:             0           0           0
[root@kvm01 data]#
[root@kvm01 data]#
[root@kvm01 data]#
# ä¿®æ”¹å†…å­˜å¤§å°
[root@kvm01 data]# virsh setmem web01 2G
[root@kvm01 data]# ssh root@10.0.1.51 "free -m"
root@10.0.1.51's password:
              total        used        free      shared  buff/cache   available
Mem:           1838          69        1623           8         145        1612
Swap:             0           0           0
```

# KVMè™šæ‹Ÿæœºå†·çƒ­è¿ç§»

## å†·è¿ç§»å®è·µ

å‡†å¤‡ä¸€å°å’ŒKVM01é…ç½®ç›¸åŒçš„æœºå™¨ï¼Œé…ç½®å¥½kvmç¯å¢ƒ

```plain
# å®‰è£…kvmç»„ä»¶
[root@kvm02 yum.repos.d]# yum install libvirt virt-install qemu-kvm -y
# å¯åŠ¨æœåŠ¡
[root@kvm02 ~]# systemctl start libvirtd
# é…ç½®æ¡¥æ¥ç½‘ç»œ
[root@kvm02 ~]# virsh iface-bridge ens33 br0
# 
[root@kvm02 ~]# mkdir -p /data
```

å¯¼å‡ºkvm01çš„é…ç½®æ–‡ä»¶

```plain
# å¯¼å‡ºè™šæœºé…ç½®æ–‡ä»¶
[root@kvm01 data]# virsh dumpxml web01 > web01.xml
[root@kvm01 data]#
[root@kvm01 data]#
[root@kvm01 data]# ls
centos7.qcow2  CentOS-7-x86_64-DVD-1804.iso  web01.xml
# å‘é€è™šæœºé…ç½®æ–‡ä»¶ï¼Œä»¥åŠç£ç›˜æ–‡ä»¶ï¼Œå‘é€ç»™kvm01æœºå™¨
[root@kvm01 data]# scp -rp web01.xml  centos7.qcow2 10.0.1.63:/data/
```

åœ¨kvm02ä¸Šæ“ä½œ

```plain
[root@kvm02 data]# ls
centos7.qcow2  web01.xml
# å¯¼å…¥é…ç½®æ–‡ä»¶
[root@kvm02 data]# virsh define web01.xml
Domain web01 defined from web01.xml
[root@kvm02 data]# virsh list
 Id    Name                           State
----------------------------------------------------
[root@kvm02 data]# virsh list --all
 Id    Name                           State
----------------------------------------------------
 -     web01                          shut off
# å¯åŠ¨è™šæ‹Ÿæœº
[root@kvm02 data]# virsh start web01
error: Failed to start domain web01
error: unsupported configuration: Domain requires KVM, but it is not available. Check that virtualization is enabled in the host BIOS, and host configuration is setup to load the kvm modules.
# è‹¥æ˜¯å‡ºç°å¦‚ä¸Šé—®é¢˜ï¼Œè¯´æ˜ä½ çš„è¿™å°è™šæ‹Ÿæœºï¼Œæ²¡å¼€å¯cpuè™šæ‹ŸåŒ–ï¼Œå…³æœºï¼Œæèµ·æ¥ï¼Œè·Ÿç€è¶…å“¥æŒ‡æŒ¥ï¼Œæ²¡é”™
# å†æ¥ï¼Œå¥¥åŠ›ç»™
[root@kvm02 ~]# virsh list --all
 Id    Name                           State
----------------------------------------------------
 -     web01                          shut off
[root@kvm02 ~]#
[root@kvm02 ~]#
[root@kvm02 ~]# virsh start web01
Domain web01 started
# æ­¤æ—¶å¯ä»¥ç”¨vncå»è¿æ¥è™šæ‹Ÿæœº
10.0.1.63:5900
```

è‡³æ­¤kvmçš„å†·è¿ç§»ï¼Œå°±å®Œæˆäº†ã€‚

## çƒ­è¿ç§»å®è·µ

çƒ­è¿ç§»ï¼š ç›¸æ¯”KVMè™šæ‹Ÿæœºå†·è¿ç§»ä¸­éœ€è¦æ‹·è´è™šæ‹Ÿæœºè™šæ‹Ÿç£ç›˜æ–‡ä»¶ï¼Œkvmè™šæ‹Ÿæœºçƒ­è¿ç§»æ— éœ€æ‹·è´è™šæ‹Ÿç£ç›˜æ–‡ä»¶ï¼Œä½†æ˜¯éœ€è¦è¿ç§»åˆ°çš„å®¿ä¸»æœºä¹‹é—´éœ€è¦æœ‰ç›¸åŒçš„ç›®å½•ç»“æ„è™šæ‹Ÿæœºç£ç›˜æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å…±äº«å­˜å‚¨ï¼Œè¿™æ¬¡é€šè¿‡å¤§å®¶ç†Ÿæ‚‰çš„nfsæ¥å®ç°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é‡‡ç”¨Glusterfsç­‰åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿæ¥å®ç°.



 ä¸Šä¸€èŠ‚æˆ‘ä»¬å­¦ä¹ äº†åœ¨çº¿çƒ­æ·»åŠ æŠ€æœ¯ï¼Œå°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚å‡è®¾æˆ‘åˆçº§åªæœ‰ä¸€å°16Gå†…å­˜çš„ç‰©ç†æœºï¼Œä¸ºäº†å……åˆ†åˆ©ç”¨èµ„æºï¼Œæˆ‘å¯èƒ½è¿è¡Œäº†8å°2Gå†…å­˜çš„è™šæ‹Ÿæœºï¼Œç„¶åè®¿é—®é‡å¢åŠ ï¼Œè™šæ‹Ÿæœºçš„2Gå†…å­˜ä¸å¤Ÿç”¨äº†ï¼Œéœ€è¦æ‰©å®¹ï¼Œæ‰©å®¹ä¹‹å‰æˆ‘ä»¬å°±éœ€è¦å…ˆè¿ç§»ä¸€éƒ¨åˆ†è™šæ‹Ÿæœºåˆ°å…¶ä»–å®¿ä¸»æœºä¸Šäº†ï¼Œæœ‰çš„ä¸šåŠ¡ç‰¹åˆ«æ ¸å¿ƒï¼Œæš‚åœçš„æ—¶é—´ä¸èƒ½å¤ªé•¿ï¼Œè¿™æ—¶å€™å°±è¦ç”¨åˆ°æˆ‘ä»¬çš„çƒ­è¿ç§»äº†ã€‚

å‡è®¾æˆ‘ä»¬æœ‰2å°å®¿ä¸»æœºkvm01å’Œkvm02,åœ¨kvm01ä¸ŠæŒ‚èµ·è™šæ‹Ÿæœºvm01ï¼Œå‘é€vmçš„è™šæ‹Ÿæœºé…ç½®æ–‡ä»¶å’Œè¿è¡Œæ—¶å†…å­˜ä¸­çš„æ•°æ®åˆ°kvm02, æ¥å—å®Œæ¯•ï¼Œkvm02æ¢å¤vm01,çƒ­è¿ç§»å®Œæˆã€‚

![img](äº‘è®¡ç®—.assets/1610861934368-b554a0d8-d5c7-4bc1-877a-004e54781438.png)

ç¯å¢ƒå‡†å¤‡

| ä¸»æœºå | ip        | å†…å­˜ | ç½‘ç»œ            | è½¯ä»¶éœ€æ±‚ | è™šæ‹ŸåŒ–     |
| ------ | --------- | ---- | --------------- | -------- | ---------- |
| kvm01  | 10.0.0.11 | 2G   | åˆ›å»ºbr0æ¡¥æ¥ç½‘å¡ | kvmå’Œnfs | å¼€å¯è™šæ‹ŸåŒ– |
| kvm02  | 10.0.0.12 | 2G   | åˆ›å»ºbr0æ¡¥æ¥ç½‘å¡ | kvmå’Œnfs | å¼€å¯è™šæ‹ŸåŒ– |
| nfs01  | 10.0.0.31 | 1G   | æ—               | nfs      | æ—          |

å…·ä½“æ“ä½œæµç¨‹

```plain
ä¸€ï¼šåœ¨kvm01å’Œkvm02ä¸Šå®‰è£…kvmå’Œnfs,é…ç½®æ¡¥æ¥ç½‘å¡
äºŒï¼šåœ¨nfs01ä¸Šå®‰è£…é…ç½®nfs
ä¸‰ï¼škvm01å’Œkvm02æŒ‚è½½å…±äº«ç›®å½•/opt
å››ï¼šå®‰è£…ä¸€å°åŸºäºæ¡¥æ¥æ¨¡å¼çš„è™šæ‹Ÿæœº
äº”ï¼šåœ¨kvm01ä¸Šå®‰è£…å›¾å½¢ç•Œé¢ã€vncæœåŠ¡ç«¯å’Œvirt-manager
å…­ï¼šå¯åŠ¨vncæœåŠ¡ç«¯
ä¸ƒï¼šä½¿ç”¨vncè¿æ¥å®¿ä¸»æœºï¼Œä½¿ç”¨virt-managerè¿›è¡Œè¿ç§»
```

### å®è·µæ­¥éª¤

```plain
å®ç°kvmè™šæ‹Ÿæœºçƒ­è¿ç§»æ ¸å¿ƒï¼šå…±äº«å­˜å‚¨ã€‚åœ¨è¿™é‡Œä½¿ç”¨çš„æ—¶NFSå…±äº«å­˜å‚¨ï¼Œå…³äºnfsçš„è¯¦æƒ…å‚è€ƒï¼š
1ã€å®‰è£…virt-manageræ‰€éœ€æ¡Œé¢åŠvnc-server
# ç”¨æœ¬åœ°å…‰ç›˜é•œåƒï¼ŒåŠ é€Ÿå®‰è£…ï¼Œå¦åˆ™å¤ªå¤§ï¼Œæ˜¯å¾ˆéš¾å®‰è£…çš„
[root@kvm01 yum.repos.d]# mount /dev/cdrom /mnt
mount: /dev/sr0 is write-protected, mounting read-only
[root@kvm01 yum.repos.d]# yum groupinstall "GNOME Desktop" -y
2.å®‰è£…vnc-serverç«¯
[root@kvm01 yum.repos.d]# yum install tigervnc-server -y
3.virt-manageréœ€è¦è½¯ä»¶
[root@kvm01 yum.repos.d]# yum install openssh-askpass -y
```

é…ç½®vncæœåŠ¡

```plain
1.å¤åˆ¶vncé…ç½®æ–‡ä»¶
[root@kvm01 yum.repos.d]# \cp /usr/lib/systemd/system/vncserver@.service  /usr/lib/systemd/system/vncserver@\:1.service
2.ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå’Œè¶…å“¥çš„ä¸€æ ·
[root@kvm01 yum.repos.d]#  egrep -v "^#|^$" /usr/lib/systemd/system/vncserver@\:1.service
[Unit]
Description=Remote desktop service (VNC)
After=syslog.target network.target
[Service]
Type=forking
User=root
# Clean any existing files in /tmp/.X11-unix environment
ExecStartPre=/bin/sh -c '/usr/bin/vncserver -kill %i > /dev/null 2>&1 || :'
ExecStart=/sbin/runuser -l root -c "/usr/bin/vncserver %i -geometry 1280x720"
PIDFile=/root/.vnc/%H%i.pid
ExecStop=/bin/sh -c '/usr/bin/vncserver -kill %i > /dev/null 2>&1 || :'
[Install]
WantedBy=multi-user.target
3.ä¿®æ”¹åï¼Œé‡è¯»é…ç½®æ–‡ä»¶
[root@kvm01 yum.repos.d]# systemctl daemon-reload
4.è®¾ç½®vncè¿æ¥å¯†ç 
[root@kvm01 yum.repos.d]# vncpasswd
Password:
Verify:
Would you like to enter a view-only password (y/n)? n   # nä¸ºéåªè¯»ç”¨æˆ·
A view-only password is not used
5.å¯åŠ¨vncï¼Œè®¾ç½®å¼€æœºè‡ªå¯
[root@kvm01 system]# systemctl start vncserver@\:1.service
6.æŸ¥çœ‹å¯†ç æ–‡ä»¶
[root@kvm01 ~]# ll ~/.vnc/
total 20
-rw-r--r-- 1 root root 332 Sep  2 23:12 config
-rw-r--r-- 1 root root 621 Sep  2 23:12 kvm01:1.log
-rw-r--r-- 1 root root   6 Sep  2 23:12 kvm01:1.pid
-rw------- 1 root root   8 Sep  2 22:57 passwd
-rwxr-xr-x 1 root root  92 Sep  2 23:12 xstartup
7.æŸ¥çœ‹vncæœåŠ¡ç«¯å£
[root@kvm01 ~]# !net
netstat -tunlp |grep 5901
tcp        0      0 0.0.0.0:5901            0.0.0.0:*               LISTEN      35203/Xvnc
tcp6       0      0 :::5901                 :::*                    LISTEN      35203/Xvnc
```

### é…ç½®NFSå­˜å‚¨

```plain
1.å®‰è£…é…ç½®nfs
[root@kvm01 ~]# yum install nfs-utils rpcbind -y
2.ä¿®æ”¹é…ç½®æ–‡ä»¶
[root@kvm01 ~]# cat /etc/exports
/data 10.0.1.0/24(rw,sync,all_squash,anonuid=0,anongid=0)
3.å¯åŠ¨nfsæœåŠ¡
[root@kvm01 ~]# systemctl restart rpcbind
[root@kvm01 ~]# systemctl restart nfs
[root@kvm01 ~]#
[root@kvm01 ~]#
[root@kvm01 ~]# systemctl enable rpcbind
[root@kvm01 ~]# systemctl enable nfs
Created symlink from /etc/systemd/system/multi-user.target.wants/nfs-server.service to /usr/lib/systemd/system/nfs-server.service.
```

## kvm02ä¸Šæ“ä½œ

```plain
1.å®‰è£…nfs
[root@kvm02 ~]#  yum install nfs-utils rpcbind -y
2.æŸ¥çœ‹å…±äº«ä¿¡æ¯
[root@kvm02 ~]# showmount -e 10.0.1.50
Export list for 10.0.1.50:
/data 10.0.1.0/24
3.æŒ‚è½½ç›®å½•
[root@kvm02 ~]# mount.nfs 10.0.1.50:/data /data
[root@kvm02 ~]#
[root@kvm02 ~]#  ls /data/
centos7.qcow2  CentOS-7-x86_64-DVD-1804.iso  web01.xml
# åŠ å…¥å¼€æœºè‡ªå¯
[root@kvm02 ~]# echo 'mount.nfs 10.0.1.50:/data /data' >> /etc/rc.local
[root@kvm02 ~]# chmod  +x /etc/rc.d/rc.local
```

## å®ç°çƒ­è¿ç§»

1.vncè¿æ¥kvm

```plain
10.0.1.50:5901
è¾“å…¥å¯†ç 
chaoge666
è¿›å…¥linuxæœåŠ¡å™¨
```

![img](äº‘è®¡ç®—.assets/1610861934361-3dbf19ff-6131-4592-a555-f63d3942d0f0.png)

2.ä½¿ç”¨vmmè™šæ‹Ÿç³»ç»Ÿç®¡ç†å™¨

```plain
[root@kvm01 ~]# yum install virt-manager -y
```

![img](äº‘è®¡ç®—.assets/1610861934371-3b545ae9-8c0a-4402-b693-c9b1a7189e29.png)

## ä¸»æœºçƒ­è¿ç§»

### è¿ç§»å‰

å§kvm01çš„è™šæ‹Ÿæœºï¼Œè¿ç§»åˆ°Kvm02æœºå™¨ä¸Šå»

![img](äº‘è®¡ç®—.assets/1610861934374-2addca02-8908-4e8c-9c79-07cde1ca2cc1.png)

```plain
æ³¨æ„ï¼šå…ˆå§kvm02ä¸Šçš„è™šæ‹Ÿæœºç»™å…³æ‰
å› ä¸ºå’±ä»¬åˆšæ‰å·²ç»å†·è¿ç§»è¿‡äº†
# åˆ é™¤æ­¥éª¤
[root@kvm02 ~]# virsh destroy web01
Domain web01 destroyed
[root@kvm02 ~]# virsh undefine web01
Domain web01 has been undefined
```

### è¿ç§»å

![img](äº‘è®¡ç®—.assets/1610861934368-f9c0d2c4-8170-40ca-a22c-f7981c147423.png)

```plain
è™šæ‹Ÿæœºå·²ç»ä»kvm01 è¿ç§»åˆ°äº†kvm02
[root@kvm02 ~]# virsh list
 Id    Name                           State
----------------------------------------------------
 3     web01                          running
 [root@kvm01 ~]# virsh list
 Id    Name                           State
----------------------------------------------------
```

### è™šæ‹Ÿæœºçš„é…ç½®ä¿¡æ¯

![img](äº‘è®¡ç®—.assets/1610861934377-bcf84e6a-2eb4-45c8-bdc4-0bdbf09622d5.png)



# å®¹å™¨

æˆ‘ä»¬å…ˆçœ‹çœ‹å¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼ŒæœåŠ¡å™¨æ˜¯æ€ä¹ˆéƒ¨ç½²åº”ç”¨çš„ï¼

![img](äº‘è®¡ç®—.assets/1610861972929-08536daf-08a5-493b-a8f5-0a610d38c86b.png)

ç”±äºç‰©ç†æœºçš„è¯¸å¤šé—®é¢˜ï¼Œåæ¥å‡ºç°äº†è™šæ‹Ÿæœºã€‚

![img](äº‘è®¡ç®—.assets/1610861972931-53f105d3-8312-405b-9dd9-875a5acd54a0.png)

ä½†æ˜¯è™šæ‹ŸåŒ–ä¹Ÿæ˜¯æœ‰å±€é™æ€§çš„ï¼Œæ¯ä¸€ä¸ªè™šæ‹Ÿæœºéƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œè¦åˆ†é…ç³»ç»Ÿèµ„æºï¼Œè™šæ‹Ÿæœºå¤šé“ä¸€å®šç¨‹åº¦æ—¶ï¼Œæ“ä½œç³»ç»Ÿæœ¬èº«èµ„æºä¹Ÿå°±æ¶ˆè€—æ®†å°½ï¼Œæˆ–è€…è¯´å¿…é¡»æ‰©å®¹

## ä¸ºä»€ä¹ˆå­¦docker

æŸå…¬å¸çš„äº§å“è¿è¡Œåœ¨å†…éƒ¨çš„è™šæ‹ŸåŒ–å¹³å°ä¸­ï¼Œå¦‚openstackï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€å­¦çš„KVMè™šæ‹ŸåŒ–ï¼Œåˆ›å»ºè™šæ‹Ÿæœºã€‚

ä½†æ˜¯ä¸æ–­å¢åŠ çš„äº‘ç«¯åº”ç”¨ï¼Œå¢åŠ äº†å¯¹ç¡¬ä»¶èµ„æºçš„æ¶ˆè€—ï¼Œä¸æ–­çš„åˆ›å»ºè™šæ‹Ÿæœºï¼Œç»™å…¬å¸å¸¦æ¥äº†éš¾é¢˜ï¼Œå…¬å¸å·²ç»åœ¨äº‘å¹³å°ä¸Šè¿è¡Œäº†å¤šå°äº‘ä¸»æœºï¼Œæ¶ˆè€—äº†å¤§é‡çš„ç¡¬ä»¶èµ„æºã€‚

æ€ä¹ˆæ‰èƒ½å¤Ÿé«˜æ•ˆçš„åˆ©ç”¨ç¡¬ä»¶èµ„æºå®ç°äº‘æœåŠ¡å‘¢ï¼Ÿ

å®¹å™¨æŠ€æœ¯ï¼Œæ­¤æ—¶å°±æ´¾ä¸Šç”¨åœºäº†ã€‚

## å®¹å™¨æŠ€æœ¯

Dockeræœ€åˆæ˜¯DotCloudå…¬å¸åœ¨æ³•å›½æœŸé—´å‘èµ·çš„ä¸€ä¸ªå…¬å¸å†…éƒ¨é¡¹ç›®ï¼Œåæ¥ä»¥Apache2.0æˆæƒåè®®å¼€æºï¼Œä»£ç åœ¨Githubä¸Šç»´æŠ¤ã€‚

Dockeræ˜¯åŸºäºGoogleå…¬å¸æ¨å‡ºçš„Golangè¯­è¨€å¼€å‘è€Œæ¥ï¼ŒåŸºäºLinuxå†…æ ¸çš„Cgroupsã€NameSpaceï¼Œä»¥åŠUnion FSç­‰æŠ€æœ¯ï¼Œå¯¹è¿›ç¨‹è¿›è¡Œå°è£…éš”ç¦»ï¼Œå±äºæ“ä½œç³»ç»Ÿå±‚é¢çš„è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚

ç”±äºéš”ç¦»çš„è¿›ç¨‹ç‹¬ç«‹äºå®¿ä¸»æœºå’Œå…¶ä»–éš”ç¦»çš„è¿›ç¨‹ï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸ºå®¹å™¨ã€‚

æœ€åˆçš„Dockeræ˜¯åŸºäºLXCçš„ï¼Œåæ¥å»é™¤LXCè½¬è€Œä½¿ç”¨è‡ªè¡Œå¼€å‘çš„Libcontainerã€‚

Dockerè¢«å®šä¹‰ä¸ºå¼€æºçš„å®¹å™¨å¼•æ“ï¼Œå¯ä»¥æ–¹ä¾¿çš„å¯¹å®¹å™¨è¿›è¡Œç®¡ç†ã€‚ä¾‹å¦‚å¯¹é•œåƒæ‰“åŒ…å°è£…ï¼Œå¼•å…¥Docker Registryå¯¹é•œåƒç»Ÿä¸€ç®¡ç†ã€‚

åˆ©ç”¨Dockerå¯ä»¥å®ç°å¼€å‘ï¼Œæµ‹è¯•ï¼Œç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²ä¸€è‡´æ€§ï¼Œæå¤§çš„å‡å°‘è¿ç»´æˆæœ¬ã€‚

## å®¹å™¨å’Œè™šæ‹Ÿæœºçš„å·®å¼‚

### ä¼ ç»Ÿè™šæ‹ŸæœºæŠ€æœ¯

è™šæ‹Ÿæœºæ˜¯è™šæ‹Ÿå‡ºä¸€å¥—ç¡¬ä»¶ï¼Œåœ¨å…¶ä¸Šé¢è¿è¡Œä¸€ä¸ªå®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œä¾‹å¦‚æˆ‘ä»¬ä½¿ç”¨KVMï¼ŒæŒ‡å®šç³»ç»Ÿé•œåƒï¼Œç„¶åè£…ç³»ç»Ÿï¼Œæœ€ç»ˆå¯ä»¥ä½¿ç”¨ï¼Œåœ¨è¯¥ç³»ç»Ÿä¸Šå†è¿è¡Œæ‰€éœ€çš„åº”ç”¨ç¨‹åºã€‚

KVMåˆ›å»ºè™šæ‹Ÿæœºæ—¶ï¼ŒæŒ‡å®šè¾ƒå°‘çš„cpuï¼Œå†…å­˜ï¼Œç¡¬ç›˜ç­‰èµ„æºï¼Œè™šæ‹Ÿæœºæ€§èƒ½è¾ƒä½ã€‚

![img](äº‘è®¡ç®—.assets/1610861972937-184449f2-b4c1-43e9-baaa-39526f839628.png)

### å®¹å™¨æŠ€æœ¯

å®¹å™¨å†…çš„åº”ç”¨ç¨‹åºç›´æ¥è¿è¡Œåœ¨å®¿ä¸»æœºçš„å†…æ ¸ä¸Šï¼Œå®¹å™¨å†…æ²¡æœ‰è‡ªå·±çš„å†…æ ¸ï¼Œä¹Ÿæ²¡æœ‰å¯¹ç¡¬ä»¶è¿›è¡Œè™šæ‹Ÿï¼Œå› æ­¤å®¹å™¨æ¯”èµ·è™šæ‹Ÿæœºæ›´ä¸ºè½»ä¾¿ã€‚

![img](äº‘è®¡ç®—.assets/1610861972947-a742a062-4cb0-4ee1-b58a-c3d2eb8759fe.png)

### å®¹å™¨å¯¹æ¯”KVMçš„å¥½å¤„

- å®¹å™¨èƒ½å¤Ÿæä¾›å®¿ä¸»æœºçš„æ€§èƒ½ï¼Œè€Œkvmè™šæ‹Ÿæœºæ˜¯åˆ†é…å®¿ä¸»æœºç¡¬ä»¶èµ„æºï¼Œæ€§èƒ½è¾ƒå¼±
- åŒæ ·é…ç½®çš„å®¿ä¸»æœºï¼Œæœ€å¤šå¯ä»¥å¯åŠ¨10ä¸ªè™šæ‹Ÿæœºçš„è¯ï¼Œå¯ä»¥å¯åŠ¨100+çš„å®¹å™¨æ•°é‡ã€‚
- å¯åŠ¨ä¸€ä¸ªKVMè™šæ‹Ÿæœºï¼Œå¾—æœ‰ä¸€ä¸ªå®Œæ•´çš„å¼€æœºæµç¨‹ï¼ŒèŠ±è´¹æ—¶é—´è¾ƒé•¿ï¼Œæˆ–è®¸å¾—20Sï¼Œè€Œå¯åŠ¨ä¸€ä¸ªå®¹å™¨åªéœ€è¦1Sã€‚
- KVMéœ€è¦ç¡¬ä»¶CPUçš„è™šæ‹ŸåŒ–æ”¯æŒï¼Œè€Œå®¹å™¨ä¸éœ€è¦ã€‚

## ä¸ºä»€ä¹ˆé€‰æ‹©docker

### dockeræ›´é«˜æ•ˆçš„åˆ©ç”¨ç³»ç»Ÿèµ„æº

å®¹å™¨ä¸éœ€è¦è¿›è¡Œç¡¬ä»¶è™šæ‹ŸåŒ–ä»¥åŠè¿è¡Œä¸€ä¸ªå®Œæ•´æ“ä½œç³»ç»Ÿçš„é¢å¤–å¼€é”€ï¼Œdockerå¯¹ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨ç‡æ›´é«˜ï¼Œæ— è®ºæ˜¯åº”ç”¨æ‰§è¡Œï¼Œæ–‡ä»¶å­˜å‚¨ï¼Œè¿˜æ˜¯åœ¨å†…å­˜æ¶ˆè€—ç­‰æ–¹é¢ï¼Œéƒ½æ¯”ä¼ ç»Ÿè™šæ‹Ÿæœºæ›´é«˜æ•ˆã€‚å› æ­¤ä¸€ä¸ªåŒæ ·é…ç½®çš„ä¸»æœºï¼Œå¯ä»¥è¿è¡Œå¤„æ›´å¤šæ•°é‡çš„å®¹å™¨å®ä¾‹ã€‚

### æ›´å¿«çš„å¯åŠ¨æ—¶é—´

ä¼ ç»Ÿçš„è™šæ‹Ÿæœºå¯åŠ¨æ—¶é—´è¾ƒä¹…ï¼Œdockerå®¹å™¨ç›´æ¥è¿è¡Œåœ¨å®¿ä¸»æœºçš„å†…æ ¸ä¸Šï¼Œæ— é¡»å¯åŠ¨ä¸€ä¸ªå®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œå› æ­¤å¯ä»¥è¾¾åˆ°ç§’çº§å¯åŠ¨ï¼Œå¤§å¤§çš„è§£å†³å¼€å‘ï¼Œæµ‹è¯•ï¼Œéƒ¨ç½²çš„æ—¶é—´ã€‚

### ä¸€è‡´æ€§çš„ç¯å¢ƒ

åœ¨ä¼ä¸šé‡Œï¼Œç¨‹åºä»å¼€å‘ç¯å¢ƒï¼Œåˆ°æµ‹è¯•æœåŠ¡å™¨ï¼Œåˆ°ç”Ÿäº§ç¯å¢ƒï¼Œéš¾ä»¥ä¿è¯æœºå™¨ç¯å¢ƒä¸€è‡´æ€§ï¼Œæå¤§å¯èƒ½å‡ºç°ç³»ç»Ÿä¾èµ–å†²çªï¼Œå¯¼è‡´éš¾ä»¥éƒ¨ç½²ç­‰Bugã€‚

ç„¶è€Œåˆ©ç”¨dockerçš„å®¹å™¨-é•œåƒæŠ€æœ¯ï¼Œæä¾›äº†é™¤äº†å†…æ ¸ä»¥å¤–å®Œæ•´çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œç¡®ä¿äº†åº”ç”¨ç¯å¢ƒçš„ä¸€è‡´æ€§ã€‚

### æŒç»­äº¤ä»˜å’Œéƒ¨ç½²

è¿˜æ˜¯åˆšæ‰æ‰€è¯´çš„ä¸€è‡´æ€§çš„ç¯å¢ƒï¼Œå¯¹äºå¼€å‘å’Œè¿ç»´çš„äººå‘˜ï¼Œæœ€å¸Œæœ›çš„å°±æ˜¯ç¯å¢ƒéƒ¨ç½²è¿ç§»åˆ«å¤„é—®é¢˜ï¼Œåˆ©ç”¨dockerå¯ä»¥å®šåˆ¶é•œåƒï¼Œä»¥è¾¾åˆ°æŒç»­é›†æˆï¼ŒæŒç»­äº¤ä»˜å’Œéƒ¨ç½²ã€‚

é€šè¿‡Dockerfileæ¥è¿›è¡Œé•œåƒæ„å»ºï¼Œå®ç°ç³»ç»Ÿé›†æˆæµ‹è¯•ï¼Œè¿ç»´è¿›è¡Œç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²ã€‚

ä¸”Dockerfileå¯ä»¥ä½¿é•œåƒæ„å»ºé€æ˜åŒ–ï¼Œæ–¹ä¾¿æŠ€æœ¯å›¢é˜Ÿèƒ½å¤Ÿå¿«é€Ÿç†è§£è¿è¡Œç¯å¢ƒéƒ¨ç½²æµç¨‹ã€‚

### æ›´è½»æ¾çš„è¿ç§»

Dockerå¯ä»¥åœ¨å¾ˆå¤šå¹³å°è¿è¡Œï¼Œæ— è®ºæ˜¯ç‰©ç†æœºï¼Œè™šæ‹Ÿæœºï¼Œäº‘æœåŠ¡å™¨ç­‰ç¯å¢ƒï¼Œè¿è¡Œç»“æœéƒ½æ˜¯ä¸€è‡´çš„ã€‚ç”¨äºå¯ä»¥è½»æ¾çš„å°†ä¸€ä¸ªå¹³å°çš„åº”ç”¨ï¼Œè¿ç§»åˆ°å¦ä¸€ä¸ªå¹³å°ï¼Œè€Œä¸ç”¨æ‹…å¿ƒç¯å¢ƒçš„å˜åŒ–ï¼Œå¯¼è‡´ç¨‹åºæ— æ³•è¿è¡Œã€‚

# Docker VS ä¼ ç»Ÿè™šæ‹Ÿæœº

| ç‰¹æ€§       | å®¹å™¨               | è™šæ‹Ÿæœº     |
| ---------- | ------------------ | ---------- |
| å¯åŠ¨       | ç§’çº§               | åˆ†é’Ÿçº§     |
| ç¡¬ç›˜ä½¿ç”¨   | ä¸€èˆ¬ä¸º MB          | ä¸€èˆ¬ä¸º GB  |
| æ€§èƒ½       | æ¥è¿‘åŸç”Ÿ           | å¼±         |
| ç³»ç»Ÿæ”¯æŒé‡ | å•æœºæ”¯æŒä¸Šåƒä¸ªå®¹å™¨ | ä¸€èˆ¬å‡ åä¸ª |

# Dockerä½¿ç”¨æƒ…å†µ

![img](äº‘è®¡ç®—.assets/1610861972998-e3581a9c-ef78-4f76-9fad-b15d3e542e51.png)

## ä¼ä¸šä¸å®¹å™¨é›†ç¾¤

### äº¬ä¸œå®¹å™¨é›†ç¾¤

![img](äº‘è®¡ç®—.assets/1610861972986-7c5df704-2691-48ee-a553-540b88c9acb0.png)

æ¶æ„å›¾

![img](äº‘è®¡ç®—.assets/1610861972978-bd2a7b9f-9a93-4ec1-9ebd-7db27ea24ac0.png)

### æ·˜å®å®¹å™¨é›†ç¾¤

![img](äº‘è®¡ç®—.assets/1610861972984-3b2c13b3-c7e9-4239-9f5c-42f5d6bdb8a7.png)

![img](äº‘è®¡ç®—.assets/1610861972995-de036d25-8088-477b-ad56-8b32bdcbeb1c.png)

é˜¿é‡Œæˆç«‹ä¸“é—¨çš„é¡¹ç›®ç»„æ¨è¿›dockeråº”ç”¨ï¼Œç›®æ ‡æ˜¯æŠŠåŒ11æµé‡è¦†ç›–çš„æ ¸å¿ƒåº”ç”¨ï¼Œå…¨éƒ¨å‡çº§ä¸ºé•œåƒåŒ–çš„Dockeråº”ç”¨ã€‚

# Dockerå®‰è£…éƒ¨ç½²

## Dockerå¼•æ“

Docker Engineæ˜¯C/Sæ¶æ„çš„

![img](äº‘è®¡ç®—.assets/1610861973012-b75c016a-1001-4845-a09e-fbedd153c55f.png)

Dockerç”±å·²ä¸‹å‡ ä¸ªéƒ¨ä»¶ç»„æˆã€‚

### Docker Daemon

å®‰è£…ä½¿ç”¨Dockerï¼Œå¾—å…ˆè¿è¡ŒDocker Daemonè¿›ç¨‹ï¼Œç”¨äºç®¡ç†dockerï¼Œå¦‚ï¼š

- é•œåƒ images
- å®¹å™¨ containers
- ç½‘ç»œ network
- æ•°æ®å· Data Volumes

### Restæ¥å£

æä¾›å’ŒDaemonäº¤äº’çš„APIæ¥å£

### Docker Client

å®¢æˆ·ç«¯ä½¿ç”¨REST APIå’ŒDocker Daemonè¿›è¡Œè®¿é—®ã€‚

## Dockerå¹³å°ç»„æˆ

![img](äº‘è®¡ç®—.assets/1610861973001-0eb43258-778f-4b99-8cb3-f204aa0e60af.png)

### Images

é•œåƒæ˜¯ä¸€ä¸ªåªè¯»æ¨¡æ¿ï¼Œç”¨äºåˆ›å»ºå®¹å™¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡Dockerfileæ–‡æœ¬æè¿°é•œåƒçš„å†…å®¹ã€‚

é•œåƒçš„æ¦‚å¿µç±»ä¼¼äºç¼–ç¨‹å¼€å‘é‡Œé¢å‘å¯¹è±¡çš„ç±»ï¼Œä»ä¸€ä¸ªåŸºç±»å¼€å§‹ï¼ˆåŸºç¡€é•œåƒBase Imageï¼‰

æ„å»ºå®¹å™¨çš„è¿‡ç¨‹ï¼Œå°±æ˜¯è¿è¡Œé•œåƒï¼Œç”Ÿæˆå®¹å™¨å®ä¾‹ã€‚

Dockeré•œåƒçš„æè¿°æ–‡ä»¶æ˜¯Dockerfileï¼ŒåŒ…å«äº†å¦‚ä¸‹çš„æŒ‡ä»¤

- FROM å®šä¹‰åŸºç¡€é•œåƒ
- MAINTAINER ä½œè€…
- RUN è¿è¡ŒLinuxå‘½ä»¤
- ADD æ·»åŠ æ–‡ä»¶/ç›®å½•
- ENV ç¯å¢ƒå˜é‡
- CMD è¿è¡Œè¿›ç¨‹

### Container

å®¹å™¨æ˜¯ä¸€ä¸ªé•œåƒçš„è¿è¡Œå®ä¾‹ï¼Œé•œåƒ > å®¹å™¨ã€‚

åˆ›å»ºå®¹å™¨çš„è¿‡ç¨‹

- è·å–é•œåƒï¼Œå¦‚`docker pull centos`ï¼Œä»é•œåƒä»“åº“æ‹‰å–
- ä½¿ç”¨é•œåƒåˆ›å»ºå®¹å™¨
- åˆ†é…æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‚è½½ä¸€ä¸ªè¯»å†™å±‚ï¼Œåœ¨è¯»å†™å±‚åŠ è½½é•œåƒ
- åˆ†é…ç½‘ç»œ/ç½‘æ¡¥æ¥å£ï¼Œåˆ›å»ºä¸€ä¸ªç½‘ç»œæ¥å£ï¼Œè®©å®¹å™¨å’Œå®¿ä¸»æœºé€šä¿¡
- å®¹å™¨è·å–IPåœ°å€
- æ‰§è¡Œå®¹å™¨å‘½ä»¤ï¼Œå¦‚/bin/bash
- åé¦ˆå®¹å™¨å¯åŠ¨ç»“æœã€‚

## Registry

Dockeré•œåƒéœ€è¦è¿›è¡Œç®¡ç†ï¼Œdockeræä¾›äº†Registryä»“åº“ï¼Œå…¶å®å®ƒä¹Ÿæ˜¯ä¸€ä¸ªå®¹å™¨ã€‚å¯ä»¥ç”¨äºå¯ä»¥åŸºäºè¯¥å®¹å™¨è¿è¡Œç§æœ‰ä»“åº“ã€‚

ä¹Ÿå¯ä»¥ä½¿ç”¨Docker Hubäº’è”ç½‘å…¬æœ‰é•œåƒä»“åº“ã€‚

## å®‰è£…Docker

![img](äº‘è®¡ç®—.assets/1610861973345-f9d7634c-6bfc-48dc-a747-ed3bdad5eeb0.png)

æœºå™¨ç¯å¢ƒåˆå§‹åŒ–

```plain
1.é˜²ç«å¢™
2.yumæº
3.å®‰è£…åŸºç¡€è½¯ä»¶
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
yum install -y bash-completion vim lrzsz wget expect net-tools nc nmap tree dos2unix htop iftop iotop unzip telnet sl psmisc nethogs glances bc ntpdate  openldap-devel
[root@docker01 ~]# systemctl disable firewalld
Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.
Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.
[root@docker01 ~]# systemctl stop firewalld
[root@docker01 ~]# sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
[root@docker01 ~]# iptables -F
[root@docker01 ~]#
[root@docker01 ~]# iptables -X
[root@docker01 ~]#
[root@docker01 ~]# iptables -Z
[root@docker01 ~]# iptables-save
# Generated by iptables-save v1.4.21 on Fri Sep  4 01:29:08 2020
*filter
:INPUT ACCEPT [25:1732]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [13:1208]
COMMIT
# Completed on Fri Sep  4 01:29:08 2020
```

## docker01æœºå™¨å‡†å¤‡

```plain
1.dockerå¿…é¡»å®‰è£…åœ¨centos7å¹³å°ï¼Œå†…æ ¸ç‰ˆæœ¬ä¸ä½äº3.10
åœ¨centoså¹³å°è¿è¡Œdockerå¯èƒ½ä¼šé‡è§äº›å‘Šè­¦ä¿¡æ¯ï¼Œä¿®æ”¹å†…æ ¸é…ç½®å‚æ•°ï¼Œæ‰“å¼€å†…æ ¸è½¬å‘åŠŸèƒ½
vim /etc/sysctl.conf
# å†™å…¥å‚æ•°
# Controls IP packet forwarding
net.ipv4.ip_forward = 1
#
# # Controls source route verification
net.ipv4.conf.default.rp_filter = 0
#
net.ipv4.conf.all.rp_filter = 0
2.é‡æ–°åŠ è½½å†…æ ¸å‚æ•°
[root@docker01 ~]# sysctl -p
net.ipv4.ip_forward = 1
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.all.rp_filter = 0
# è¦ä¿æŒæœ¬åœ°è½¯ä»¶æºè¾ƒæ–°ï¼Œå¯ä»¥ç”¨é˜¿é‡Œäº‘yumæºæ›´æ–°è½¯ä»¶
3.å®‰è£…docker-ceç¤¾åŒºç‰ˆ
wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo
sed -i 's#download.docker.com#mirrors.ustc.edu.cn/docker-ce#g' /etc/yum.repos.d/docker-ce.repo
yum install docker-ce -y
```

## é•œåƒåŠ é€Ÿå™¨

ä½¿ç”¨dockeré¦–è¦æ“ä½œå°±æ˜¯è·å–é•œåƒæ–‡ä»¶ï¼Œé»˜è®¤ä¸‹è½½æ˜¯ä»Docker Hubä¸‹è½½ï¼Œç½‘é€Ÿè¾ƒæ…¢ï¼Œå›½å†…å¾ˆå¤šäº‘æœåŠ¡å•†éƒ½æä¾›äº†åŠ é€Ÿå™¨æœåŠ¡ï¼Œé˜¿é‡Œäº‘åŠ é€Ÿå™¨ï¼ŒDaocloudåŠ é€Ÿå™¨ï¼Œçµé›€äº‘åŠ é€Ÿå™¨ã€‚

```plain
1.ä¿®æ”¹dockeré…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬é€‰ç”¨ä¸ƒç‰›äº‘é•œåƒç«™
[root@docker01 ~]# cat /etc/docker/daemon.json
{"registry-mirrors": ["https://reg-mirror.qiniu.com"]}
2.é‡å¯
[root@docker01 ~]# systemctl restart docker
```

## dockerç®¡ç†

```plain
1.æ£€æŸ¥æœåŠ¡çŠ¶æ€
[root@docker01 ~]# docker version
Client: Docker Engine - Community
 Version:           19.03.12
 API version:       1.40
 Go version:        go1.13.10
 Git commit:        48a66213fe
 Built:             Mon Jun 22 15:46:54 2020
 OS/Arch:           linux/amd64
 Experimental:      false
Server: Docker Engine - Community
 Engine:
  Version:          19.03.12
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.13.10
  Git commit:       48a66213fe
  Built:            Mon Jun 22 15:45:28 2020
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.2.13
  GitCommit:        7ad184331fa3e55e52b890ea95e65ba581ae3429
 runc:
  Version:          1.0.0-rc10
  GitCommit:        dc9208a3303feef5b3839f4323d9beb36df0a9dd
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683
2.æ£€æŸ¥ç³»ç»Ÿå†…æ ¸
[root@docker01 ~]# uname -a
Linux docker01 3.10.0-862.el7.x86_64 #1 SMP Fri Apr 20 16:44:24 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
3.æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å®‰è£…äº†å­˜å‚¨é©±åŠ¨ï¼Œçœ‹åˆ°ç»“æœå³å¯
[root@docker01 ~]# ls -l /sys/class/misc/device-mapper/
total 0
-r--r--r-- 1 root root 4096 Sep  4 01:44 dev
drwxr-xr-x 2 root root    0 Sep  4 01:44 power
lrwxrwxrwx 1 root root    0 Sep  4 01:44 subsystem -> ../../../../class/misc
-rw-r--r-- 1 root root 4096 Sep  4 01:44 uevent
# è‹¥æ˜¯æ²¡æœ‰ï¼Œå•ç‹¬å®‰è£…å³å¯
[root@docker01 ~]# yum install device-mapper -y
# åŠ è½½å­˜å‚¨é©±åŠ¨æ¨¡å—
[root@docker01 ~]# modprobe dm-mod
```

## å¯åŠ¨ç¬¬ä¸€ä¸ªå®¹å™¨

```plain
1.è·å–nginxé•œåƒ
[root@docker01 ~]# docker run -d -p 80:80 nginx
Unable to find image 'nginx:latest' locally
latest: Pulling from library/nginx
bf5952930446: Pulling fs layer
cb9a6de05e5a: Pulling fs layer
9513ea0afb93: Pulling fs layer
b49ea07d2e93: Waiting
a5e4a503d449: Waiting
latest: Pulling from library/nginx
bf5952930446: Pull complete
cb9a6de05e5a: Pull complete
9513ea0afb93: Pull complete
b49ea07d2e93: Pull complete
a5e4a503d449: Pull complete
Digest: sha256:b0ad43f7ee5edbc0effbc14645ae7055e21bc1973aee5150745632a24a752661
Status: Downloaded newer image for nginx:latest
e1238321422cd13b4b217d5d955e67eac4766765a8edb201308c37c178a22ccc
# å‚æ•°è§£é‡Š
docker run å‚æ•°     é•œåƒ
-d åå°è¿è¡Œ
-p ç«¯å£æ˜ å°„
nginx é•œåƒå
é»˜è®¤æˆ‘ä»¬æœºå™¨ä¸Šæ˜¯æ²¡æœ‰dockeré•œåƒçš„ï¼Œdocker runæ˜¯åœ¨è¿è¡Œæ—¶ï¼Œå¯»æ‰¾ä¸”è‡ªåŠ¨ä¸‹è½½é•œåƒ
2.æ£€æŸ¥æœåŠ¡å™¨ä¸Šæ‰€æœ‰é•œåƒ
[root@docker01 ~]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
nginx               latest              4bb46517cac3        2 weeks ago         133MB
3.æ£€æŸ¥æ­£åœ¨è¿è¡Œçš„dockerå®¹å™¨
[root@docker01 ~]# docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                NAMES
e1238321422c        nginx               "/docker-entrypoint.â€¦"   About a minute ago   Up About a minute   0.0.0.0:80->80/tcp   ecstatic_gould
4.è®¿é—®å®¹å™¨å†…çš„nginxæœåŠ¡
```

![img](äº‘è®¡ç®—.assets/1610861973010-12baa02d-a0d4-409a-9588-72260369d1a0.png)

çœ‹åˆ°è¿™ä¸ªé¡µé¢ï¼Œå°±è¯´æ˜ä½ æ­£ç¡®å®‰è£…äº†dockerï¼Œä¸”è¿è¡Œäº†ç¬¬ä¸€ä¸ªnginxå®¹å™¨æœåŠ¡ã€‚

# Dockerç”Ÿå‘½å‘¨æœŸ

![img](äº‘è®¡ç®—.assets/1610861973034-9149a8cc-6b3b-4022-9cc6-853b0bf6d93c.png)

## Dockeré•œåƒç®¡ç†

ä¸€ä¸ªå®Œæˆçš„Dockeré•œåƒå¯ä»¥æ”¯æ’‘å®¹å™¨çš„è¿è¡Œï¼Œé•œåƒæä¾›æ–‡ä»¶ç³»ç»Ÿ

```plain
# ä¸‹è½½centosç³»ç»Ÿé•œåƒ
[root@docker01 ~]# docker pull centos
```

## å†…æ ¸ä¸å‘è¡Œç‰ˆ

ä¼ ç»Ÿçš„è™šæ‹Ÿæœºå®‰è£…æ“ä½œç³»ç»Ÿæ‰€æä¾›çš„ç³»ç»Ÿé•œåƒï¼ŒåŒ…å«ä¸¤éƒ¨åˆ†ï¼š

- Linuxå†…æ ¸ç‰ˆæœ¬ï¼Œä¾‹å¦‚

```plain
[root@docker01 ~]# uname -r
3.10.0-862.el7.x86_64
```

- ç³»ç»Ÿå‘è¡Œç‰ˆæœ¬ï¼ˆcentosï¼Œubuntuï¼‰

```plain
[root@docker01 ~]# cat /etc/redhat-release
CentOS Linux release 7.5.1804 (Core)
```

è€Œdockeré•œåƒï¼š

dockeré•œåƒæ˜¯ä¸åŒ…å«ç³»ç»Ÿå†…æ ¸çš„ï¼Œä¸‹è½½çš„æ˜¯æŸä¸€ä¸ªå‘è¡Œç‰ˆã€‚

ä¾‹å¦‚

```plain
# è·å–centos7.5å‘è¡Œç‰ˆæœ¬
[root@docker01 ~]# docker search centos:7.5
# è·å–mysql5.6
[root@docker01 ~]# docker search mysql:5.6
```

## dockeré•œåƒå®šä¹‰

æˆ‘ä»¬å¦‚æœè‡ªå®šä¹‰é•œåƒï¼Œåˆšæ‰è¶…å“¥å·²ç»å’Œå¤§å®¶è¯´äº†ï¼Œdockeré•œåƒä¸åŒ…å«linuxå†…æ ¸ï¼Œå’Œå®¿ä¸»æœºå…±ç”¨ã€‚

æˆ‘ä»¬å¦‚æœæƒ³è¦å®šä¹‰ä¸€ä¸ªmysql5.6é•œåƒï¼Œæˆ‘ä»¬ä¼šè¿™ä¹ˆåš

- è·å–åŸºç¡€é•œåƒï¼Œé€‰æ‹©ä¸€ä¸ªå‘è¡Œç‰ˆå¹³å°ï¼ˆubutuï¼Œcentosï¼‰
- åœ¨centosé•œåƒä¸­å®‰è£…mysql5.6è½¯ä»¶

å¯¼å‡ºé•œåƒï¼Œå¯ä»¥å‘½åä¸ºmysql:5.6é•œåƒæ–‡ä»¶ã€‚

ä»è¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æ„Ÿè§‰å‡ºè¿™æ˜¯ä¸€å±‚ä¸€å±‚çš„æ·»åŠ çš„ï¼Œdockeré•œåƒçš„å±‚çº§æ¦‚å¿µå°±å‡ºæ¥äº†ï¼Œåº•å±‚æ˜¯centosé•œåƒï¼Œä¸Šå±‚æ˜¯mysqlé•œåƒï¼Œcentosé•œåƒå±‚å±äºçˆ¶é•œåƒã€‚

![img](äº‘è®¡ç®—.assets/1610861973023-5b7198c2-9beb-4f3e-be8a-5911c6126825.png)

Dockeré•œåƒæ˜¯åœ¨åŸºç¡€é•œåƒä¹‹åï¼Œç„¶åå®‰è£…è½¯ä»¶ï¼Œé…ç½®è½¯ä»¶ï¼Œæ·»åŠ æ–°çš„å±‚ï¼Œæ„å»ºå‡ºæ¥ã€‚

è¿™ç§ç°è±¡åœ¨å­¦ä¹ dockerfileæ„å»ºæ—¶å€™ï¼Œæ›´ä¸ºæ¸…æ™°ã€‚

## Dockerä¸ºä»€ä¹ˆåˆ†å±‚é•œåƒ

é•œåƒåˆ†äº«ä¸€å¤§å¥½å¤„å°±æ˜¯å…±äº«èµ„æºï¼Œä¾‹å¦‚æœ‰å¤šä¸ªé•œåƒéƒ½æ¥è‡ªäºåŒä¸€ä¸ªbaseé•œåƒï¼Œé‚£ä¹ˆåœ¨docker hoståªéœ€è¦å­˜å‚¨ä¸€ä»½baseé•œåƒã€‚

å†…å­˜é‡Œä¹Ÿåªéœ€è¦åŠ è½½ä¸€ä»½hostï¼Œå³å¯ä¸ºå¤šä¸ªå®¹å™¨æœåŠ¡ã€‚

å³ä½¿å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªbaseé•œåƒï¼ŒæŸä¸ªå®¹å™¨ä¿®æ”¹äº†baseé•œåƒçš„å†…å®¹ï¼Œä¾‹å¦‚ä¿®æ”¹/etc/ä¸‹é…ç½®æ–‡ä»¶ï¼Œå…¶ä»–å®¹å™¨çš„/etc/ä¸‹å†…å®¹æ˜¯ä¸ä¼šè¢«ä¿®æ”¹çš„ï¼Œä¿®æ”¹åŠ¨ä½œåªé™åˆ¶åœ¨å•ä¸ªå®¹å™¨å†…ï¼Œè¿™å°±æ˜¯å®¹å™¨çš„å†™å…¥æ—¶å¤åˆ¶ç‰¹æ€§ï¼ˆCopy-on-writeï¼‰ã€‚

### å¯å†™çš„å®¹å™¨å±‚

å½“å®¹å™¨å¯åŠ¨åï¼Œä¸€ä¸ªæ–°çš„å¯å†™å±‚è¢«åŠ è½½åˆ°é•œåƒçš„é¡¶éƒ¨ï¼Œè¿™ä¸€å±‚é€šå¸¸è¢«ç§°ä¸º`å®¹å™¨å±‚`ï¼Œ`å®¹å™¨å±‚`ä¸‹çš„éƒ½ç§°ä¸º`é•œåƒå±‚`ã€‚

![img](äº‘è®¡ç®—.assets/1610861973027-2a9f700b-5e44-4233-9aa8-bbcf12524ab9.png)

æ‰€æœ‰å¯¹å®¹å™¨çš„ä¿®æ”¹åŠ¨ä½œï¼Œéƒ½åªä¼šå‘ç”Ÿåœ¨`å®¹å™¨å±‚`é‡Œï¼Œåªæœ‰`å®¹å™¨å±‚`æ˜¯å¯å†™çš„ï¼Œå…¶ä½™`é•œåƒå±‚`éƒ½æ˜¯åªè¯»çš„ã€‚

| **æ–‡ä»¶æ“ä½œ** | **è¯´æ˜**                                                     |
| ------------ | ------------------------------------------------------------ |
| **æ·»åŠ æ–‡ä»¶** | åœ¨å®¹å™¨ä¸­åˆ›å»ºæ–‡ä»¶æ—¶ï¼Œæ–°æ–‡ä»¶è¢«æ·»åŠ åˆ°å®¹å™¨å±‚ä¸­ã€‚                 |
| **è¯»å–æ–‡ä»¶** | åœ¨å®¹å™¨ä¸­è¯»å–æŸä¸ªæ–‡ä»¶æ—¶ï¼ŒDocker ä¼šä»ä¸Šå¾€ä¸‹ä¾æ¬¡åœ¨å„é•œåƒå±‚ä¸­æŸ¥æ‰¾æ­¤æ–‡ä»¶ã€‚ä¸€æ—¦æ‰¾åˆ°ï¼Œç«‹å³å°†å…¶å¤åˆ¶åˆ°å®¹å™¨å±‚ï¼Œç„¶åæ‰“å¼€å¹¶è¯»å…¥å†…å­˜ã€‚ |
| **ä¿®æ”¹æ–‡ä»¶** | åœ¨å®¹å™¨ä¸­ä¿®æ”¹å·²å­˜åœ¨çš„æ–‡ä»¶æ—¶ï¼ŒDocker ä¼šä»ä¸Šå¾€ä¸‹ä¾æ¬¡åœ¨å„é•œåƒå±‚ä¸­æŸ¥æ‰¾æ­¤æ–‡ä»¶ã€‚ä¸€æ—¦æ‰¾åˆ°ï¼Œç«‹å³å°†å…¶å¤åˆ¶åˆ°å®¹å™¨å±‚ï¼Œç„¶åä¿®æ”¹ä¹‹ã€‚ |
| **åˆ é™¤æ–‡ä»¶** | åœ¨å®¹å™¨ä¸­åˆ é™¤æ–‡ä»¶æ—¶ï¼ŒDocker ä¹Ÿæ˜¯ä»ä¸Šå¾€ä¸‹ä¾æ¬¡åœ¨é•œåƒå±‚ä¸­æŸ¥æ‰¾æ­¤æ–‡ä»¶ã€‚æ‰¾åˆ°åï¼Œä¼šåœ¨å®¹å™¨å±‚ä¸­**è®°å½•ä¸‹æ­¤åˆ é™¤æ“ä½œ**ã€‚ï¼ˆåªæ˜¯è®°å½•åˆ é™¤æ“ä½œï¼‰ |

åªæœ‰å½“éœ€è¦ä¿®æ”¹æ—¶æ‰å¤åˆ¶ä¸€ä»½æ•°æ®ï¼Œè¿™ç§ç‰¹æ€§è¢«ç§°ä½œ Copy-on-Writeã€‚å¯è§ï¼Œå®¹å™¨å±‚ä¿å­˜çš„æ˜¯é•œåƒå˜åŒ–çš„éƒ¨åˆ†ï¼Œä¸ä¼šå¯¹é•œåƒæœ¬èº«è¿›è¡Œä»»ä½•ä¿®æ”¹ã€‚

è¿™æ ·å°±è§£é‡Šäº†æˆ‘ä»¬å‰é¢æå‡ºçš„é—®é¢˜ï¼šå®¹å™¨å±‚è®°å½•å¯¹é•œåƒçš„ä¿®æ”¹ï¼Œæ‰€æœ‰é•œåƒå±‚éƒ½æ˜¯åªè¯»çš„ï¼Œä¸ä¼šè¢«å®¹å™¨ä¿®æ”¹ï¼Œæ‰€ä»¥é•œåƒå¯ä»¥è¢«å¤šä¸ªå®¹å™¨å…±äº«ã€‚

## Dockeré•œåƒçš„å†…å®¹

dockeré•œåƒå±‚çº§ç®¡ç†çš„æ–¹å¼å¤§å¤§ä¾¿æ·äº†Dockeré•œåƒçš„åˆ†å‘å’Œå­˜å‚¨ã€‚Docker hubæ˜¯ä¸ºå…¨ä¸–ç•Œçš„é•œåƒä»“åº“ã€‚

- Dockeré•œåƒä»£è¡¨ä¸€ä¸ªå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿå†…å®¹
- é•œåƒå±‚çº§æŠ€æœ¯å±äº`è”åˆæ–‡ä»¶ç³»ç»Ÿ`
- å®¹å™¨æ˜¯ä¸€ä¸ªåŠ¨æ€çš„ç¯å¢ƒï¼Œæ¯ä¸€å±‚é•œåƒé‡Œçš„æ–‡ä»¶éƒ½å±äºé™æ€å†…å®¹

- - dockerfileé‡Œçš„ENVã€VOLUMEã€CMDç­‰å†…å®¹éƒ½ä¼šè½å®åˆ°å®¹å™¨ç¯å¢ƒé‡Œ

### UnionFS

![img](äº‘è®¡ç®—.assets/1610861973085-28b3b710-3c3a-429e-99d0-6e9a65274fd9.png)

## è·å–Dockeré•œåƒ

```plain
1.è·å–é•œåƒï¼Œdocker hubé‡Œæœ‰å¤§é‡é«˜è´¨é‡çš„é•œåƒ
[root@docker01 ~]# docker pull centos  # é»˜è®¤æ ‡ç­¾tagæ˜¯centos:latest
[root@docker01 ~]# docker pull  centos:7.2.1511  # æŒ‡å®šç‰ˆæœ¬ä¸‹è½½
2.æŸ¥çœ‹æ‰€æœ‰é•œåƒ
[root@docker01 ~]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
nginx               latest              4bb46517cac3        3 weeks ago         133MB
centos              latest              0d120b6ccaa8        3 weeks ago         215MB
centos              7.2.1511            9aec5c5fe4ba        17 months ago       195MB
3.dockeræœ¬åœ°é•œåƒï¼Œéƒ½æ”¾åœ¨
[root@docker01 ~]# ll /var/lib/docker/
total 4
drwx------  2 root root   24 Sep  4 01:37 builder
drwx--x--x  4 root root   92 Sep  4 01:37 buildkit
drwx------  2 root root    6 Sep  4 19:08 containers
drwx------  3 root root   22 Sep  4 01:37 image
drwxr-x---  3 root root   19 Sep  4 01:37 network
drwx------ 10 root root 4096 Sep  4 19:08 overlay2
drwx------  4 root root   32 Sep  4 01:37 plugins
drwx------  2 root root    6 Sep  4 19:05 runtimes
drwx------  2 root root    6 Sep  4 01:37 swarm
drwx------  2 root root    6 Sep  4 19:06 tmp
drwx------  2 root root    6 Sep  4 01:37 trust
drwx------  2 root root   25 Sep  4 01:37 volumes
# å¯ä»¥é€šè¿‡docker infoæŸ¥çœ‹
[root@docker01 docker]# docker info | grep "Docker Root Dir"
 Docker Root Dir: /var/lib/docker
# æ‰€æœ‰é•œåƒå­˜å‚¨çš„ä½ç½®
[root@docker01 sha256]# pwd
/var/lib/docker/image/overlay2/imagedb/content/sha256
# è¯¥ç›®å½•éƒ½æ˜¯jsonæ–‡ä»¶ï¼Œè®°å½•é•œåƒå’Œå®¹å™¨çš„å…³ç³»
[root@docker01 sha256]# ll
total 16
-rw------- 1 root root 2180 Sep  4 02:00 0d120b6ccaa8c5e149176798b3501d4dd1885f961922497cd0abef155c869566
-rw------- 1 root root 7512 Sep  4 01:48 4bb46517cac397bdb0bab6eba09b0e1f8e90ddd17cf99662997c3253531136f8
-rw------- 1 root root 2604 Sep  4 19:06 9aec5c5fe4ba9cf7a8d2a50713dd197c3b0cbd5f5fcd03babe4c1d65c455dabf
4.è¿è¡Œé•œåƒï¼Œä»¥æŸä¸€ä¸ªbaseé•œåƒæ¥å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå‚æ•°è§£é‡Š
-i
-t
--rm
bash
[root@docker01 ~]# docker run -it --rm centos:7.2.1511 bash
[root@ade0c7e6bb85 /]#
[root@ade0c7e6bb85 /]#
[root@ade0c7e6bb85 /]# cat /etc/redhat-release
CentOS Linux release 7.2.1511 (Core)
5.è¿è¡Œcentos8å®¹å™¨
[root@docker01 ~]# docker run -it --rm  centos:latest bash
[root@1f2b4e7eb18c /]# cat /etc/redhat-release
CentOS Linux release 8.2.2004 (Core)
6.é€€å‡ºå®¹å™¨
[root@1f2b4e7eb18c /]# exit
exit
[root@docker01 ~]#
7.centosæ”¯æŒä¸‹è½½çš„é•œåƒæ ‡ç­¾åˆ—è¡¨
https://hub.docker.com/_/centos
```

### é•œåƒæ“ä½œç®¡ç†

```plain
1.æŸ¥è¯¢é•œåƒ
[root@docker01 ~]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
nginx               latest              4bb46517cac3        3 weeks ago         133MB
centos              latest              0d120b6ccaa8        3 weeks ago         215MB
centos              7.2.1511            9aec5c5fe4ba        17 months ago       195MB
åˆ—è¡¨å±•ç¤ºäº†ä»“åº“åï¼Œæ ‡ç­¾ï¼Œé•œåƒIDï¼Œåˆ›å»ºæ—¶é—´ï¼Œå ç”¨ç©ºé—´
2.dockeré•œåƒä½“ç§¯
dockeré•œåƒæ˜¯å¤šå±‚å­˜å‚¨ç»“æ„ï¼Œå¯ä»¥ç»§æ‰¿ï¼Œå¤ç”¨ã€‚å› æ­¤ä¸åŒçš„é•œåƒä¹Ÿä¼šä½¿ç”¨ç›¸åŒçš„base imagesï¼Œä»è€Œä½¿ç”¨äº›å…±åŒçš„å±‚layerã€‚
å› æ­¤dockerä½¿ç”¨è”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œç›¸åŒçš„å±‚åªéœ€è¦ä¿å­˜ä¸€ä»½ï¼Œå®é™…é•œåƒå ç”¨ç¡¬ç›˜ç©ºé—´è¦æ¯”åˆ—è¡¨é•œåƒå°çš„å¤šã€‚
```

### noneé•œåƒ

noneé•œåƒï¼ˆdangline image è™šæ‚¬é•œåƒï¼‰

å‡ºç°noneé•œåƒçš„åŸå› ï¼š

- åœ¨docker hubä¸Šé•œåƒå¦‚æœæ›´æ–°åï¼Œåç§°å˜åŒ–ï¼Œç”¨æˆ·å†docker pullå°±ä¼šå‡ºç°è¯¥æƒ…å†µ
- docker buildæ—¶å€™ï¼Œé•œåƒåé‡å¤ï¼Œä¹Ÿä¼šå¯¼è‡´æ–°æ—§é•œåƒåŒåï¼Œæ—§é•œåƒåç§°è¢«å–æ¶ˆï¼Œå‡ºç°none

### åˆ—å‡ºé•œåƒ

```plain
1.æ ¹æ®ä»“åº“ååˆ—å‡ºé•œåƒ
[root@docker01 ~]# docker images centos
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
centos              latest              0d120b6ccaa8        3 weeks ago         215MB
centos              8.2.2004            831691599b88        2 months ago        215MB
centos              7.2.1511            9aec5c5fe4ba        17 months ago       195MB
2.åˆ—å‡ºåˆ¶å®šé•œåƒ
[root@docker01 ~]# docker images centos:8.2.2004
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
centos              8.2.2004            831691599b88        2 months ago        215MB
3.åˆ—å‡ºç‰¹å®šæ ¼å¼ï¼Œé•œåƒid
-q åªåˆ—å‡ºid 
-q, --quiet           Only show numeric IDs
[root@docker01 ~]# docker images -q
4bb46517cac3
0d120b6ccaa8
831691599b88
9aec5c5fe4ba
4.æ ¼å¼åŒ–è¾“å‡ºä¿¡æ¯
[root@docker01 ~]# docker images --format "{{.ID}}:{{.Repository}}"
4bb46517cac3:nginx
0d120b6ccaa8:centos
831691599b88:centos
9aec5c5fe4ba:centos
# æ ¼å¼åŒ–ç­‰è·æ˜¾ç¤º
[root@docker01 ~]# docker images --format "table {{.ID}}\t{{.Repository}}\t{{.Tag}}"
IMAGE ID            REPOSITORY          TAG
4bb46517cac3        nginx               latest
0d120b6ccaa8        centos              latest
831691599b88        centos              8.2.2004
9aec5c5fe4ba        centos              7.2.1511
```

### æŸ¥æ‰¾é•œåƒ

```plain
1.é»˜è®¤æ˜¯å…ˆåœ¨æœ¬åœ°å¯»æ‰¾é•œåƒï¼Œæ²¡æœ‰å»docker hubæœç´¢
[root@docker01 ~]# docker search centos
NAME                               DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED
centos                             The official build of CentOS.                   6172                [OK]
```

### åˆ é™¤æœ¬åœ°é•œåƒ

```plain
[root@docker01 ~]# docker pull hello-world
Using default tag: latest
latest: Pulling from library/hello-world
0e03bdcc26d7: Pull complete
Digest: sha256:7f0a9f93b4aa3022c3a4c147a449bf11e0941a1fd0bf4a8e6c9408b2600777c5
Status: Downloaded newer image for hello-world:latest
docker.io/library/hello-world:latest
[root@docker01 ~]# docker images hello-world
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
hello-world         latest              bf756fb1ae65        8 months ago        13.3kB
# åˆ é™¤é•œåƒï¼Œå¯ä»¥ç”¨ IDï¼Œåå­—ï¼Œæ‘˜è¦ç­‰
# æ ¹æ®idåˆ é™¤
[root@docker01 ~]# docker rmi bf7
Untagged: hello-world:latest
Untagged: hello-world@sha256:7f0a9f93b4aa3022c3a4c147a449bf11e0941a1fd0bf4a8e6c9408b2600777c5
Deleted: sha256:bf756fb1ae65adf866bd8c456593cd24beb6a0a061dedf42b26a993176745f6b
Deleted: sha256:9c27e219663c25e0f28493790cc0b88bc973ba3b1686355f221c38a36978ac63
# åˆ é™¤é•œåƒå
docker rmi hello-world
```

æ ¹æ®æ‘˜è¦åˆ é™¤

```plain
1.æŸ¥çœ‹æ‘˜è¦
[root@docker01 ~]# docker images --digests
REPOSITORY          TAG                 DIGEST                                                                    IMAGE ID            CREATED             SIZE
nginx               latest              sha256:b0ad43f7ee5edbc0effbc14645ae7055e21bc1973aee5150745632a24a752661   4bb46517cac3        3 weeks ago         133MB
centos              latest              sha256:76d24f3ba3317fa945743bb3746fbaf3a0b752f10b10376960de01da70685fbd   0d120b6ccaa8        3 weeks ago         215MB
centos              8.2.2004            sha256:4062bbdd1bb0801b0aa38e0f83dece70fb7a5e9bce223423a68de2d8b784b43b   831691599b88        2 months ago        215MB
hello-world         latest              sha256:7f0a9f93b4aa3022c3a4c147a449bf11e0941a1fd0bf4a8e6c9408b2600777c5   bf756fb1ae65        8 months ago        13.3kB
centos              7.2.1511            sha256:50cca1e74da4b6a4eb4ade029c8fdd4ee8564776801914d9bd89df8c6344add0   9aec5c5fe4ba        17 months ago       195MB
2.åˆ é™¤æ‘˜è¦
[root@docker01 ~]# docker rmi hello-world@sha256:7f0a9f93b4aa3022c3a4c147a449bf11e0941a1fd0bf4a8e6c9408b2600777c5
Untagged: hello-world@sha256:7f0a9f93b4aa3022c3a4c147a449bf11e0941a1fd0bf4a8e6c9408b2600777c5
```

æ ¹æ®idåˆ é™¤é•œåƒ

```plain
[root@docker01 ~]# docker rmi $(docker images -q hello-world)
Untagged: hello-world:latest
Untagged: hello-world@sha256:7f0a9f93b4aa3022c3a4c147a449bf11e0941a1fd0bf4a8e6c9408b2600777c5
Deleted: sha256:bf756fb1ae65adf866bd8c456593cd24beb6a0a061dedf42b26a993176745f6b
Deleted: sha256:9c27e219663c25e0f28493790cc0b88bc973ba3b1686355f221c38a36978ac63
```

åˆ é™¤æ‰€æœ‰é•œåƒï¼Œå±é™©å‘½ä»¤

```plain
[root@docker01 ~]# docker rmi `docker images -aq`
```

### å¯¼å‡ºé•œåƒ

```plain
[root@docker01 my_docker]# docker image save centos:7.2.1511 > centos-7.2.1511.tgz
[root@docker01 my_docker]# ll -h
total 193M
-rw-r--r-- 1 root root 193M Sep  5 00:30 centos-7.2.1511.tgz
```

### å¯¼å…¥é•œåƒ

```plain
1.åˆ é™¤centos7.2é•œåƒ
2.å¯¼å…¥é•œåƒå‹ç¼©æ–‡ä»¶
[root@docker01 my_docker]# docker image load -i centos-7.2.1511.tgz
a11c91bfd866: Loading layer [==================================================>]    202MB/202MB
Loaded image: centos:7.2.1511
[root@docker01 my_docker]#
```

### æŸ¥çœ‹é•œåƒè¯¦ç»†ä¿¡æ¯

```plain
[root@docker01 my_docker]# docker image inspect 9aec5c5fe4ba
```

## æ‰¹é‡åˆ é™¤noneé•œåƒ

```plain
docker rm `docker ps -aq`
docker rmi $(docker images|grep "none"|awk '{print $3}')
```

# dockerå®¹å™¨ç®¡ç†

### å¯åŠ¨å®¹å™¨

`docker run`ç­‰äºåˆ›å»º+å¯åŠ¨

**æ³¨æ„ï¼šå®¹å™¨å†…çš„è¿›ç¨‹å¿…é¡»å¤„äºå‰å°è¿è¡ŒçŠ¶æ€ï¼Œå¦åˆ™å®¹å™¨å°±ä¼šç›´æ¥é€€å‡º**

æˆ‘ä»¬è¿è¡ŒnginxåŸºç¡€é•œåƒï¼Œæ²¡æœ‰è¿è¡Œä»»ä½•ç¨‹åºï¼Œå› æ­¤å®¹å™¨ç›´æ¥æŒ‚æ‰

```plain
[root@docker01 my_docker]# docker run 9aec5c5fe4ba
[root@docker01 my_docker]# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
[root@docker01 my_docker]# docker ps -a
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES
1741addf17b1        9aec5c5fe4ba        "/bin/bash"         5 seconds ago       Exited (0) 4 seconds ago                       fervent_bell
[root@docker01 my_docker]#
```

### å¯åŠ¨æ´»ç€çš„å®¹å™¨

-d åå°è¿è¡Œå®¹å™¨

-p ç«¯å£æ˜ å°„

```plain
[root@docker01 my_docker]# docker run -d  -p 80:80 nginx
92cca7c78019f6ae39f1e530e8c611c0b15c12bb62f9192431161470b1b27d2c
[root@docker01 my_docker]#
[root@docker01 my_docker]#
[root@docker01 my_docker]# docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                NAMES
92cca7c78019        nginx               "/docker-entrypoint.â€¦"   1 second ago        Up 1 second         0.0.0.0:80->80/tcp   serene_jackson
# æ­¤æ—¶å¯ä»¥æ­£ç¡®è®¿é—®nginxæœåŠ¡ï¼Œ
```

### æŸ¥çœ‹å®¹å™¨ä¿¡æ¯

```plain
[root@docker01 my_docker]# docker container inspect 92c
```

### æŸ¥çœ‹æ‰€æœ‰å®¹å™¨è®°å½•

æ´»ç€çš„

ä»¥åŠæŒ‚æ‰çš„

```plain
[root@docker01 my_docker]# docker ps -a
```

### åœæ­¢å®¹å™¨

```plain
[root@docker01 my_docker]# docker stop 92c
[root@docker01 my_docker]# docker container kill 92c
```

### è¿›å…¥å®¹å™¨ç©ºé—´

1.åˆ›å»ºå®¹å™¨ä¸”è¿›å…¥

```plain
[root@docker01 my_docker]# docker run -it centos bash
[root@0b889f541209 /]#
```

2.execå‘½ä»¤

```plain
[root@docker01 my_docker]# docker exec -it 92c bash
root@92cca7c78019:/#
```

### åˆ é™¤æ‰€æœ‰å®¹å™¨

**å±é™©å‘½ä»¤**

```plain
[root@docker01 my_docker]# docker rm -f `docker ps -aq`
-f å¼ºåˆ¶åˆ é™¤
```

### å®¹å™¨ç«¯å£æ˜ å°„

| **p hostPort:containerPort**      | ç«¯å£æ˜ å°„ -p 8080:80                |
| --------------------------------- | ---------------------------------- |
| **-p ip:hostPort:containerPort**  | é…ç½®ç›‘å¬åœ°å€ -p 10.0.0.100:8080:80 |
| **-p ip::containerPort**          | éšæœºåˆ†é…ç«¯å£ -p 10.0.0.100::80     |
| **-p hostPort:containerPort:udp** | æŒ‡å®šåè®® -p 8080:80:tcp            |
| **-p 81:80 â€“p 443:443**           | æŒ‡å®šå¤šä¸ª                           |

```plain
[root@docker01 my_docker]# docker run -d -p 81:80 nginx
70cd2663eeedd4ae699f416db921fb9c144523b3c71b1593d0caa6aa43c97435
```



# dockerå®è·µ

# DockerFileé•œåƒå®šåˆ¶

å®šåˆ¶dockeré•œåƒçš„æ–¹å¼æœ‰ä¸¤ç§ï¼š

- æ‰‹åŠ¨ä¿®æ”¹å®¹å™¨å†…å®¹ï¼Œå¯¼å‡ºæ–°çš„é•œåƒ
- åŸºäºDockerfileè‡ªè¡Œç¼–å†™æŒ‡ä»¤ï¼ŒåŸºäºæŒ‡ä»¤æµç¨‹åˆ›å»ºé•œåƒã€‚

## dockerfileç®€ä»‹

![img](äº‘è®¡ç®—.assets/1610862014461-063c96c0-bb67-4c1e-bf39-8981dc27ee06.png)

é•œåƒæ˜¯å¤šå±‚å­˜å‚¨ï¼Œæ¯ä¸€å±‚åœ¨å‰ä¸€å±‚çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼›

å®¹å™¨ä¹Ÿæ˜¯å¤šå±‚å­˜å‚¨ï¼Œä»¥é•œåƒä¸ºåŸºç¡€å±‚ï¼Œåœ¨å…¶åŸºç¡€ä¸ŠåŠ ä¸€å±‚ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶çš„å­˜å‚¨å±‚ã€‚

åˆšæ‰è¯´äº†ï¼Œåˆ›å»ºé•œåƒçš„ä¸¤ä¸ªæ–¹æ³•

- æ‰‹åŠ¨ä¿®æ”¹å®¹å™¨å†…å®¹ï¼Œç„¶ådocker commitæäº¤å®¹å™¨ä¸ºæ–°çš„é•œåƒ
- é€šè¿‡åœ¨dockerfileä¸­å®šä¹‰ä¸€ç³»åˆ—çš„å‘½ä»¤å’Œå‚æ•°æ„æˆçš„è„šæœ¬ï¼Œç„¶åè¿™äº›å‘½ä»¤åº”ç”¨äºåŸºç¡€é•œåƒï¼Œä¾æ¬¡æ·»åŠ å±‚ï¼Œæœ€ç»ˆç”Ÿæˆä¸€ä¸ªæ–°çš„é•œåƒã€‚æå¤§çš„ç®€åŒ–äº†éƒ¨ç½²å·¥ä½œã€‚

å®˜æ–¹æä¾›çš„dockerfileå®ä¾‹

```plain
https://github.com/CentOS/CentOS-Dockerfiles
```

dockerfileä¸»è¦ç»„æˆéƒ¨åˆ†ï¼š

åŸºç¡€é•œåƒä¿¡æ¯ FROM centos:6.8

åˆ¶ä½œé•œåƒæ“ä½œæŒ‡ä»¤RUN yum insatll openssh-server -y

å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡ŒæŒ‡ä»¤ CMD ["/bin/bash"]

## dockerfileæŒ‡ä»¤

FROM è¿™ä¸ªé•œåƒçš„å¦ˆå¦ˆæ˜¯è°ï¼Ÿï¼ˆæŒ‡å®šåŸºç¡€é•œåƒï¼‰

MAINTAINER å‘Šè¯‰åˆ«äººï¼Œè°è´Ÿè´£å…»å®ƒï¼Ÿï¼ˆæŒ‡å®šç»´æŠ¤è€…ä¿¡æ¯ï¼Œå¯ä»¥æ²¡æœ‰ï¼‰

RUN ä½ æƒ³è®©å®ƒå¹²å•¥ï¼ˆåœ¨å‘½ä»¤å‰é¢åŠ ä¸ŠRUNå³å¯ï¼‰

ADD ç»™å®ƒç‚¹åˆ›ä¸šèµ„é‡‘ï¼ˆCOPYæ–‡ä»¶ï¼Œä¼šè‡ªåŠ¨è§£å‹ï¼‰

WORKDIR æˆ‘æ˜¯cd,ä»Šå¤©åˆšåŒ–äº†å¦†ï¼ˆè®¾ç½®å½“å‰å·¥ä½œç›®å½•ï¼‰

VOLUME ç»™å®ƒä¸€ä¸ªå­˜æ”¾è¡Œæçš„åœ°æ–¹ï¼ˆè®¾ç½®å·ï¼ŒæŒ‚è½½ä¸»æœºç›®å½•ï¼‰

EXPOSE å®ƒè¦æ‰“å¼€çš„é—¨æ˜¯å•¥ï¼ˆæŒ‡å®šå¯¹å¤–çš„ç«¯å£ï¼‰

CMD å¥”è·‘å§ï¼Œå…„å¼Ÿï¼ï¼ˆæŒ‡å®šå®¹å™¨å¯åŠ¨åçš„è¦å¹²çš„äº‹æƒ…ï¼‰

dockerfileå…¶ä»–æŒ‡ä»¤ï¼š

COPY å¤åˆ¶æ–‡ä»¶

ENV ç¯å¢ƒå˜é‡

ENTRYPOINT å®¹å™¨å¯åŠ¨åæ‰§è¡Œçš„å‘½ä»¤

## å¿«é€Ÿå…¥é—¨dockerfile

å†™ä¸€ä¸ªdockerfileæ„å»ºä¸€ä¸ªnginxé•œåƒï¼Œå¯ä»¥è¿è¡ŒnginxæœåŠ¡

```plain
[root@docker01 my_docker]# cat Dockerfile
FROM nginx
RUN echo '<meta charset=utf8>è¶…å“¥å¸¦ä½ ç”¨dockerè¿è¡ŒnginxæœåŠ¡.' > /usr/share/nginx/html/index.html
```

è¿è¡Œå®¹å™¨

```plain
[root@docker01 my_docker]# docker run -d -p80:80 10a
6e37f142cceea68504dcba9b753d1ab76f285f14a446c0976f125d73d8dec063
[root@docker01 my_docker]# curl 10.0.1.70
<meta charset=utf8>è¶…å“¥å¸¦ä½ ç”¨dockerè¿è¡ŒnginxæœåŠ¡.
```

### COPY

```plain
copyæŒ‡ä»¤ä»å®¿ä¸»æœºå¤åˆ¶æ–‡ä»¶/ç›®å½•åˆ°æ–°çš„ä¸€å±‚é•œåƒå†…
å¦‚
copy chaoge.py /home/
# æ”¯æŒå¤šä¸ªæ–‡ä»¶ï¼Œä»¥åŠé€šé…ç¬¦å½¢å¼å¤åˆ¶ï¼Œè¯­æ³•è¦æ»¡è¶³Golangçš„filepath.Match
copy chaoge* /tmp/cc?.txt. /home/
# COPYæŒ‡ä»¤èƒ½å¤Ÿä¿ç•™æºæ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œå¦‚æƒé™ï¼Œè®¿é—®æ—¶é—´ç­‰ç­‰ï¼Œè¿™ç‚¹å¾ˆé‡è¦
```

### ADD

```plain
ç‰¹æ€§å’ŒCOPYåŸºæœ¬ä¸€è‡´ï¼Œä¸è¿‡å¤šäº†äº›åŠŸèƒ½
1.æºæ–‡ä»¶æ˜¯ä¸€ä¸ªURLï¼Œæ­¤æ—¶dockerå¼•æ“ä¼šä¸‹è½½è¯¥é“¾æ¥ï¼Œæ”¾å…¥ç›®æ ‡è·¯å¾„ï¼Œä¸”æƒé™è‡ªåŠ¨è®¾ä¸º600ï¼Œè‹¥è¿™ä¸æ˜¯æœŸæœ›ç»“æœï¼Œè¿˜å¾—å¢åŠ ä¸€å±‚RUNæŒ‡ä»¤è¿›è¡Œè°ƒæ•´
2.æºæ–‡ä»¶æ˜¯ä¸€ä¸ªURLï¼Œä¸”æ˜¯ä¸€ä¸ªå‹ç¼©åŒ…ï¼Œä¸ä¼šè‡ªåŠ¨è§£å‹ï¼Œä¹Ÿå¾—å•ç‹¬ç”¨RUNæŒ‡ä»¤è§£å‹
3.æºæ–‡ä»¶æ˜¯ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ï¼Œä¸”æ˜¯gzipï¼Œbzip2ï¼Œxzï¼Œtaræƒ…å†µï¼ŒADDæŒ‡ä»¤ä¼šè‡ªåŠ¨è§£å‹ç¼©è¯¥æ–‡ä»¶åˆ°ç›®æ ‡è·¯å¾„
```

Dockerfileå®˜æ–¹æ›´ä¸ºæ¨èä½¿ç”¨COPYï¼ŒADDåŒ…å«äº†æ›´å¤šå¤æ‚çš„åŠŸèƒ½ï¼Œä¸”ADDä¼šä½¿æ„å»ºç¼“å­˜å¤±æ•ˆï¼Œå¯¼è‡´é•œåƒæ„å»ºç¼“æ…¢ã€‚

### CMD

```plain
ç”¨æ³•ï¼Œæ³¨æ„æ˜¯åŒå¼•å·
CMD ["å‚æ•°1","å‚æ•°2"]
åœ¨æŒ‡å®šäº†entrypointæŒ‡ä»¤åï¼Œç”¨CMDæŒ‡å®šå…·ä½“çš„å‚æ•°
dockerä¸æ˜¯è™šæ‹Ÿæœºï¼Œå®¹å™¨å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œæ—¢ç„¶æ˜¯è¿›ç¨‹ï¼Œé‚£ä¹ˆç¨‹åºåœ¨å¯åŠ¨çš„æ—¶å€™éœ€è¦æŒ‡å®šäº›è¿è¡Œå‚æ•°ï¼Œè¿™å°±æ˜¯CMDæŒ‡ä»¤ä½œç”¨
ä¾‹å¦‚centosé•œåƒé»˜è®¤çš„CMDæ˜¯/bin/bashï¼Œç›´æ¥docker run -it centosä¼šç›´æ¥è¿›å…¥bashè§£é‡Šå™¨ã€‚
ä¹Ÿå¯ä»¥å¯åŠ¨å®¹å™¨æ—¶å€™ï¼ŒæŒ‡å®šå‚æ•°. docker run -it centos cat /etc/os-releasea
CMDè¿è¡Œshellå‘½ä»¤ï¼Œä¹Ÿä¼šè¢«è½¬åŒ–ä¸ºshellå½¢å¼
ä¾‹å¦‚
CMD echo $PATH
ä¼šè¢«è½¬åŒ–ä¸º
CMD ["sh","-c","echo $PATH"]
```

### å®¹å™¨å†…è¿è¡Œç¨‹åº

è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œdockerä¸æ˜¯è™šæ‹Ÿæœºçš„æ¦‚å¿µï¼Œè™šæ‹Ÿæœºé‡Œçš„ç¨‹åºè¿è¡Œï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨åå°è¿è¡Œï¼Œåˆ©ç”¨systemctlè¿è¡Œï¼Œä½†æ˜¯å®¹å™¨å†…æ²¡æœ‰åå°è¿›ç¨‹çš„æ¦‚å¿µï¼Œå¿…é¡»åœ¨å‰å°è¿è¡Œã€‚

å®¹å™¨å°±æ˜¯ä¸ºäº†ä¸»è¿›ç¨‹è€Œå­˜åœ¨çš„ï¼Œä¸»è¿›ç¨‹å¦‚æœé€€å‡ºäº†ï¼Œå®¹å™¨ä¹Ÿå°±å¤±å»æ„ä¹‰ï¼Œè‡ªåŠ¨é€€å‡ºã€‚

ä¾‹å¦‚æœ‰ä¸€ä¸ªç»å…¸é—®é¢˜

```plain
CMD systemctl start nginx
è¿™æ ·çš„å†™æ³•æ˜¯é”™è¯¯çš„ï¼Œå®¹å™¨ä¼šç«‹å³é€€å‡º
å› ä¸ºsystemctl start nginxæ˜¯å¸Œæœ›ä»¥å®ˆæŠ¤è¿›ç¨‹å½¢å¼å¯åŠ¨nginxï¼Œä¸”CMDå‘½ä»¤ä¼šè½¬åŒ–ä¸º
CMD ["sh","-c","systemctl start nginx"]
è¿™æ ·çš„å‘½ä»¤ä¸»è¿›ç¨‹æ˜¯shè§£é‡Šå™¨ï¼Œæ‰§è¡Œå®Œæ¯•åç«‹å³ç»“æŸäº†ï¼Œå› æ­¤å®¹å™¨ä¹Ÿå°±é€€å‡ºäº†ã€‚
å› æ­¤æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯CMD ["nginx","-g","daemon off;"]
```

### ENTRYPOINT

å’ŒRUNæŒ‡ä»¤ä¸€æ ·ï¼Œåˆ†ä¸ºä¸¤ç§æ ¼å¼

- exec
- shell

ä½œç”¨å’ŒCMDä¸€æ ·ï¼Œéƒ½æ˜¯åœ¨æŒ‡å®šå®¹å™¨å¯åŠ¨ç¨‹åºä»¥åŠå‚æ•°ã€‚

å½“æŒ‡å®šäº†ENTRYPOINTä¹‹åï¼ŒCMDæŒ‡ä»¤çš„è¯­ä¹‰å°±æœ‰äº†å˜åŒ–ï¼Œè€Œæ˜¯å§CMDçš„å†…å®¹å½“ä½œå‚æ•°ä¼ é€’ç»™ENTRYPOINTæŒ‡ä»¤ã€‚

```plain
å®é™…ç”¨æ³•
```

1.å‡†å¤‡å¥½dockerfile

```plain
[root@docker01 my_docker]# cat Dockerfile
FROM centos:7.2.1511
RUN rpm --rebuilddb &&  yum install epel-release -y
RUN rpm --rebuilddb &&  yum install curl -y
CMD ["curl","-s","http://ipinfo.io/ip"]
```

2.æ„å»ºé•œåƒ

```plain
[root@docker01 my_docker]# docker build -t myip .
```

3.è¿è¡Œé•œåƒï¼Œç”Ÿæˆå®¹å™¨ï¼Œç”±äºå®¹å™¨é‡Œæ²¡æœ‰è¿›ç¨‹è¿è¡Œï¼Œç›´æ¥æŒ‚äº†

```plain
[root@docker01 my_docker]# docker run myip
221.218.209.75
[root@docker01 my_docker]# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
[root@docker01 my_docker]# docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                      PORTS               NAMES
eb288469d896        myip                "curl -s http://ipinâ€¦"   11 seconds ago      Exited (0) 10 seconds ago                       zealous_mendel
[root@docker01 my_docker]# docker logs eb2
221.218.209.75
```

4.è¿™æ ·çœ‹èµ·æ¥ï¼Œæ„Ÿè§‰æŠŠè¯¥é•œåƒå½“ä½œå‘½ä»¤æ¥ä½¿ç”¨äº†ï¼Œä½†æ˜¯å¦‚æœåŠ ä¸Šå‚æ•°ï¼Œå°±ä¸è¡Œäº†

```plain
myipè¯¥é•œåƒï¼Œæ ¸å¿ƒåœ¨äºCMDï¼Œå®è´¨å‘½ä»¤æ˜¯curlï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨å‚æ•°-I æŸ¥çœ‹HTTPå¤´éƒ¨ä¿¡æ¯
1.æ— æ³•æ·»åŠ å‚æ•°ï¼Œè¯¥å½¢å¼
[root@docker01 my_docker]# docker run myip -I
docker: Error response from daemon: OCI runtime create failed: container_linux.go:349: starting container process caused "exec: \"-i\": executable file not found in $PATH": unknown.
ERRO[0000] error waiting for container: context canceled
```

è§£å†³åŠæ³•ï¼š

ç¬¬ä¸€ç§ï¼Œé‡æ–°ä¼ å…¥å®Œæ•´çš„å‚æ•°

```plain
[root@docker01 ~]# docker run myip curl -s http://ipinfo.io/ip -I
HTTP/1.1 200 OK
Date: Fri, 04 Sep 2020 10:25:08 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 15
X-Powered-By: Express
Access-Control-Allow-Origin: *
Set-Cookie: flash=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT
Via: 1.1 google
Expires: Fri, 04 Sep 2020 10:25:08 GMT
Cache-Control: private
```

ä½†æ˜¯è¿™ç§å½¢å¼ï¼Œæ²¡ä»€ä¹ˆæ„ä¹‰

ä½¿ç”¨ENTRYPOINTå¯ä»¥è§£å†³è¯¥é—®é¢˜

```plain
[root@docker01 my_docker]# cat Dockerfile
FROM centos:7.2.1511
RUN rpm --rebuilddb &&  yum install epel-release -y
RUN rpm --rebuilddb &&  yum install curl -y
ENTRYPOINT ["curl","-s","http://ipinfo.io/ip"]
[root@docker01 my_docker]# docker build -t myip .
[root@docker01 my_docker]# docker run myip -I
HTTP/1.1 200 OK
Date: Fri, 04 Sep 2020 10:28:45 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 15
X-Powered-By: Express
Access-Control-Allow-Origin: *
Set-Cookie: flash=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT
Via: 1.1 google
Expires: Fri, 04 Sep 2020 10:28:45 GMT
Cache-Control: private
```

#### æ€»ç»“

è¿™å°±æ˜¯å½“entrypointå­˜åœ¨æ—¶ï¼Œç»™é•œåƒè¿è¡Œæ—¶ä¼ å…¥å‚æ•°ï¼Œä¹Ÿå°±æ˜¯CMDçš„å†…å®¹ï¼Œä¼šåº§ä½å‚æ•°ä¼ é€’ç»™ENTRYPOINTã€‚

è¿™é‡Œçš„`-I`å‚æ•°å°±ä¼ é€’ç»™äº†`curl -s http://ipinfo.io/ip -I`

### ENV

è¿™ä¸ªæŒ‡ä»¤ç®€å•ï¼Œç®€å•çš„è®¾ç½®ç¯å¢ƒå˜é‡è€Œå·²ï¼Œæ— è®ºæ˜¯å…¶ä»–æŒ‡ä»¤è¿˜æ˜¯RUNï¼Œéƒ½å¯ä»¥åº”ç”¨è¯¥ç¯å¢ƒå˜é‡ã€‚

```plain
ENV NAME="chaoge nb"
ENV MYSQL_VERSION=5.6
é¢„å…ˆå®šä¹‰äº†ç¯å¢ƒå˜é‡åï¼Œåœ¨åç»­çš„æ“ä½œéƒ½å¯ä»¥é‡‡ç”¨ $NAME. $MYSQL_VERSIONå½¢å¼è¿›è¡Œæ–¹ä¾¿çš„æ“ä½œï¼Œç»´æŠ¤èµ·æ¥æ›´ä¸ºä¸“ä¸šï¼Œç®€å•ã€‚
```

ADDã€COPYã€ENVã€EXPOSEã€LABELã€WORKDIRã€VOLUMEç­‰éƒ½æ”¯æŒã€‚

### ARG

ARGå’ŒENVä¸€æ ·å±äºè®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒåŒºåˆ«åœ¨äºARGè®¾ç½®çš„æ˜¯æ„å»ºç¯å¢ƒçš„ç¯å¢ƒå˜é‡ï¼Œå®¹å™¨è¿è¡Œæ—¶æ˜¯ä¸ä¼šå­˜åœ¨è¿™äº›å˜é‡çš„ã€‚

### VOLUME

å®¹å™¨åœ¨è¿è¡Œæ—¶ï¼Œåº”è¯¥ä¿è¯å­˜å‚¨å±‚ä¸å­˜åœ¨å†™å…¥æ“ä½œï¼Œéœ€è¦å†™å…¥æ•°æ®çš„æ“ä½œï¼Œä¾‹å¦‚æ•°æ®åº“ç±»åŠ¨æ€æ•°æ®ï¼Œåº”è¯¥ä¿å­˜åœ¨å·ä¸­ã€‚ï¼ˆVOLUMEï¼‰

```plain
VOLUME /data   å¦‚æ­¤å†™æ³•ï¼Œå®¹å™¨è¿è¡Œæ—¶å€™è¯¥/dataç›®å½•å›è‡ªåŠ¨æŒ‚è½½ä¸ºåŒ¿åå·ï¼Œä»»ä½•å‘/dataå†™å…¥çš„æ“ä½œéƒ½ä¸ä¼šè®°å½•åˆ°å®¹å™¨é‡Œï¼Œä¿è¯äº†å®¹å™¨å­˜å‚¨å±‚çš„æ— çŠ¶æ€åŒ–ã€‚
# æµ‹è¯•çš„dockerfileæ–‡ä»¶
FROM centos
MAINTAINER chaoge
VOLUME ["/data1","/data2"]
è¿™æ ·volumeæŒ‡å®šäº†2ä¸ªæŒ‚è½½ç‚¹/data1å’Œ/data2ï¼Œä¼šè‡ªåŠ¨å’Œå®¿ä¸»æœºçš„ç›®å½•åšæ˜ å°„å…³ç³»ã€‚
å¯ä»¥é€šè¿‡å‘½ä»¤æŸ¥çœ‹
docker inspect å®¹å™¨
æŸ¥æ‰¾"Mounts"å¯»æ‰¾å®¿ä¸»æœºçš„æºç›®å½•ã€‚
```

æœ‰å…³å®¹å™¨å†…æ•°æ®çš„å­˜å‚¨ï¼Œè¿˜å¯ä»¥é€šè¿‡dockerå‘½ä»¤å‚æ•°-vå®ç°ã€‚

```plain
docker run -d -v /my_data:/data  å®¹å™¨id
è¡¨ç¤ºæŠŠå®¹å™¨å†…çš„/dataç›®å½•å’Œå®¿ä¸»æœºçš„/my_dataä½œæ˜ å°„å…³ç³»
```

### EXPOSE

è¯¥æŒ‡ä»¤ç”¨äºæŒ‡å®šå®¹å™¨è¿è¡Œæ—¶æä¾›çš„ç«¯å£æœåŠ¡ï¼Œè¿™é‡Œåªæ˜¯å£°æ˜ä¸ºè¦ç”¨å“ªä¸ªç«¯å£ï¼Œä¸æ˜¯è¯´ä¼šå¼€å¯è¿™ä¸ªç«¯å£ã€‚

ä½œç”¨æ˜¯

- å¸®åŠ©é•œåƒä½¿ç”¨è€…å¿«é€Ÿç†è§£è¯¥é•œåƒçš„ç«¯å£æœåŠ¡ï¼Œä¾¿äºé…ç½®æ˜ å°„å…³ç³»`docker run -p`
- å¯åŠ¨å®¹å™¨æ—¶å¯ä»¥è¿›è¡Œéšæœºç«¯å£æ˜ å°„`docker run -P`

### WORKDIR

è¯¥æŒ‡ä»¤ç”¨äºæŒ‡å®šå·¥ä½œç›®å½•ï¼Œå‰æè¯¥ç›®å½•å¾—å­˜åœ¨ï¼Œè¦æ›´æ”¹å·¥ä½œç›®å½•ï¼Œå¾—ç”¨è¯¥æŒ‡ä»¤

```plain
WORKDIR /opt
```

### USER

å’ŒWORKDIRæŒ‡ä»¤ç±»ä¼¼ï¼Œç”¨äºæ”¹å˜ç¯å¢ƒï¼Œä½œç”¨æ˜¯åˆ‡æ¢åˆ°å…¶ä»–ç”¨æˆ·ï¼Œæ”¹å˜ä¹‹åçš„æŒ‡ä»¤æ‰§è¡Œçš„èº«ä»½ã€‚

æ³¨æ„ç”¨æˆ·è¦æå‰å­˜åœ¨

```plain
USER root
USER chaoge
```

dockerfileçš„æŒ‡ä»¤è¿˜æœ‰å¾ˆå¤š

## Docker commit

é•œåƒæ˜¯å®¹å™¨çš„åŸºç¡€ï¼Œé™¤äº†å¯ä»¥å»docker hubä¸‹è½½é•œåƒï¼Œè¿˜å¯ä»¥åŸºäºæœ¬åœ°å®¹å™¨è¿›è¡Œé•œåƒæäº¤ï¼Œå®šåˆ¶é•œåƒã€‚

é•œåƒæ˜¯å¤šå±‚å­˜å‚¨ï¼Œæ¯ä¸€å±‚éƒ½æ˜¯åœ¨å‰ä¸€å±‚çš„åŸºç¡€ä¸Šä¿®æ”¹ã€‚

### è‡ªå®šåˆ¶webé•œåƒ

```plain
1.è¿è¡Œnginxå®¹å™¨
[root@docker01 my_docker]# docker run --name web01 -d -p 80:80 nginx
253e960c0be8680bb71842a6903525c9dc13f181058e141ef0b469f988f19083
[root@docker01 my_docker]# docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                NAMES
253e960c0be8        nginx               "/docker-entrypoint.â€¦"   2 seconds ago       Up 1 second         0.0.0.0:80->80/tcp   web01
2.é»˜è®¤çš„é¦–é¡µå†…å®¹
[root@docker01 my_docker]# curl -s  127.0.0.1 |grep h1
<h1>Welcome to nginx!</h1>
3.è‹¥æ˜¯æˆ‘æƒ³è¦ä¿®æ”¹è¿™ä¸ªæ¬¢è¿é¡µé¢ï¼Œæ³½å¯ä»¥è¿›å…¥å®¹å™¨ä¿®æ”¹å…¶å†…å®¹
[root@docker01 my_docker]# docker exec -it web01 bash
root@253e960c0be8:/# echo '<h1>welcome~everyone</h1>' > /usr/share/nginx/html/index.html
root@253e960c0be8:/# exit
exit
4.æ­¤æ—¶å†è®¿é—®web01ç«™ç‚¹
[root@docker01 my_docker]# curl 127.0.1
<h1>welcome~everyone</h1>
5.æ­¤æ—¶ä¿®æ”¹äº†å®¹å™¨çš„æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹äº†å®¹å™¨çš„å­˜å‚¨å±‚ï¼Œå¸Œæœ›èƒ½å¤Ÿå°†è¯¥å®¹å™¨ä¿å­˜ä¸‹è½½ï¼Œåšæˆé•œåƒ
docker commitä½œç”¨æ˜¯å§å®¹å™¨çš„å­˜å‚¨å±‚ä¿å­˜ä¸‹æ¥åˆ¶ä½œä¸ºé•œåƒï¼Œåœ¨åŸé•œåƒåŸºç¡€ä¸Šï¼Œå†å åŠ å®¹å™¨çš„å­˜å‚¨å±‚ï¼Œåˆ¶ä½œæ–°çš„é•œåƒã€‚
[root@docker01 my_docker]# docker commit --author "chaoge <yc_uuu@163.com>" --message "ä¿®æ”¹é¦–é¡µæ¬¢è¿é¡µé¢" web01 nginx01
sha256:e408b4e4688b49b2762468c580118852ba1e0402fdcf88274d4c8180ba270660
6.æ£€æŸ¥æ–°çš„é•œåƒ
[root@docker01 my_docker]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
nginx01             latest              e408b4e4688b        14 seconds ago      133MB
7.æŸ¥çœ‹é•œåƒå†å²è®°å½•
[root@docker01 my_docker]# docker history nginx01
IMAGE               CREATED              CREATED BY                                      SIZE                COMMENT
e408b4e4688b        About a minute ago   nginx -g daemon off;                            1.22kB              ä¿®æ”¹é¦–é¡µæ¬¢è¿é¡µé¢
4bb46517cac3        3 weeks ago          /bin/sh -c #(nop)  CMD ["nginx" "-g" "daemonâ€¦   0B
<missing>           3 weeks ago          /bin/sh -c #(nop)  STOPSIGNAL SIGTERM           0B
<missing>           3 weeks ago          /bin/sh -c #(nop)  EXPOSE 80                    0B
<missing>           3 weeks ago          /bin/sh -c #(nop)  ENTRYPOINT ["/docker-entrâ€¦   0B
<missing>           3 weeks ago          /bin/sh -c #(nop) COPY file:0fd5fca330dcd6a7â€¦   1.04kB
<missing>           3 weeks ago          /bin/sh -c #(nop) COPY file:1d0a4127e78a26c1â€¦   1.96kB
<missing>           3 weeks ago          /bin/sh -c #(nop) COPY file:e7e183879c35719câ€¦   1.2kB
<missing>           3 weeks ago          /bin/sh -c set -x     && addgroup --system -â€¦   63.4MB
<missing>           3 weeks ago          /bin/sh -c #(nop)  ENV PKG_RELEASE=1~buster     0B
<missing>           3 weeks ago          /bin/sh -c #(nop)  ENV NJS_VERSION=0.4.3        0B
<missing>           3 weeks ago          /bin/sh -c #(nop)  ENV NGINX_VERSION=1.19.2     0B
<missing>           4 weeks ago          /bin/sh -c #(nop)  LABEL maintainer=NGINX Doâ€¦   0B
<missing>           4 weeks ago          /bin/sh -c #(nop)  CMD ["bash"]                 0B
<missing>           4 weeks ago          /bin/sh -c #(nop) ADD file:3af3091e7d2bb40bcâ€¦   69.2MB
8.å¯ä»¥ç”¨æ–°é•œåƒè¿è¡Œ
[root@docker01 my_docker]# docker run --name nginx01 -d -p 81:80 nginx01
64be8aabff2a206ac95865e893fa3f13bdaf10b8cb8eaa8cfb3c1f72e79f10b2
[root@docker01 my_docker]# docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                NAMES
64be8aabff2a        nginx01             "/docker-entrypoint.â€¦"   4 seconds ago       Up 3 seconds        0.0.0.0:81->80/tcp   nginx01
[root@docker01 my_docker]# curl http://10.0.1.70:81/
<h1>welcome~everyone</h1>
æ­¤æ—¶æ–°çš„å®¹å™¨æœåŠ¡ï¼Œ81ç«¯å£å’Œ80ç«¯å£å°±æ˜¯ä¸€æ ·äº†
9.æ­¤æ—¶æˆ‘ä»¬å°±å®Œæˆäº†ä¸€æ¬¡é•œåƒå®šåˆ¶
```

ä½†æ˜¯ä¼ä¸šé‡Œå¾ˆå°‘ç”¨docker commitæäº¤é•œåƒï¼Œå› ä¸ºåœ¨æäº¤å‰çš„é•œåƒæ“ä½œéƒ½æ˜¯é»‘ç®±æ“ä½œï¼Œæ— äººå¾—çŸ¥é•œåƒæ˜¯å¦‚ä½•åˆ¶ä½œè€Œæ¥ï¼Œå¹¶ä¸”é•œåƒæ˜¯åˆ†å±‚å­˜å‚¨ï¼Œå®¹å™¨å†…çš„å‘½ä»¤æ‰§è¡Œï¼Œå¯èƒ½ä¼šç¯¡æ”¹å¾ˆå¤šæ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡`docker diff`æŸ¥çœ‹

```plain
1.æŸ¥çœ‹å®¹å™¨çš„ä¿®æ”¹è®°å½•
[root@docker01 my_docker]# docker diff web01
C /root
A /root/.bash_history
C /run
A /run/nginx.pid
C /var
C /var/cache
C /var/cache/nginx
A /var/cache/nginx/uwsgi_temp
A /var/cache/nginx/client_temp
A /var/cache/nginx/fastcgi_temp
A /var/cache/nginx/proxy_temp
A /var/cache/nginx/scgi_temp
C /etc
C /etc/nginx
C /etc/nginx/conf.d
C /etc/nginx/conf.d/default.conf
C /usr
C /usr/share
C /usr/share/nginx
C /usr/share/nginx/html
C /usr/share/nginx/html/index.html
2.å¦‚æœæ˜¯è½¯ä»¶å®‰è£…ï¼Œç¼–è¯‘æ„å»ºï¼Œè¿˜æœ‰æœ‰æ›´å¤§é‡çš„ä¿®æ”¹åŠ¨ä½œï¼Œå¦‚æœæäº¤è¯¥é•œåƒï¼Œä¼šå¯¼è‡´é•œåƒè¿‡åˆ†è‡ƒè‚¿ã€‚
3.docker commitå¯ä»¥ç”¨åœ¨ä¸€äº›ç‰¹æ®Šåœºæ™¯ï¼Œä¾‹å¦‚å®¹å™¨è¢«å…¥ä¾µï¼Œéœ€è¦æäº¤ä¿å­˜é•œåƒåœºæ™¯ã€‚
```

# å®è·µdockerfileæ„å»ºé•œåƒ

åˆ©ç”¨dockerfileæ„å»ºè¿è¡Œä¸€ä¸ªpython webç¨‹åºã€‚

```plain
1.å®¿ä¸»æœºå‡†å¤‡é•œåƒç›®å½•ï¼Œä»£ç æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶
[root@docker01 ~]# mkdir /my_docker
[root@docker01 my_docker]# touch Dockerfile
# å‡†å¤‡ä»£ç æ–‡ä»¶ï¼Œpythonè„šæœ¬
[root@docker01 my_docker]# cat app.py
#coding:utf8
from flask import Flask
app=Flask(__name__)
@app.route('/')
def hello():
    return "hello docker,i am chaoge."
if __name__=="__main__":
    app.run(host='0.0.0.0',port=8080)
2.å†™å…¥æ–‡ä»¶å†…å®¹,ä¾¿æºdockerfile
[root@docker01 my_docker]# cat Dockerfile
FROM centos:7.6.1810
RUN curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo;
RUN curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo;
RUN yum makecache fast;
RUN yum install python-devel python-pip -y
RUN pip install flask
COPY app.py /opt
WORKDIR /opt
EXPOSE 8080
CMD ["python","app.py"]
3.æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼Œåˆ›å»ºæ–°é•œåƒï¼Œå¯ä»¥è€ƒè™‘åŠ ä¸Šå¿½ç•¥ç¼“å­˜çš„å‚æ•°ï¼Œ--no-cache
[root@docker01 my_docker]# docker build -t 'chaoge01/my_flask' .
4.è¿è¡Œé•œåƒï¼Œå¯åŠ¨å®¹å™¨
[root@docker01 my_docker]# docker run --name flask01 -d -p 85:8080 chaoge01/my_flask
f083a709e7a2d5f3a7b739ee249bc1411dd18318bfa6d583c7150ff246c65676
[root@docker01 my_docker]# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                  NAMES
f083a709e7a2        chaoge01/my_flask   "python app.py"     2 seconds ago       Up 1 second         0.0.0.0:85->8080/tcp   flask01
```

5.è®¿é—®å®¹å™¨æœåŠ¡

![img](äº‘è®¡ç®—.assets/1610862014472-00413324-7792-4c37-8798-4a0b5703a380.png)

# Dockerå®¹å™¨

å®¹å™¨æ˜¯dockerçš„æ ¸å¿ƒæ¦‚å¿µï¼Œå®¹å™¨æ˜¯ä¸€ä¸ªæˆ–è€…ä¸€ç»„åº”ç”¨ï¼Œå®ƒçš„è¿è¡ŒçŠ¶æ€å¦‚ä¸‹

- dockeråˆ©ç”¨å®¹å™¨è¿è¡Œåº”ç”¨ç¨‹åº
- å®¹å™¨æ˜¯é•œåƒçš„è¿è¡Œå®ä¾‹ï¼Œå¯ä»¥è¢«runã€startã€stopã€rm
- æ¯ä¸ªå®¹å™¨éƒ½æ˜¯ç›¸äº’éš”ç¦»ï¼Œä¿è¯å¹³å°å®‰å…¨
- å®¹å™¨å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªç®€æ˜“ç‰ˆLinuxç¯å¢ƒï¼ˆæœ‰rootæƒé™ï¼Œè¿›ç¨‹ï¼Œç”¨æˆ·ç©ºé—´ï¼Œç½‘ç»œï¼‰
- é•œåƒæ˜¯åªè¯»çš„ï¼Œå®¹å™¨åœ¨å¯åŠ¨çš„æ—¶å€™åˆ›å»ºä¸€å±‚å¯å†™å±‚ã€‚

![img](äº‘è®¡ç®—.assets/1610862014489-c9f90be8-d8e2-452c-ae70-de0cf344d239.png)

dockerfileé¢å‘å¼€å‘ï¼Œdocker imageä½œä¸ºäº¤ä»˜æ ‡å‡†ï¼Œdocker containeræ¶‰åŠéƒ¨ç½²å’Œè¿ç»´ï¼Œä¸‰è€…åˆèµ·æ¥å®Œæˆdockerä½“ç³»ã€‚

ä¸Šå›¾å¯ä»¥ç†è§£

```plain
FROM ubuntu:14.04            é€‰æ‹©åŸºç¡€é•œåƒ
ADD run.sh                    æ·»åŠ æ–‡ä»¶è¿›é•œåƒï¼Œè¿™ä¸€å±‚é•œåƒåªæœ‰ä¸€ä¸ªå†…å®¹ï¼Œå°±æ˜¯è¿™ä¸ªæ–‡ä»¶
VOLUME /data                è®¾å®šå­˜å‚¨ç›®å½•ï¼Œå¹¶æœªæ·»åŠ æ–‡ä»¶ï¼Œåªæ˜¯æ›´æ–°äº†é•œåƒçš„jsonæ–‡ä»¶ï¼Œä¾¿äºå¯åŠ¨æ—¶å€™è¯»åŒºè¯¥å±‚ä¿¡æ¯
CMD ["./run.sh"]        æ›´æ–°jsonæ–‡ä»¶ï¼Œè®¾å®šç¨‹åºå…¥å£
```

## å®¹å™¨æ“ä½œ

å¯åŠ¨å®¹å™¨æ–¹å¼ï¼š

- åŸºäºé•œåƒåˆ›å»º

```plain
[root@docker01 my_docker]# docker run ubuntu /bin/echo 'Hello world'
å¯åŠ¨äº¤äº’å¼å®¹å™¨
[root@docker01 my_docker]# docker run -it ubuntu /bin/bash
root@30b2c5171302:/# pwd
/
root@30b2c5171302:/# whoami
root
```

docker runå¯åŠ¨å®¹å™¨çš„æ—¶å€™ï¼Œdockeråå°æ“ä½œæµç¨‹æ˜¯

- æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰è¯¥é•œåƒï¼Œæ²¡æœ‰å°±ä¸‹è½½
- åˆ©ç”¨é•œåƒåˆ›å»ºä¸”å¯åŠ¨ä¸€ä¸ªå®¹å™¨
- åˆ†é…å®¹å™¨æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨åªè¯»çš„é•œåƒå±‚æŒ‚è½½è¯»å†™å±‚
- å®¿ä¸»æœºçš„ç½‘æ¡¥æ¥å£ä¼šåˆ†é…ä¸€ä¸ªè™šæ‹Ÿæ¥å£åˆ°å®¹å™¨ä¸­
- å®¹å™¨è·å¾—åœ°å€æ± é‡Œçš„ipåœ°å€
- æ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„ç¨‹åº
- è‹¥ç¨‹åºé‡Œæ²¡æœ‰è¿›ç¨‹åœ¨è¿è¡Œï¼Œå®¹å™¨æ‰§è¡Œå®Œæ¯•åç«‹å³ç»ˆæ­¢

```plain
docker startå¯ä»¥å¯åŠ¨ä¸€ä¸ªå¤„äºstopçŠ¶æ€çš„å®¹å™¨ã€‚
```

## åå°è¿è¡Œå®¹å™¨

```plain
1.åœ¨å®¿ä¸»æœºä¸‹ï¼Œå‰å°è¿è¡Œå®¹å™¨ï¼Œä¼šå ç”¨çª—å£ï¼Œæ‰“å°æ—¥å¿—
[root@docker01 my_docker]# docker run --rm --name my_nginx02  -p 80:80 nginx
/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/
/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
10-listen-on-ipv6-by-default.sh: Getting the checksum of /etc/nginx/conf.d/default.conf
10-listen-on-ipv6-by-default.sh: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf
/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh
/docker-entrypoint.sh: Configuration complete; ready for start up
10.0.1.1 - - [05/Sep/2020:08:46:14 +0000] "GET / HTTP/1.1" 200 612 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36" "-"
2020/09/05 08:46:14 [error] 28#28: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 10.0.1.1, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "10.0.1.70", referrer: "http://10.0.1.70/"
10.0.1.1 - - [05/Sep/2020:08:46:14 +0000] "GET /favicon.ico HTTP/1.1" 404 555 "http://10.0.1.70/" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36" "-"
```

ä½¿ç”¨-då‚æ•°åœ¨åå°è¿è¡Œ

```plain
[root@docker01 my_docker]# docker run --rm --name my_nginx02  -d -p 80:80 nginx
eb6a2382bd1671bfbf47de176c1320355717a9ea132c4e469b9cc1cdc820436c
```

æ­¤æ—¶å®¹å™¨åœ¨åå°è¿è¡Œï¼Œæ—¥å¿—å¯ä»¥é€šè¿‡`docker logs å®¹å™¨`æŸ¥çœ‹

## docker logs

```plain
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
[root@docker01 my_docker]# docker logs eb6
# è·Ÿè¸ªå®¹å™¨æ—¥å¿—
[root@docker01 my_docker]# docker logs -f eb6
```

## æŸ¥çœ‹å®¹å™¨è®°å½•

```plain
docket ps   åœ¨è¿è¡Œçš„å®¹å™¨
docker ps -a æŒ‚æ‰ä»¥åŠæ´»ç€çš„å®¹å™¨
```

## åœæ­¢å®¹å™¨

```plain
docker stop
```

## è¿›å…¥å®¹å™¨

```plain
å®¹å™¨åœ¨-dåå°è¿è¡Œæ—¶ï¼Œæƒ³è¦è¿›å…¥å®¹å™¨å†…æ“ä½œ
[root@docker01 my_docker]# docker exec -it eb6 bash
```

## å¯¼å…¥/å¯¼å‡º/å®¹å™¨å¿«ç…§

```plain
# å¯¼å‡ºé•œåƒåˆ°æœ¬åœ°æ–‡ä»¶
[root@docker01 my_docker]# docker export my_nginx02 > my_nginx02.tar
[root@docker01 my_docker]# ls
app.py  Dockerfile  my_nginx02.tar
# ç”¨æˆ·å¯ä»¥å¯¼å…¥å®¹å™¨å¿«ç…§ï¼Œæ¢å¤ä¸ºé•œåƒ
[root@docker01 my_docker]# docker import my_nginx02.tar test/my_nginx:v1.0
sha256:36321d2fc1c8d348452dff561a6e1de4567cea48c7303c9113d8b62c647b6cf4
[root@docker01 my_docker]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
test/my_nginx       v1.0                36321d2fc1c8        4 seconds ago       131MB
```

## å¯¼å…¥/å¯¼å‡º/é•œåƒ

```plain
docker save é•œåƒ
docker load é•œåƒæ–‡ä»¶
docker import å®¹å™¨å¿«ç…§
æ³¨æ„è¿™ä¿©åŒºåˆ«ï¼Œå®¹å™¨å¿«ç…§æ–‡ä»¶ä¼šä¸¢å¤±æ‰€æœ‰å†å²è®°å½•å’Œå®¹å™¨å†…å…ƒæ•°æ®
é•œåƒæ–‡ä»¶ä¼šä¿å­˜å®Œæ•´è®°å½•ï¼Œä½“ç§¯è¾ƒå¤§
```

## åˆ é™¤å®¹å™¨

```plain
docker rm å®¹å™¨id # åˆ é™¤ä¸€ä¸ªåœæ­¢çŠ¶æ€çš„å®¹å™¨
docker rm -f å®¹å™¨ã€‚# å¼ºåˆ¶ç»ˆæ­¢å®¹å™¨ä¸”åˆ é™¤
```

## æŸ¥çœ‹å®¹å™¨æ—¥å¿—

```plain
docker logs å®¹å™¨
docker logs -f å®¹å™¨  # è·Ÿè¸ªå®¹å™¨æ—¥å¿—
docker logs -ft å®¹å™¨ # è·Ÿè¸ªå®¹å™¨æ—¥å¿—ä¸æ—¶é—´æˆ³
```

## æŸ¥çœ‹å®¹å™¨è¿›ç¨‹åˆ—è¡¨

```plain
[root@docker01 my_docker]# docker top eb6
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
root                20906               20889               0                   Sep06               ?                   00:00:00            nginx: master process nginx -g daemon off;
101                 20955               20906               0                   Sep06               ?                   00:00:00            nginx: worker process
```

## æŸ¥çœ‹å®¹å™¨åˆ—è¡¨ç³»ç»Ÿèµ„æºçŠ¶æ€

```plain
docket stats
```

## æŸ¥çœ‹å®¹å™¨ä¿¡æ¯å‚æ•°

```plain
[root@docker01 my_docker]# docker inspect å®¹å™¨id
```

## è·å–å®¹å™¨ip

```plain
[root@docker01 my_docker]# docker inspect --format '{{ .NetworkSettings.IPAddress }}'  eb6
172.17.0.3
```



# dockerä»“åº“

ä»“åº“çš„æ¦‚å¿µä¹Ÿå°±æ˜¯ç”¨äºå­˜å‚¨ï¼Œdockerä»“åº“ç”¨äºå­˜å‚¨é•œåƒã€‚

é•œåƒæ„å»ºå®Œæˆåï¼Œå¾ˆå®¹æ˜“å¯ä»¥åœ¨å®¿ä¸»æœºä¸Šè¿è¡Œï¼Œä½†æ˜¯å¦‚æœè¦åœ¨å…¶ä»–æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œåˆ™éœ€è¦è€ƒè™‘é•œåƒçš„åˆ†å‘ï¼Œå­˜å‚¨çš„é—®é¢˜ã€‚

## docker registry

é•œåƒæ³¨å†ŒæœåŠ¡å°±æ˜¯ç”¨äºæä¾›é›†ä¸­å¼çš„å­˜å‚¨ï¼Œåˆ†å‘é•œåƒçš„æœåŠ¡ã€‚

ä¸€ä¸ªDocker Registryä¸­å¯ä»¥åŒ…å«å¤šä¸ªä»“åº“ï¼ˆRepositroyï¼‰

æ¯ä¸ªä»“åº“å¯ä»¥åŒ…å«å¤šä¸ªæ ‡ç­¾ï¼ˆTagï¼‰ï¼Œæ¯ä¸ªæ ‡ç­¾å¯¹åº”ä¸€ä¸ªé•œåƒã€‚

é€šå¸¸ä¸€ä¸ªä»“åº“ä¼šåŒ…å«åŒä¸€ä¸ªè½¯ä»¶ä¸åŒç‰ˆæœ¬çš„é•œåƒ

```plain
centos8
centos7.2.xx
æ ‡ç­¾å¸¸ç”¨äºå¯¹åº”è¯¥è½¯ä»¶çš„å„ä¸ªç‰ˆæœ¬ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡
<ä»“åº“å>:<æ ‡ç­¾>
è¿™æ ·çš„æ ¼å¼æŒ‡å®šè½¯ä»¶å…·ä½“ç‰ˆæœ¬ï¼Œè‹¥ä¸ç»™å‡ºæ ‡ç­¾ï¼Œé»˜è®¤ç”¨latestä½œä¸ºé»˜è®¤æ ‡ç­¾
```

### ä»“åº“å

```plain
ä»“åº“åä¸€èˆ¬ä»¥ä¸¤æ®µå½¢å¼å‡ºç°ï¼Œä¾‹å¦‚chaoge/centos
å‰è€…æ˜¯docker registryå¤šç”¨æˆ·çš„ç”¨æˆ·åï¼Œåè€…æ˜¯è½¯ä»¶å
# å¸¸è§ç”¨æ³•
docker pull chaoge/centos:7.2.1511
```

## å…±æœ‰/ç§æœ‰/ä»“åº“

Docker Registryæœ‰ä¸¤ç§å½¢å¼

- å…¬å¼€ï¼Œå¼€æ”¾ç»™æ‰€æœ‰ç”¨æˆ·ï¼Œæä¾›ç»™æ‰€æœ‰ç”¨æˆ·æœç´¢ï¼Œæ‹‰å–ï¼Œæäº¤ï¼Œæ›´æ–°é•œåƒï¼Œè¿˜å…è´¹ä¿ç®¡ç”¨æˆ·é•œåƒæ•°æ®ã€‚

- - æ­¤ç±»æœåŠ¡å—é™äºç½‘ç»œé™åˆ¶ï¼Œæ— æ³•åŠæ—¶ç«‹å³è·å–æ‰€éœ€é•œåƒï¼Œç®€å•è¯´å°±æ˜¯éœ€è¦ç”¨ä»€ä¹ˆå¾—ç°ä¸‹è½½ï¼Œå¾—çœ‹ç½‘é€Ÿ
  - ä¼˜ç‚¹æ˜¯å¯ä»¥è·å–ç»å¤§éƒ¨åˆ†å…¬å¼€çš„é•œåƒï¼Œæ–¹ä¾¿ä½¿ç”¨

- ç§æœ‰èŒƒå›´çš„RegistryæœåŠ¡ï¼Œç”¨åœ¨å­¦æ ¡ï¼Œä¼ä¸šå†…ç½‘çš„ç ”å‘ç¯å¢ƒ

- - å±€åŸŸç½‘ç¯å¢ƒï¼Œä¿è¯äº†é•œåƒæ‹‰å–é€Ÿåº¦
  - ä¿è¯æ ¸å¿ƒé•œåƒæ•°æ®å®‰å…¨
  - å­˜åœ¨é•œåƒä¸ä¸°å¯Œé—®é¢˜

### å…¬å¼€æœåŠ¡ä»“åº“

æœ€å¸¸è§çš„Registryæ˜¯Docker Hubï¼Œä¹Ÿæ˜¯dockeré»˜è®¤å…è®¸ç”¨æˆ·ç®¡ç†é•œåƒçš„RegistryæœåŠ¡ï¼Œæ‹¥æœ‰å¤§é‡é«˜è´¨é‡çš„å®˜æ–¹é•œåƒã€‚

ç”±äºç½‘ç»œåœ°åŸŸåŸå› ï¼Œå…¬å¼€æœåŠ¡åœ¨å›½å†…è®¿é—®è¾ƒæ…¢ï¼Œä¹Ÿå°±å‡ºç°äº†é’ˆå¯¹é•œåƒæœåŠ¡çš„åŠ é€Ÿå™¨ã€‚

- é˜¿é‡Œäº‘åŠ é€Ÿå™¨
- DaoCloudåŠ é€Ÿå™¨
- çµé›€äº‘åŠ é€Ÿå™¨
- ç­‰ç­‰

ä½¿ç”¨åŠ é€Ÿå™¨ï¼Œå¯ä»¥ä»å›½å†…çš„åœ°å€è·å–Docker Hubçš„é•œåƒï¼Œé€Ÿåº¦ä¼šå¿«å¾ˆå¤šã€‚

### ç§æœ‰æœåŠ¡ä»“åº“

é™¤äº†ç§ç”¨å…¬å¼€æœåŠ¡å¤–ï¼Œè¿˜å¯ä»¥åœ¨è‡ªå·±æœ¬åœ°æ­å»ºç§æœ‰Docker Registryã€‚

å¼€æºçš„Docker Registryé•œåƒåªæä¾›äº†Docker Registry APIçš„åŠŸèƒ½ï¼Œæ²¡æœ‰å›¾å½¢åŒ–åŠŸèƒ½ã€‚

## é•œåƒæ³¨å†Œ

```plain
1.æ³¨å†Œdockerå®˜ç½‘ç»´æŠ¤çš„å¤§å‹å…¬å…±ä»“åº“ Docker Hub
https://hub.docker.com/
```

2.æ³¨å†Œå®Œæ¯•è´¦å·åï¼Œå¯ä»¥æ ¹æ®è‡ªå·±éœ€è¦ï¼Œåˆ›å»ºï¼Œå…¬å¼€/ç§æœ‰çš„é•œåƒä»“åº“ã€‚

![img](äº‘è®¡ç®—.assets/1610862050303-9308917c-e78d-4c2c-9086-5631ec10c405.png)

## æ“ä½œä½¿ç”¨å…±æœ‰ä»“åº“

```plain
docker search é•œåƒå
```

## åŠ é€Ÿå™¨é…ç½®

```plain
1.ä¿®æ”¹dockeré…ç½®æ–‡ä»¶
[root@docker01 my_docker]# cat /etc/docker/daemon.json
{"registry-mirrors": ["https://reg-mirror.qiniu.com"]}
2.é‡å¯docker
[root@docker01 my_docker]# systemctl daemon-reload
[root@docker01 my_docker]# systemctl restart docker
```

## ç§æœ‰ä»“åº“éƒ¨ç½²

Repositoryæ˜¯é›†ä¸­å­˜æ”¾é•œåƒçš„åœ°æ–¹ï¼Œä¸”ç§æœ‰ä»“åº“ä¼˜ç‚¹æ˜¯

- çœè´·æ¬¾
- ä¼ è¾“é€Ÿåº¦å¿«
- æ–¹ä¾¿å­˜å‚¨

å½“å¼€å‘è€…ç¼–è¯‘å®ŒæˆImageä¹‹åï¼Œå°±å¯ä»¥æ¨é€åˆ°Registryäº†ï¼Œå…¬å¼€æˆ–ç§æœ‰çš„çš†å¯ã€‚

```plain
1.è·å–registryé•œåƒï¼ŒåŠ ä¸Šå‚æ•°ï¼Œç¡®ä¿æ¯æ¬¡é‡å¯
docker run -d \
      --name cc_registry \
      --restart=always \
    -p 5000:5000 \
    -v /opt/data/registry:/var/lib/registry \
    registry
[root@docker01 my_docker]# docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
1979dd1975f0        registry            "/entrypoint.sh /etcâ€¦"   2 seconds ago       Up 1 second         0.0.0.0:5000->5000/tcp   cc_registry
2.æ¨é€æœ¬åœ°é•œåƒåˆ°ç§æœ‰ä»“åº“ä¸­
# å¿…é¡»å…ˆä¿®æ”¹é•œåƒåï¼Œä»¥
ä»“åº“åœ°å€/è½¯ä»¶å å½¢å¼ä¸Šä¼ 
[root@docker01 my_docker]# docker tag hello-world 10.0.1.70:5000/cc-hello-world:latest
[root@docker01 my_docker]# docker images |grep hello
10.0.1.70:5000/cc-hello-world   latest              bf756fb1ae65        8 months ago        13.3kB
hello-world                     latest              bf756fb1ae65        8 months ago        13.3kB
3.ä¸Šä¼ åˆ°ç§æœ‰ä»“åº“
æ³¨æ„ï¼Œè¦ä¿®æ”¹dockeré…ç½®æ–‡ä»¶
[root@docker01 my_docker]# cat /etc/docker/daemon.json
{"registry-mirrors": ["https://reg-mirror.qiniu.com"],"insecure-registries":["10.0.1.70:5000"]}
[root@docker01 my_docker]# systemctl restart docker
# æ¨é€æœ¬åœ°é•œåƒ
[root@docker01 my_docker]# docker push 10.0.1.70:5000/cc-hello-world
The push refers to repository [10.0.1.70:5000/cc-hello-world]
9c27e219663c: Pushed
latest: digest: sha256:90659bf80b44ce6be8234e6ff90a1ac34acbeb826903b02cfa0da11c82cbc042 size: 525
4.é€šè¿‡docker apiæŸ¥è¯¢é•œåƒä¿¡æ¯
[root@docker01 my_docker]# curl -s  127.0.0.1:5000/v2/_catalog | python -m json.tool
{
    "repositories": [
        "cc-hello-world"
    ]
}
5.æ­¤æ—¶å¯ä»¥åˆ æ‰æœ¬åœ°é•œåƒ
6.ä»ç§æœ‰ä»“åº“ä¸­ä¸‹è½½é•œåƒ
[root@docker01 my_docker]# docker pull 10.0.1.70:5000/cc-hello-world
```



# Dockerå­˜å‚¨&ç½‘ç»œ&API

# Dockerå­˜å‚¨

## æ•°æ®å·Data Volumes

æˆ‘ä»¬ä½¿ç”¨dockerå®¹å™¨ï¼Œä¹Ÿéœ€è¦å…³æ³¨å®¹å™¨å†…çš„å­˜å‚¨

Data Volumesæ˜¯ä¸€ä¸ªå¯ä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä½¿ç”¨çš„ç‰¹æ®Šç›®å½•

- æ•°æ®å·å¯ä»¥åœ¨å®¹å™¨å†…å…±äº«å’Œé‡ç”¨
- æ•°æ®å·çš„ä¿®æ”¹ä¼šç«‹å³ç”Ÿæ•ˆ
- æ•°æ®å·çš„æ›´æ–°ï¼Œä¸å›å½±å“é•œåƒ
- æ•°æ®å·ä¼šä¸€ç›´å­˜åœ¨ï¼Œå³ä½¿å®¹å™¨è¢«åˆ é™¤

æ•°æ®å·çš„ç”¨æ³•ç±»ä¼¼äºLinuxçš„mountæŒ‚è½½æ“ä½œ

**é•œåƒä¸­è¢«æŒ‡å®šä¸ºæŒ‚è½½ç‚¹çš„ç›®å½•**

å…¶ä¸­æ–‡ä»¶ä¼šè¢«éšè—ï¼Œæ˜¾ç¤ºæŒ‚è½½çš„æ•°æ®å·ã€‚

## æ•°æ®å·å®¹å™¨Data Volume Containers

æ•°æ®å·å®¹å™¨æ¶‰åŠå®¹å™¨é—´å…±äº«çš„æŒä¹…åŒ–ã€åºåˆ—åŒ–çš„æ•°æ®ã€‚

æ•°æ®å·å®¹å™¨å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å®¹å™¨ï¼Œä¸“é—¨ç”¨äºæä¾›æ•°æ®å·ä¾›ç»™å…¶ä»–å®¹å™¨æŒ‚è½½ä½¿ç”¨ã€‚

## åˆ›å»ºæ•°æ®å·

```plain
1.å¯åŠ¨å®¹å™¨æ—¶å€™ï¼Œç”¨-vå‚æ•° æŒ‡å®šæŒ‚è½½ä¸€ä¸ªæœ¬åœ°ä¸»æœºç›®å½•åˆ°å®¹å™¨ä¸­å»
# æ­¤æ—¶å®¹å™¨ä¼šè‡ªåŠ¨åˆ›å»ºå¦‚ä¸‹çš„ç›®å½•
# å®¿ä¸»æœºçš„/chaoge_webç›®å½•ä¼šå’Œå®¹å™¨å†…çš„/webappç›®å½•ä½œæŒ‚è½½å…³ç³»
[root@docker01 ~]# docker run -d -P --name cc_web -v /chaoge_web:/webapp training/webapp
e5c38e028290d45efed6b7e6af6e370d757bf2a9a51eca73e63629a20cf8e46e
# æ­¤æ—¶æˆ‘ä»¬å¯ä»¥åœ¨/chaoge_webç›®å½•å†™å…¥æ•°æ®ï¼Œè¿›å…¥å®¹å™¨æŸ¥çœ‹æŒ‚è½½ç‚¹çš„æ•°æ®
2.ä¸Šè¿°æŒ‚è½½å‘½ä»¤ï¼Œé»˜è®¤æƒé™æ˜¯è¯»å†™ï¼Œç”¨æˆ·å¯ä»¥æŒ‡å®šæƒé™ï¼Œé™åˆ¶æŒ‚è½½ç‚¹çš„æ“ä½œ
[root@docker01 ~]# docker run -d -P --name web -v /chaoge_web:/webapp:ro training/webapp python app.py
34c8eaba91969a6f6aedc5c698473dca0b296be72d20fe0cc9129ff05246e1a1
# æ­¤æ—¶åœ¨å®¿ä¸»æœº/chaoge_webç›®å½•å†™å…¥æ•°æ®ï¼Œè¿›å…¥å®¹å™¨å†…æŒ‚è½½ç‚¹ï¼Œå‘ç°æ˜¯åªè¯»æ–‡ä»¶ç³»ç»Ÿ
```

## æŸ¥çœ‹æ•°æ®å·å…·ä½“ä¿¡æ¯

```plain
[root@docker01 chaoge_web]# docker inspect web 
# éƒ¨åˆ†ä¿¡æ¯å¦‚ä¸‹
  "Mounts": [
            {
                "Type": "bind",
                "Source": "/chaoge_web",
                "Destination": "/webapp",
                "Mode": "ro",
                "RW": false,
                "Propagation": "rprivate"
            }
        ],
```

å¯ä»¥å†å¯ä¸€ä¸ªå®¹å™¨ï¼ŒæŸ¥çœ‹æ•°æ®å·æŒ‚è½½

```plain
1.å¯åŠ¨å‘½ä»¤
[root@docker01 chaoge_web]# docker run -d -P --name web02 -v /webapp training/webapp python app.py
0770c34853d5ff43a93944f8042130ad5935cc2d10a32cbe068c43e29412a64a
2.æŸ¥çœ‹æ•°æ®å·æŒ‚è½½æƒ…å†µ
        "Mounts": [
            {
                "Type": "volume",
                "Name": "6e94214c1fc99c20670eabfcae81e1d7cd6d27508b7ff1feb06161071ac12163",
                "Source": "/var/lib/docker/volumes/6e94214c1fc99c20670eabfcae81e1d7cd6d27508b7ff1feb06161071ac12163/_data",
                "Destination": "/webapp",
                "Driver": "local",
                "Mode": "",
                "RW": true,
                "Propagation": ""
            }
        ],
```

## åˆ›å»ºæ•°æ®å·/å®¹å™¨

```plain
1.åˆ›å»ºæ•°æ®å·å®¹å™¨
[root@docker01 _data]# docker run -d -v /dbdata --name dbdata training/postgres
2.åœ¨å…¶ä»–å®¹å™¨ä¸­ä½¿ç”¨--volumes-from æ¥æŒ‚è½½dbdataä¸­çš„æ•°æ®å·
[root@docker01 _data]# docker run -d --volumes-from dbdata --name db1 training/postgres
1b497a4e1c0a2b4cbd9c05df28947061a077550f9860aa27aa6aec0070e6296b
[root@docker01 _data]# docker run -d --volumes-from dbdata --name db2 training/postgres
31945794f2d357cdffdf5aabd1919390bcf04d2bc5b42a02949c5c9778e63c15
[root@docker01 _data]#
[root@docker01 _data]#
[root@docker01 _data]# docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS               NAMES
31945794f2d3        training/postgres   "su postgres -c '/usâ€¦"   3 seconds ago        Up 1 second         5432/tcp            db2
1b497a4e1c0a        training/postgres   "su postgres -c '/usâ€¦"   7 seconds ago        Up 5 seconds        5432/tcp            db1
cf4220beca71        training/postgres   "su postgres -c '/usâ€¦"   About a minute ago   Up About a minute   5432/tcp            dbdata
3.æŸ¥çœ‹æ•°æ®å·æŒ‚è½½æƒ…å†µ
[root@docker01 _data]# docker inspect db2 |grep -i volume
            "VolumeDriver": "",
            "VolumesFrom": [
                "Type": "volume",
                "Source": "/var/lib/docker/volumes/b59cf0766e072a4b0d84f4ac360b0de7f24ccc3e96ee369bd94aa624705e3607/_data",
            "Volumes": null,
```

å›¾è§£æŒ‚è½½

![img](äº‘è®¡ç®—.assets/1610862090552-f530a975-d092-4c7f-a304-506c87d7d368.png)

# Dockerç½‘ç»œ

æˆ‘ä»¬ä½¿ç”¨å®¹å™¨ï¼Œä¸å•æ˜¯è¿è¡Œå•æœºç¨‹åºï¼Œå½“ç„¶æ˜¯éœ€è¦è¿è¡Œç½‘ç»œæœåŠ¡åœ¨å®¹å™¨ä¸­ï¼Œé‚£ä¹ˆå¦‚ä½•é…ç½®dockerçš„å®¹å™¨ç½‘ç»œï¼ŒåŸºç¡€ç½‘ç»œé…ç½®ï¼Œç½‘æ¡¥é…ç½®ï¼Œç«¯å£æ˜ å°„ï¼Œè¿˜æ˜¯å¾ˆé‡è¦ã€‚

## dockerç½‘ç»œåŠŸèƒ½

dockerçš„ç½‘ç»œåŠŸèƒ½å°±æ˜¯åˆ©ç”¨Linuxçš„`network namespace`ï¼Œ`network bridge`ï¼Œè™šæ‹Ÿç½‘ç»œè®¾å¤‡å®ç°çš„ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œdockerå®‰è£…å®Œæ¯•ä¼šç”Ÿæˆç½‘æ¡¥`docker0`

dockerçš„ç½‘ç»œæ¥å£é»˜è®¤éƒ½æ˜¯è™šæ‹Ÿçš„ç½‘ç»œæ¥å£ã€‚

Dockerå®¹å™¨ç½‘ç»œåœ¨å®¿ä¸»æœºå’Œå®¹å™¨å†…åˆ†åˆ«åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæ¥å£ï¼Œè®©ä»–ä»¬å½¼æ­¤é€šä¿¡ã€‚

```plain
# é»˜è®¤çš„ç½‘æ¡¥
[root@docker01 db_backup]# ifconfig
docker0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
        inet6 fe80::42:8dff:fe7b:916f  prefixlen 64  scopeid 0x20<link>
        ether 02:42:8d:7b:91:6f  txqueuelen 0  (Ethernet)
        RX packets 105087  bytes 4543670 (4.3 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 134319  bytes 628048552 (598.9 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

dockeråˆ›å»ºä¸€ä¸ªå®¹å™¨çš„æµç¨‹

- åˆ›å»ºä¸€å¯¹è™šæ‹Ÿæ¥å£ï¼Œåˆ†åˆ«æ”¾åˆ°æœ¬åœ°ä¸»æœºå’Œæ–°å®¹å™¨ä¸­ã€‚
- å®¿ä¸»æœºä¸€ç«¯æ¡¥æ¥åˆ°é»˜è®¤çš„docker0ï¼Œä¸”æœ‰ä¸€ä¸ªå”¯ä¸€çš„åå­—ã€‚
- å¦ä¸€ç«¯æ”¾å…¥å®¹å™¨é‡Œï¼Œæ”¹åä¸ºeth0ï¼Œè¯¥æ¥å£åªèƒ½åœ¨å®¹å™¨çš„å‘½åç©ºé—´é‡Œå¯è§ã€‚
- ä»ç½‘æ¡¥å¯ç”¨åœ°å€æ®µè·å–ä¸€ä¸ªç©ºé—²ipï¼Œåˆ†é…ç»™å®¹å™¨çš„eth0ï¼Œä¸”é…ç½®é»˜è®¤è·¯ç”±æ¡¥æ¥åˆ°å®¿ä¸»æœºç½‘å¡
- å®Œæˆè¿™äº›ä¹‹åï¼Œå®¹å™¨å¯ä»¥ä½¿ç”¨eth0è™šæ‹Ÿç½‘å¡å’Œå…¶ä»–å®¹å™¨è¿æ¥ã€‚

![img](äº‘è®¡ç®—.assets/1610862090546-ac527c99-5c41-44f0-bb7a-e6f12f5f96c4.png)

```plain
docker run å¯åŠ¨çš„æ—¶å€™ï¼Œè‹¥æ²¡æœ‰æ·»åŠ --netå‚æ•°ï¼Œé»˜è®¤ä½¿ç”¨bridgeæ¡¥æ¥æ¨¡å¼
dockerå®é™…æ˜¯é€šè¿‡iptablesåšäº†DNATè§„åˆ™ï¼Œå®ç°ç«¯å£è½¬å‘
```

## --netå‚æ•°

```plain
--net=bridge è¿™ä¸ªæ˜¯é»˜è®¤å€¼ï¼Œè¿æ¥åˆ°é»˜è®¤çš„ç½‘æ¡¥ã€‚
--net=host å‘Šè¯‰ Docker ä¸è¦å°†å®¹å™¨ç½‘ç»œæ”¾åˆ°éš”ç¦»çš„å‘½åç©ºé—´ä¸­ï¼Œå³ä¸è¦å®¹å™¨åŒ–å®¹å™¨å†…çš„ç½‘ç»œã€‚æ­¤æ—¶å®¹å™¨ä½¿ç”¨æœ¬åœ°ä¸»æœºçš„ç½‘ç»œï¼Œå®ƒæ‹¥æœ‰å®Œå…¨çš„æœ¬åœ°ä¸»æœºæ¥å£è®¿é—®æƒé™ã€‚å®¹å™¨è¿›ç¨‹å¯ä»¥è·Ÿä¸»æœºå…¶å®ƒ root è¿›ç¨‹ä¸€æ ·å¯ä»¥æ‰“å¼€ä½èŒƒå›´çš„ç«¯å£ï¼Œå¯ä»¥è®¿é—®æœ¬åœ°ç½‘ç»œæœåŠ¡æ¯”å¦‚ D-busï¼Œè¿˜å¯ä»¥è®©å®¹å™¨åšä¸€äº›å½±å“æ•´ä¸ªä¸»æœºç³»ç»Ÿçš„äº‹æƒ…ï¼Œæ¯”å¦‚é‡å¯ä¸»æœºã€‚å› æ­¤ä½¿ç”¨è¿™ä¸ªé€‰é¡¹çš„æ—¶å€™è¦éå¸¸å°å¿ƒã€‚å¦‚æœè¿›ä¸€æ­¥çš„ä½¿ç”¨ --privileged=trueï¼Œå®¹å™¨ä¼šè¢«å…è®¸ç›´æ¥é…ç½®ä¸»æœºçš„ç½‘ç»œå †æ ˆã€‚
--net=container:NAME_or_ID è®© Docker å°†æ–°å»ºå®¹å™¨çš„è¿›ç¨‹æ”¾åˆ°ä¸€ä¸ªå·²å­˜åœ¨å®¹å™¨çš„ç½‘ç»œæ ˆä¸­ï¼Œæ–°å®¹å™¨è¿›ç¨‹æœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹åˆ—è¡¨å’Œèµ„æºé™åˆ¶ï¼Œä½†ä¼šå’Œå·²å­˜åœ¨çš„å®¹å™¨å…±äº« IP åœ°å€å’Œç«¯å£ç­‰ç½‘ç»œèµ„æºï¼Œä¸¤è€…è¿›ç¨‹å¯ä»¥ç›´æ¥é€šè¿‡ lo ç¯å›æ¥å£é€šä¿¡ã€‚
--net=none è®© Docker å°†æ–°å®¹å™¨æ”¾åˆ°éš”ç¦»çš„ç½‘ç»œæ ˆä¸­ï¼Œä½†æ˜¯ä¸è¿›è¡Œç½‘ç»œé…ç½®ã€‚ä¹‹åï¼Œç”¨æˆ·å¯ä»¥è‡ªå·±è¿›è¡Œé…ç½®ã€‚
```

å®¹å™¨ç»“æŸåï¼Œdockerä¼šæ™´ç©ºå®¹å™¨ï¼Œè¿ç€å®¹å™¨å†…çš„eth0ä¼šéšç€ç½‘ç»œå‘½åç©ºé—´ä¸€èµ·è¢«æ¸…é™¤ã€‚

### dockeré«˜çº§ç½‘ç»œé…ç½®

é¦–å…ˆï¼Œè¦å®ç°ç½‘ç»œé€šä¿¡ï¼Œæœºå™¨éœ€è¦è‡³å°‘ä¸€ä¸ªç½‘ç»œæ¥å£ï¼ˆç‰©ç†æ¥å£æˆ–è™šæ‹Ÿæ¥å£ï¼‰æ¥æ”¶å‘æ•°æ®åŒ…ï¼›æ­¤å¤–ï¼Œå¦‚æœä¸åŒå­ç½‘ä¹‹é—´è¦è¿›è¡Œé€šä¿¡ï¼Œéœ€è¦è·¯ç”±æœºåˆ¶ã€‚

Docker ä¸­çš„ç½‘ç»œæ¥å£é»˜è®¤éƒ½æ˜¯è™šæ‹Ÿçš„æ¥å£ã€‚è™šæ‹Ÿæ¥å£çš„ä¼˜åŠ¿ä¹‹ä¸€æ˜¯è½¬å‘æ•ˆç‡è¾ƒé«˜ã€‚ Linux é€šè¿‡åœ¨å†…æ ¸ä¸­è¿›è¡Œæ•°æ®å¤åˆ¶æ¥å®ç°è™šæ‹Ÿæ¥å£ä¹‹é—´çš„æ•°æ®è½¬å‘ï¼Œå‘é€æ¥å£çš„å‘é€ç¼“å­˜ä¸­çš„æ•°æ®åŒ…è¢«ç›´æ¥å¤åˆ¶åˆ°æ¥æ”¶æ¥å£çš„æ¥æ”¶ç¼“å­˜ä¸­ã€‚å¯¹äºæœ¬åœ°ç³»ç»Ÿå’Œå®¹å™¨å†…ç³»ç»Ÿçœ‹æ¥å°±åƒæ˜¯ä¸€ä¸ªæ­£å¸¸çš„ä»¥å¤ªç½‘å¡ï¼Œåªæ˜¯å®ƒä¸éœ€è¦çœŸæ­£åŒå¤–éƒ¨ç½‘ç»œè®¾å¤‡é€šä¿¡ï¼Œé€Ÿåº¦è¦å¿«å¾ˆå¤šã€‚

Docker å®¹å™¨ç½‘ç»œå°±åˆ©ç”¨äº†è¿™é¡¹æŠ€æœ¯ã€‚å®ƒåœ¨æœ¬åœ°ä¸»æœºå’Œå®¹å™¨å†…åˆ†åˆ«åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæ¥å£ï¼Œå¹¶è®©å®ƒä»¬å½¼æ­¤è¿é€šï¼ˆè¿™æ ·çš„ä¸€å¯¹æ¥å£å«åš `veth pair`ï¼‰ã€‚

![img](äº‘è®¡ç®—.assets/1610862090552-e78fcd28-462b-4985-a3a2-a6c8c43e07de.png)

dockeråœ¨å¯åŠ¨æ—¶ï¼Œåœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªdocker0è™šæ‹Ÿç½‘æ¡¥ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªLinuxçš„ç½‘æ¡¥ï¼Œç†è§£å°±æ˜¯ä¸€ä¸ªè½¯ä»¶äº¤æ¢æœºã€‚

dockeréšæœºåˆ†é…ä¸€ä¸ªæœ¬åœ°æœªå ç”¨çš„ç§æœ‰ç½‘æ–­åœ°å€ç»™docker0æ¥å£ã€‚ä¾‹å¦‚`172.17.42.1 å­ç½‘æ©ç 255.255.0.0`

æ­¤åå¯åŠ¨çš„å®¹å™¨æ¥å£ä¹Ÿä¼šåˆ†é…ä¸€ä¸ªåŒä¸€ç½‘æ®µ`172.17.0.0/16`

å½“åˆ›å»ºä¸€ä¸ªDockerå®¹å™¨çš„æ—¶å€™ï¼ŒåŒæ—¶åˆ›å»ºä¸€å¯¹`veth pair(æ•°æ®åŒ…å‘é€åˆ°ä¸€ä¸ªæ¥å£æ—¶ï¼Œå¦ä¸€ä¸ªæ¥å£ä¹Ÿä¼šå¾—åˆ°åŒæ ·æ•°æ®åŒ…)`æ¥å£

è¿™æ ·çš„æ¥å£ä¸€ç«¯åœ¨å®¹å™¨ï¼Œå³eth0ï¼Œå¦ä¸€ç«¯åœ¨å®¿ä¸»æœºï¼Œå¹¶ä¸”æŒ‚è½½åˆ°bridge0ï¼Œä¾‹å¦‚veth***ã€‚

è¿™æ ·ï¼Œä¸»æœºå°±å¯ä»¥å’Œå®¹å™¨é€šä¿¡ï¼Œå®¹å™¨ä¹‹é—´ä¹Ÿå¯ä»¥ç›¸äº’é€šä¿¡äº†ã€‚

å¦‚ä¸‹ï¼Œä¸‰ä¸ªå®¹å™¨ï¼Œä¸‰ä¸ªè™šæ‹Ÿç½‘ç»œæ¥å£

![img](äº‘è®¡ç®—.assets/1610862090555-9bef29a4-cec1-4e78-a498-0d166bf5a2b9.png)

## é…ç½®å®¹å™¨ç½‘ç»œ

### --net=none

```plain
1.è¯¥å‚æ•°ç”¨æˆ·å¯ä»¥è‡ªè¡Œé…ç½®ç½‘ç»œï¼Œè®©å®¹å™¨å¯ä»¥è®¿é—®ç½‘ç»œæƒé™
[root@docker01 db_backup]# docker run -it --rm --net=none centos /bin/bash
[root@77cfd664d329 /]# 
# æ­¤æ—¶å®¹å™¨æ˜¯æ²¡æœ‰ç½‘ç»œæ¥å£çš„
[root@77cfd664d329 /]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2.æŸ¥æ‰¾å®¹å™¨è¿›ç¨‹çš„pidï¼Œä¸”åˆ›å»ºç½‘ç»œå‘½åç©ºé—´ï¼Œæ³¨æ„è¿™é‡Œå†å¼€ä¸€ä¸ªçª—å£
[root@docker01 ~]# docker inspect -f '{{.State.Pid}}' 77c
46882
[root@docker01 ~]# pid=46882
[root@docker01 ~]# mkdir -p /var/run/netns
[root@docker01 ~]# ln -s /proc/$pid/ns/net /var/run/netns/$pid
3.æ£€æŸ¥æ¡¥æ¥ç½‘å¡çš„ipå’Œæ©ç ä¿¡æ¯
[root@docker01 ~]# ip addr show docker0
3: docker0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:8d:7b:91:6f brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:8dff:fe7b:916f/64 scope link
       valid_lft forever preferred_lft forever
4.åˆ›å»ºä¸€å¯¹è™šæ‹Ÿæ¥å£ï¼ŒAå’ŒBï¼Œç»‘å®šAåˆ°ç½‘æ¡¥docker0ï¼Œä¸”å¯ç”¨å®ƒã€‚
[root@docker01 ~]# ip link add A type veth peer name B
# å®‰è£…ç½‘æ¡¥ç®¡ç†å·¥å…·
[root@docker01 ~]# yum install bridge-utils -y
[root@docker01 ~]# brctl addif docker0 A
[root@docker01 ~]# ip link set A up
5.å°†Bæ”¾å…¥å®¹å™¨çš„ç½‘ç»œåç§°ç©ºé—´ï¼Œå‘½åä¸ºeth0
[root@docker01 ~]# ip link set B netns $pid
[root@docker01 ~]# ip netns exec $pid ip link set dev B name eth0
[root@docker01 ~]# ip netns exec $pid ip link set eth0 up
[root@docker01 ~]# ip netns exec $pid ip addr add 172.17.42.99/16 dev eth0
[root@docker01 ~]# ip netns exec $pid ip route add default via 172.17.42.1
```

![img](äº‘è®¡ç®—.assets/1610862090570-02d0d885-211f-4636-a633-0d076e128e48.png)

è‡³æ­¤ï¼Œè‡ªå®šä¹‰dockerç½‘ç»œè¿‡ç¨‹ç»“æŸã€‚

## é…ç½®å®¹å™¨ç«¯å£

å®¹å™¨é‡Œè¿è¡ŒwebæœåŠ¡ï¼Œæ˜¯åŸºæœ¬éœ€æ±‚ï¼Œæƒ³è¦è®©å¤–éƒ¨è®¿é—®å®¹å™¨å†…åº”ç”¨ï¼Œå¯ä»¥é€šè¿‡å‚æ•°

```plain
-p  port:port
-P  éšæœºport:port
å®¿ä¸»æœºï¼šå®¹å™¨
```

![img](äº‘è®¡ç®—.assets/1610862090600-5c26055a-26e0-4b64-8570-b96c1ade72eb.png)

## -Péšæœºæ˜ å°„

```plain
1.ä½¿ç”¨-P å‚æ•°
dockeréšæœºæ˜ å°„ç«¯å£åˆ°å®¹å™¨å†…éƒ¨æ‰“å¼€çš„ç«¯å£ã€‚ä¹Ÿå°±æ˜¯dockerfiler EXPOSEæŒ‡ä»¤ æ‰“å¼€çš„ç«¯å£
[root@docker01 db_backup]# docker run -d -P training/webapp python app.py
58c26b81a390de884aee7cd51090e169a6d5eb987d3f548f082e760f00b0e3e5
[root@docker01 db_backup]# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                     NAMES
58c26b81a390        training/webapp     "python app.py"     2 seconds ago       Up 1 second         0.0.0.0:32778->5000/tcp   distracted_hermann
2.æ£€æŸ¥ç«¯å£è½¬å‘æƒ…å†µ
[root@docker01 db_backup]# docker port 58c
5000/tcp -> 0.0.0.0:32778
3.æ£€æŸ¥å®¹å™¨å†…æ—¥å¿—ä¿¡æ¯ï¼Œå¯ä»¥åŠ ä¸Š-få‚æ•°
[root@docker01 db_backup]# docker logs 58c
 * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)
```

![img](äº‘è®¡ç®—.assets/1610862090593-8b5df0d7-72a1-4160-8536-812a4486f00e.png)

## -pæŒ‡å®šç«¯å£æ˜ å°„

```plain
[root@docker01 db_backup]# docker run -d -p 5000:5000 training/webapp python app.py
f9f92b81ee097c0ca584ed8551f07735ce60b8903c6b5e5ca9a4c2a01b91cc9f
[root@docker01 db_backup]# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                     NAMES
f9f92b81ee09        training/webapp     "python app.py"     3 seconds ago       Up 2 seconds        0.0.0.0:5000->5000/tcp    intelligent_benz
58c26b81a390        training/webapp     "python app.py"     28 minutes ago      Up 28 minutes       0.0.0.0:32778->5000/tcp   distracted_hermann
-på‚æ•°è¯­æ³•
å®¿ä¸»æœºè®¿é—®çš„ç«¯å£:å®¹å™¨å†…ç«¯å£
# æŸ¥çœ‹å®¿ä¸»æœºç«¯å£æƒ…å†µ
[root@docker01 db_backup]# netstat -tunlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      45472/sshd
tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1361/master
tcp6       0      0 :::32778                :::*                    LISTEN      50118/docker-proxy
tcp6       0      0 :::5000                 :::*                    LISTEN      51660/docker-proxy
tcp6       0      0 :::22                   :::*                    LISTEN      45472/sshd
tcp6       0      0 ::1:25                  :::*                    LISTEN      1361/master
```

æ­¤ç±»å†™æ³•ï¼Œé»˜è®¤æ˜¯ç»‘å®šåˆ°å®¿ä¸»æœºæ‰€æœ‰åœ°å€ï¼Œå¦‚

- 127.0.0.1
- 0.0.0.0

### ç»‘å®šæŒ‡å®šåœ°å€

æ­¤æ—¶å®¹å™¨å†…æœåŠ¡ï¼Œåªèƒ½åœ¨å®¿ä¸»æœºæœ¬åœ°è®¿é—®äº†

```plain
[root@docker01 db_backup]#
[root@docker01 db_backup]# docker run -d -p 127.0.0.1:5000:5000 training/webapp python app.py
0746b0626ee5baceb291b76bab3f4a3eca6ec3e2cacb35e0b8df55b57f05bb30
[root@docker01 db_backup]# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                      NAMES
0746b0626ee5        training/webapp     "python app.py"     3 seconds ago       Up 1 second         127.0.0.1:5000->5000/tcp   eloquent_raman
[root@docker01 db_backup]#
[root@docker01 db_backup]#
[root@docker01 db_backup]# netstat -tunlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 127.0.0.1:5000          0.0.0.0:*               LISTEN      53557/docker-proxy
```

## é…ç½®å®¹å™¨äº’è”link

å®¹å™¨çš„è¿æ¥ï¼Œä¸Šè¿°è¶…å“¥è®²è§£äº†ï¼Œå¯ä»¥é€šè¿‡ç½‘æ¡¥å½¢å¼é€šä¿¡ï¼Œè¿˜å¯ä»¥åœ¨å®¹å™¨ä¹‹é—´æŒ‡å®šè¿æ¥æ–¹å¼ã€‚

é€šè¿‡`linking`å½¢å¼ï¼Œåœ¨å®¹å™¨ä¹‹é—´åˆ›å»ºéš§é“ã€‚

```plain
1.åˆ›å»ºå®¹å™¨ä¸”å‘½å
[root@docker01 db_backup]# docker run -d -P --name web01 training/webapp python app.py
2.æŸ¥çœ‹å®¹å™¨å
[root@docker01 db_backup]# docker ps -l
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                     NAMES
ad8b97933b31        training/webapp     "python app.py"     5 seconds ago       Up 3 seconds        0.0.0.0:32779->5000/tcp   web01
3.é€šè¿‡docker inspectæŸ¥çœ‹
[root@docker01 db_backup]# docker inspect -f "{{.Name}}" ad8
/web01
```

### å®¹å™¨äº’è”æ“ä½œ

çˆ¶å®¹å™¨ï¼šweb01

å­å®¹å™¨ï¼šdb

```plain
1.åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“å®¹å™¨
[root@docker01 db_backup]# docker run -d --name db training/postgres
e7815c6d7e9095a4224b28080da86a206c851e51367282c5a79f29bf1c769f6a
[root@docker01 db_backup]# docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                     NAMES
e7815c6d7e90        training/postgres   "su postgres -c '/usâ€¦"   2 seconds ago       Up 2 seconds        5432/tcp                  db
ad8b97933b31        training/webapp     "python app.py"          2 minutes ago       Up 2 minutes        0.0.0.0:32779->5000/tcp   web01
2.åˆ é™¤ä¹‹å‰çš„å®¹å™¨ï¼Œé‡æ–°åˆ›å»ºï¼Œä¸”å»ºç«‹è¿æ¥å…³ç³»
[root@docker01 db_backup]# docker rm -f web01
web01
3.é‡æ–°åˆ›å»ºï¼ŒåŠ ä¸Š--link
[root@docker01 db_backup]# docker run -d -P --name web01 --link db:db training/webapp python app.py
d947259fcaf27cf54cde66a673999db5b85917dcd9c603e6f432a8e5d5b488ff
```

`--link`å‚æ•°æ ¼å¼è¯­æ³•

```plain
--link name:alias
nameæ˜¯éœ€è¦è¿æ¥çš„å®¹å™¨å
aliasæ˜¯è¿æ¥çš„åˆ«å
```

æŸ¥çœ‹å®¹å™¨è¿›ç¨‹ä¿¡æ¯ï¼ŒæŸ¥çœ‹å…·ä½“çš„`link`å…³ç³»

```plain
[root@docker01 ~]# docker inspect web01 -f "{{ .HostConfig.Links}}"
[/db:/web01/db]
```

æŸ¥çœ‹å®¹å™¨å†…ç¯å¢ƒå˜é‡envï¼Œæ£€æŸ¥æœ‰å…³dbå®¹å™¨çš„ä¿¡æ¯

ä»¥DBå¼€å¤´çš„å°±æ˜¯ç”¨äºwebå®¹å™¨è¿æ¥dbå®¹å™¨çš„ä¿¡æ¯

```plain
[root@docker01 ~]# docker exec -i  d94 env
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=d947259fcaf2
DB_PORT=tcp://172.17.0.3:5432
DB_PORT_5432_TCP=tcp://172.17.0.3:5432
DB_PORT_5432_TCP_ADDR=172.17.0.3
DB_PORT_5432_TCP_PORT=5432
DB_PORT_5432_TCP_PROTO=tcp
DB_NAME=/web01/db
DB_ENV_PG_VERSION=9.3
HOME=/root
```

é™¤äº†ç¯å¢ƒå˜é‡å¤–ï¼Œdockerä½¿ç”¨--linkå‚æ•°ï¼Œè¿˜ä¼šä¿®æ”¹çˆ¶å®¹å™¨çš„hostsæ–‡ä»¶ï¼Œä¹Ÿå°±web01å®¹å™¨

åœ¨web01ç‚¹hostsæ–‡ä»¶ä¸­å†™äº†å­å®¹å™¨çš„ä¸»æœºåè§£æå…³ç³»ã€‚

```plain
[root@docker01 ~]# docker exec -i web01 cat /etc/hosts
127.0.0.1    localhost
::1    localhost ip6-localhost ip6-loopback
fe00::0    ip6-localnet
ff00::0    ip6-mcastprefix
ff02::1    ip6-allnodes
ff02::2    ip6-allrouters
172.17.0.3    db e7815c6d7e90
172.17.0.2    d947259fcaf2
```

## å®¹å™¨è®¿é—®æ§åˆ¶

å®¹å™¨çš„è®¿é—®æ§åˆ¶ï¼Œä¸»è¦é€šè¿‡Linuxçš„iptablesé˜²ç«å¢™è¿›è¡Œç®¡ç†å’Œå®ç°ã€‚

### å®¹å™¨è®¿é—®å¤–éƒ¨ç½‘ç»œ

å®¹å™¨æƒ³è¦å’Œå¤–éƒ¨é€šä¿¡ï¼Œéœ€è¦linuxå†…æ ¸è½¬å‘æ”¯æŒ 1.æ£€æŸ¥å†…æ ¸è½¬å‘ï¼Œçœ‹åˆ°å¦‚ä¸‹ç»“æœæ‰æ­£ç¡®ï¼Œç»“æœéœ€è¦ä¸º1

```plain
[root@docker01 ~]# sysctl net.ipv4.ip_forward
net.ipv4.ip_forward = 1
```

2.ä¹Ÿå¯ä»¥åœ¨å¯åŠ¨dockeræœåŠ¡æ—¶å€™ï¼ŒæŒ‡å®šå‚æ•°--ip-forward=true dockerä¼šæ‰“å¼€ä¸Šè¿°è½¬å‘å‚æ•°

```plain
--ip-forward=true
```

3.å®¹å™¨é—´é€šä¿¡

```plain
dockerå®¹å™¨é»˜è®¤é€šè¿‡docker0ç½‘æ¡¥é€šä¿¡
æœ¬åœ°iptablesæ˜¯å¦å…è®¸é€šè¿‡
```

4.è®¿é—®æ‰€æœ‰ç«¯å£

```plain
dockerå¯åŠ¨æœåŠ¡çš„æ—¶å€™ï¼Œé»˜è®¤ä¼šæ·»åŠ ä¸€æ¡è½¬å‘ç­–ç•¥åˆ°iptablesçš„forwardé“¾ä¸Šã€‚
æŸ¥çœ‹ç­–ç•¥æ˜¯å…è®¸è¿˜æ˜¯ç¦æ­¢ã€‚
ä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°ã€‚--ice=true/false å†³å®š å…è®¸/ç¦æ­¢ å®¹å™¨é€šä¿¡ã€‚
```

5.è‹¥æ˜¯é»˜è®¤ç¦æ­¢äº†å®¹å™¨é€šä¿¡ï¼Œå¯ä»¥é€šè¿‡linké€‰æ‹©å®¹å™¨é€šä¿¡

```plain
--link ç”¨æ³•
```

6.å¤–éƒ¨è®¿é—®å®¹å™¨

```plain
é€šè¿‡docker runçš„å‚æ•° -p. -P
å®ç°å®¹å™¨ç«¯å£æ˜ å°„
```

7.æŸ¥çœ‹å®¹å™¨é»˜è®¤ç½‘æ¡¥,brctlå‘½ä»¤éœ€è¦å®‰è£…

```plain
[root@chaogelinux ~]# brctl show
bridge name    bridge id        STP enabled    interfaces
docker0        8000.0242461b94df    no        veth225675e
```

### è‡ªå®šä¹‰ç½‘æ¡¥

é™¤äº†é»˜è®¤çš„docker0ï¼Œè¿˜å¯ä»¥æŒ‡å®šç½‘æ¡¥ï¼Œè¿æ¥å®¹å™¨

```plain
å¯åŠ¨dockeræ—¶ï¼Œå¯ä»¥åŠ ä¸Šå‚æ•° 
-b bridge
--bridge=bridge 
æŒ‡å®šç½‘æ¡¥å¯åŠ¨
```

### å®è·µ

```plain
1.åœæ­¢dockeræœåŠ¡
[root@docker01 ~]# systemctl stop docker
2.åœæ­¢ç½‘æ¡¥æœåŠ¡ï¼Œå°±çœ‹ä¸åˆ°äº†
[root@docker01 ~]# ip link set dev docker0 down
[root@docker01 ~]# ifconfig
ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.0.1.70  netmask 255.255.255.0  broadcast 10.0.1.255
        inet6 fe80::ad00:1ca6:831:d693  prefixlen 64  scopeid 0x20<link>
        ether 00:0c:29:f4:60:9b  txqueuelen 1000  (Ethernet)
        RX packets 978734  bytes 1372176080 (1.2 GiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 223611  bytes 18104058 (17.2 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 332  bytes 29426 (28.7 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 332  bytes 29426 (28.7 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
3.åˆ é™¤ç½‘æ¡¥
[root@docker01 ~]# ifconfig docker0
docker0: flags=4098<BROADCAST,MULTICAST>  mtu 1500
        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
        ether 02:42:8d:7b:91:6f  txqueuelen 0  (Ethernet)
        RX packets 105275  bytes 4556332 (4.3 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 134486  bytes 628064769 (598.9 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
[root@docker01 ~]# brctl delbr docker0
[root@docker01 ~]# ifconfig  docker0
docker0: error fetching interface information: Device not found
4.åˆ›å»ºç½‘æ¡¥docker0
[root@docker01 ~]# brctl addbr bridge0
[root@docker01 ~]# ip addr add 192.168.5.1/24 dev bridge0
[root@docker01 ~]# ip link set dev bridge0 up
[root@docker01 ~]# ifconfig
bridge0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.5.1  netmask 255.255.255.0  broadcast 0.0.0.0
        inet6 fe80::346f:5ff:feb7:63f2  prefixlen 64  scopeid 0x20<link>
        ether 36:6f:05:b7:63:f2  txqueuelen 1000  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 6  bytes 508 (508.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.0.1.70  netmask 255.255.255.0  broadcast 10.0.1.255
        inet6 fe80::ad00:1ca6:831:d693  prefixlen 64  scopeid 0x20<link>
        ether 00:0c:29:f4:60:9b  txqueuelen 1000  (Ethernet)
        RX packets 979039  bytes 1372201512 (1.2 GiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 223769  bytes 18121988 (17.2 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 332  bytes 29426 (28.7 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 332  bytes 29426 (28.7 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
5.ç¡®è®¤ç½‘æ¡¥åˆ›å»ºï¼Œä¸”å¯åŠ¨äº†
[root@docker01 ~]# ip addr show bridge0
6.ä¿®æ”¹dockeré…ç½®æ–‡ä»¶ï¼Œæ·»åŠ dockeré»˜è®¤ç½‘æ¡¥è¿æ¥
[root@docker01 ~]# cat /etc/docker/daemon.json
{"registry-mirrors": ["https://reg-mirror.qiniu.com"],"insecure-registries":["10.0.1.70:5000"],"bridge":"bridge0"}
7.é‡å¯dockeræœåŠ¡
8.æ­¤æ—¶åˆ›å»ºæ–°çš„å®¹å™¨ï¼Œå·²ç»æ¡¥æ¥åˆ°äº†æ–°çš„bridge0
[root@docker01 ~]# docker run -it centos bash
[root@28b76067a253 /]# ping baidu.com
PING baidu.com (220.181.38.148) 56(84) bytes of data.
64 bytes from 220.181.38.148 (220.181.38.148): icmp_seq=1 ttl=127 time=8.90 ms
64 bytes from 220.181.38.148 (220.181.38.148): icmp_seq=2 ttl=127 time=7.81 ms
64 bytes from 220.181.38.148 (220.181.38.148): icmp_seq=3 ttl=127 time=9.57 ms
```

# Docker API

```plain
https://docs.docker.com/engine/api/v1.24/
```

APIæ˜¯ç¨‹åºå¼€å‘çš„ä¸€ä¸ªæ¥å£ï¼Œdocker apiç±»å‹åŒ…æ‹¬RESTfulï¼ŒåŸºäºHTTPåè®®å’ŒRPCåè®®ã€‚

æ‰€è°“restfulé£æ ¼å°±æ˜¯å¯¹HTTPåè®®çš„å„ç§å°è£…ï¼Œå¦‚

- get
- post
- delete
- update
- put
- ç­‰ç­‰

restfuleæœåŠ¡å™¨æä¾›è¿™äº›è¯·æ±‚çš„æ¥å£(åœ°å€ï¼Œè·¯å¾„ï¼Œå‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„urlï¼‰

dockeræä¾›äº†ä¸‰ç§APIä½¿ç”¨

- Registryï¼Œæä¾›å­˜å‚¨dockeré•œåƒçš„åŠŸèƒ½
- Docker Hub APIï¼šæä¾›äº†docker hubé›†æˆçš„åŠŸèƒ½
- Docker Remote APIï¼šæä¾›äº†å’ŒDockerå®ˆæŠ¤è¿›ç¨‹é›†æˆçš„åŠŸèƒ½ï¼ˆä¹Ÿå°±æ˜¯dockerå‘½ä»¤å„ç§æ“ä½œï¼‰

## Docker Remote API

æ ¸å¿ƒä»‹ç»docker remote apiï¼Œå› ä¸ºè¿™æ˜¯æ ¸å¿ƒdockerå‘½ä»¤æ“ä½œã€‚

dockeré»˜è®¤çš„å®ˆæŠ¤è¿›ç¨‹ä¼šç»‘å®šåœ¨æœ¬åœ°ä¸»æœºçš„å¥—æ¥å­—

```plain
é€šè¿‡é…ç½®æ–‡ä»¶æŸ¥çœ‹
[root@docker01 ~]# cat /usr/lib/systemd/system/docker.service |grep sock
Requires=docker.socket
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
```

dockerçš„å®ˆæŠ¤è¿›ç¨‹éœ€è¦rootèº«ä»½å»è¿è¡Œï¼Œå¦åˆ™ä¼šå¯¼è‡´æƒé™ä¸è¶³ï¼Œç®¡ç†èµ„æºã€‚

```plain
[root@docker01 ~]# ps -ef|grep docker
root      66459      1  0 14:05 ?        00:00:00 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
```

å¦‚æœåªæŸ¥è¯¢å®¿ä¸»æœºæœ¬åœ°çš„docker APIï¼Œé‚£ä¹ˆæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå¦‚æœæƒ³è¦è¿œç¨‹è®¿é—®ï¼Œæœ¬åœ°sockå¥—æ¥å­—æ–‡ä»¶å°±ä¸è¡Œäº†ï¼Œå¾—æŠŠdockerå®ˆæŠ¤è¿›ç¨‹ç»‘å®šåˆ°ç½‘ç»œæ¥å£ä¸Šã€‚

## remote APIæ“ä½œ

```plain
1.ä¿®æ”¹Remote APIé…ç½®ä¿¡æ¯ï¼Œæ”¹ä¸ºç½‘ç»œæ¥å£å½¢å¼
[root@docker01 ~]# cat /usr/lib/systemd/system/docker.service |grep dockerd
#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375
2.é‡å¯æœåŠ¡
[root@docker01 ~]# systemctl daemon-reload
[root@docker01 ~]# systemctl restart docker
[root@docker01 ~]# ps -ef|grep docker
root      69712      1  8 14:58 ?        00:00:00 /usr/bin/dockerd -H tcp://0.0.0.0:2375
root      69847  59079  0 14:58 pts/0    00:00:00 grep --color=auto docker
3.é€šè¿‡è¿œç¨‹ä¸»æœºï¼ŒæŸ¥çœ‹æ˜¯å¦èƒ½å¤Ÿè¿æ¥dockerå®ˆæŠ¤è¿›ç¨‹ã€‚
# è¿œç¨‹æŸ¥çœ‹é•œåƒ
[yuchao@yumac ~]$docker -H 10.0.1.70:2375 images
# è¿œç¨‹å¯åŠ¨å®¹å™¨
[yuchao@yumac ~]$docker -H 10.0.1.70:2375 run -d -P training/webapp python app.py
63df24d4f52ef96d00cb6d869c87a8d8a3be0f3f6506f63e35ede2c90de3d17d
# è¿œç¨‹æŸ¥çœ‹
[yuchao@yumac ~]$docker -H 10.0.1.70:2375 ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                     NAMES
63df24d4f52e        training/webapp     "python app.py"     8 seconds ago       Up 5 seconds        0.0.0.0:32768->5000/tcp   competent_ishizaka
4.æ­¤æ—¶å°±å·²ç»å¯ä»¥è¿œç¨‹ä½¿ç”¨docker remote apiäº†
```

## å®è·µdocker remote api

```plain
1.åœ¨dockerå®¿ä¸»æœºæœ¬åœ°å®è·µapiï¼ŒæŸ¥çœ‹dockerä¿¡æ¯ï¼Œå·²ç»å¯ä»¥é€šè¿‡httpåè®®è®¿é—®
[root@docker01 ~]# curl -s  http://127.0.0.1:2375/info |python -m json.tool
2.ç®¡ç†é•œåƒä¿¡æ¯ï¼Œè·å–dockerå®ˆæŠ¤è¿›ç¨‹é‡Œçš„åˆ—è¡¨
[root@docker01 ~]# curl -s  http://127.0.0.1:2375/images/json |python -m json.tool
3.åœ¨docker hubæœç´¢é•œåƒï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨çš„docker search ubuntuè¿™æ ·
[root@docker01 ~]# curl -s  http://127.0.0.1:2375/images/search?term="ubuntu" |python -m json.tool
4.é€šè¿‡APIç®¡ç†å®¹å™¨
[root@docker01 ~]# curl -s  http://127.0.0.1:2375/containers/json  |python -m json.tool
è¿™æ¡å‘½ä»¤ï¼Œå°±ç­‰åŒäº
[root@docker01 ~]# docker  -H 127.0.0.1:2375 ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                     NAMES
63df24d4f52e        training/webapp     "python app.py"     9 minutes ago       Up 9 minutes        0.0.0.0:32768->5000/tcp   competent_ishizaka
5.åˆ›å»ºå®¹å™¨ï¼Œä¸€ä¸ªå¤§å‘æ˜¯ï¼Œè¶…å“¥æç¤ºï¼Œåˆ›å»ºå®¹å™¨ï¼Œè¯¥é•œåƒæœ¬åœ°å¿…é¡»å­˜åœ¨å¯¹å§ï¼ï¼
[root@docker01 ~]# curl -X POST -H "Content-Type:application/json" http://127.0.0.1:2375/containers/create -d '{"image":"centos"}'
{"Id":"072c0a7ef96dae6d5bdd093bab4d03f349ec5ee5383cd5ed27c582c951b81d7f","Warnings":[]}
6.åˆ é™¤å®¹å™¨ï¼Œåé¢è·Ÿç€å®¹å™¨id
[root@docker01 ~]# curl  -X DELETE    http://127.0.0.1:2375/containers/072c0a7ef96d?v=1
```

## æ€»ç»“

æœ€åå»ºè®®ï¼Œæ”¹å›sockæœ¬åœ°è¿›ç¨‹é€šä¿¡å½¢å¼ï¼Œæ›´æ–¹ä¾¿çš„ä½¿ç”¨dockerå‘½ä»¤ã€‚



# Dockerå®¹å™¨ç¼–æ’

éšç€ç½‘ç«™æ¶æ„çš„å‡çº§ï¼Œå®¹å™¨ä¹Ÿä½¿ç”¨çš„è¶Šå‘é¢‘ç¹ï¼Œåº”ç”¨æœåŠ¡å’Œå®¹å™¨é—´çš„å…³ç³»ä¹Ÿè¶Šå‘å¤æ‚ã€‚è¿™å°±è¦æ±‚ç ”å‘äººå‘˜èƒ½å¤Ÿæ›´å¥½çš„æ–¹æ³•å»ç®¡ç†æ•°é‡è¾ƒå¤šçš„å®¹å™¨æœåŠ¡ï¼Œè€Œä¸èƒ½æ‰‹åŠ¨çš„å»æŒ¨ä¸ªç®¡ç†ã€‚

ä¾‹å¦‚ä¸€ä¸ªLNMPçš„æ¶æ„ï¼Œå°±å¾—éƒ¨ç½²webæœåŠ¡å™¨ï¼Œåå°ç¨‹åºï¼Œæ•°æ®åº“ï¼Œè´Ÿè½½å‡è¡¡ç­‰ç­‰éƒ½éœ€è¦ç»Ÿä¸€éƒ¨ç½²åœ¨å®¹å™¨é‡Œï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨ç»Ÿä¸€çš„å®¹å™¨ç¼–æ’æœåŠ¡`docker-compose`ï¼Œé€šè¿‡ä¸€ä¸ªå•ç‹¬çš„`docker-compose.yml`æ¨¡æ¿æ–‡ä»¶ä¸ºä¸€ä¸ªé¡¹ç›®å®šä¹‰ä¸€ç»„ç›¸å…³è”çš„åº”ç”¨å®¹å™¨ã€‚

## docker-compose

docker-composeçš„å®šä½å°±æ˜¯*å®šä¹‰å’Œè¿è¡Œå¤šä¸ªdockerå®¹å™¨åº”ç”¨*ã€‚

ä¹‹å‰æˆ‘ä»¬äº†è§£å¯ä»¥ç”¨dockerfileæ¨¡æ¿æ–‡ä»¶è®©ç”¨æˆ·æ–¹ä¾¿çš„å®šä¹‰ä¸€ä¸ªå•ç‹¬çš„åº”ç”¨å®¹å™¨ï¼Œç„¶è€Œï¼Œå¦‚LNMPè¿™æ ·çš„Webé¡¹ç›®ï¼Œå°±æ¶‰åŠå¤šä¸ªæœåŠ¡ä¹‹é—´çš„é…åˆï¼Œå¦‚nginx,mysql,php,redisç­‰ã€‚

![img](äº‘è®¡ç®—.assets/1610862138057-4e2b6d24-b028-4d7d-bd2c-cb638e71dc2f.png)

docker-composeå°±å¯ä»¥æ»¡è¶³è¿™æ ·çš„éœ€æ±‚ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡`docker-compose.yml`æ¨¡æ¿æ–‡ä»¶ï¼Œæ¥å®šä¹‰å„å®¹æ˜“é—´çš„å…³ç³»ã€‚

## composeä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µ

- æœåŠ¡ï¼Œserviceï¼šä¸€ä¸ªåº”ç”¨çš„å®¹å™¨ï¼Œå®é™…ä¸Šå¯ä»¥åŒ…æ‹¬è‹¥å¹²ä¸ªç›¸åŒé•œåƒçš„å®¹å™¨å®ä¾‹ã€‚
- é¡¹ç›®ï¼Œprojectï¼šç”±ä¸€ç»„å…³è”çš„åº”ç”¨å®¹å™¨ç»„æˆçš„ä¸€ä¸ªå®Œæˆä¸šåŠ¡å•å…ƒã€‚

Composeé»˜è®¤ç®¡ç†çš„æ˜¯projectï¼Œé€šè¿‡å­å‘½ä»¤å¯¹é¡¹ç›®ä¸­çš„ä¸€ç»„å®¹å™¨è¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

Composeç”±pythonè¯­è¨€å¼€å‘ï¼Œè°ƒç”¨äº†Dockeræä¾›çš„APIå¯¹å®¹å™¨è¿›è¡Œç®¡ç†ã€‚

## å®‰è£…compose

composeéœ€è¦`docker engine 1.7.1+`

å®‰è£…å½¢å¼

- pythonçš„pipåŒ…ç®¡ç†å·¥å…·
- äºŒè¿›åˆ¶æ–‡ä»¶
- è¿è¡Œåœ¨å®¹å™¨é‡Œ

```plain
1.å®‰è£…compose
[root@docker01 ~]# yum install epel-release -y
2.å®‰è£…pipå·¥å…·ï¼Œé»˜è®¤æ˜¯python2ç‰ˆæœ¬
[root@docker01 ~]# yum install python-pip python-devel -y
3.å®‰è£…docker-compose
# æ›´æ¢pipæº
[root@docker01 ~]# cat ~/.pip/pip.conf
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
# å‡çº§pipå·¥å…·ç‰ˆæœ¬
pip install --upgrade pip
4.ä¸‹è½½
[root@docker01 ~]# pip install -U docker-compose
5.æ£€æŸ¥
[root@docker01 ~]# docker-compose version
/usr/lib/python2.7/site-packages/paramiko/transport.py:33: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in a future release.
  from cryptography.hazmat.backends import default_backend
docker-compose version 1.26.2, build unknown
docker-py version: 4.3.1
CPython version: 2.7.5
OpenSSL version: OpenSSL 1.0.2k-fips  26 Jan 2017
```

ä¹Ÿå¯ä»¥ç”¨äºŒè¿›åˆ¶æ–¹å¼å®‰è£…ï¼Œæ³¨æ„python2,3çš„åŒºåˆ«

```plain
1.ä¸‹è½½å®‰è£…
curl -L https://github.com/docker/compose/releases/download/1.25.5/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
2.æ£€æŸ¥ç‰ˆæœ¬
[root@docker01 ~]# docker-compose version
docker-compose version 1.25.5, build 8a1c60f6
docker-py version: 4.1.0
CPython version: 3.7.5
OpenSSL version: OpenSSL 1.1.0l  10 Sep 2019
```

## å®è·µdocker-compose

ç¼–å†™ä¸€ä¸ªpython webæ¡ˆä¾‹ï¼Œæ¶‰åŠä¸¤ä¸ªå®¹å™¨

- python webå®¹å™¨
- redisæ•°æ®åº“

éƒ¨ç½²æ­¥éª¤

```plain
1.åˆ›å»ºcomposeç›®å½•,dockerfile
[root@docker01 ~]# mkdir /chaoge_compose_app
[root@docker01 ~]# cd /chaoge_compose_app/
2.åˆ›å»ºä»£ç æ–‡ä»¶ï¼Œä¾èµ–æ–‡ä»¶
# ä»£ç æ–‡ä»¶
[root@docker01 chaoge_compose_app]# cat app.py
from flask import Flask
from redis import Redis
app = Flask(__name__)
redis = Redis(host='redis', port=6379)
@app.route('/')
def hello():
    count = redis.incr('hits')
    return 'Welcome to Chao Ge Class about docker-compose,this page has been visited {} times\n'.format(count)
if __name__ == "__main__":
    app.run(host="0.0.0.0", debug=True)
# ä¾èµ–æ–‡ä»¶
[root@docker01 chaoge_compose_app]# cat requirements.txt
flask
redis
# ä»£ç æ–‡ä»¶ç›®å½•æ ¼å¼
[root@docker01 chaoge_compose_app]# ls
app.py  Dockerfile  requirements.txt
3.æ£€æŸ¥dockerfile
[root@docker01 chaoge_compose_app]# cat Dockerfile
FROM python:2.7
MAINTAINER chaoge yc_uuu@163.com
COPY app.py /opt
COPY requirements.txt /opt
WORKDIR /opt
RUN pip install --upgrade pip -i https://pypi.douban.com/simple
RUN pip install -r requirements.txt -i https://pypi.douban.com/simple
4.æ„å»ºé•œåƒ
[root@docker01 chaoge_compose_app]# docker build  --no-cache -t chaoge/python_web .
5.è·å–redisé•œåƒä¸”è¿è¡Œ
[root@docker01 chaoge_compose_app]# docker pull redis
[root@docker01 chaoge_compose_app]# docker run -d -p 6379:6379 --name redis redis
6.è¿è¡Œflask webå®¹å™¨ï¼Œä¸”è¿›è¡Œå®¹å™¨äº’è”
[root@docker01 chaoge_compose_app]# docker run -d -p 5000:5000 --link redis:redis --name flask_web chaoge/python_web python app.py
499ba911294af0709b39dacd92fc87a33f6c0725b33d90076f810dd3060fa117
 7.è®¿é—®é¡µé¢
```

![img](äº‘è®¡ç®—.assets/1610862138070-457da095-61c9-4543-877f-1e0388dddc38.png)

æ¯æ¬¡åˆ·æ–°ï¼ŒæŸ¥çœ‹é¡µé¢åˆ·æ–°ç»Ÿè®¡æ¬¡æ•°ã€‚

## æ„å»ºdocker compose yml

å‡†å¤‡å¥½ymlæ–‡ä»¶

```plain
[root@docker01 chaoge_compose_app]# cat docker-compose.yml
web:
  image: chaoge/python_web
  command: python app.py
  ports:
    - "5000:5000"
  links:
    - redis
redis:
  image: redis
```

å¯ä»¥åœæ­¢ä¹‹å‰è¿è¡Œçš„flask webå®¹å™¨ï¼Œç”¨composeå½¢å¼è¿è¡Œã€‚

```plain
[root@docker01 chaoge_compose_app]# docker-compose up
/usr/lib/python2.7/site-packages/paramiko/transport.py:33: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in a future release.
  from cryptography.hazmat.backends import default_backend
Creating chaoge_compose_app_redis_1 ... done
Creating chaoge_compose_app_web_1   ... done
Attaching to chaoge_compose_app_redis_1, chaoge_compose_app_web_1
redis_1  | 1:C 08 Sep 2020 19:18:29.356 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
redis_1  | 1:C 08 Sep 2020 19:18:29.356 # Redis version=6.0.7, bits=64, commit=00000000, modified=0, pid=1, just started
redis_1  | 1:C 08 Sep 2020 19:18:29.356 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
redis_1  | 1:M 08 Sep 2020 19:18:29.357 * Running mode=standalone, port=6379.
redis_1  | 1:M 08 Sep 2020 19:18:29.357 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
redis_1  | 1:M 08 Sep 2020 19:18:29.357 # Server initialized
redis_1  | 1:M 08 Sep 2020 19:18:29.357 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.
redis_1  | 1:M 08 Sep 2020 19:18:29.357 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never > /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.
redis_1  | 1:M 08 Sep 2020 19:18:29.357 * Ready to accept connections
web_1    |  * Serving Flask app "app" (lazy loading)
web_1    |  * Environment: production
web_1    |    WARNING: This is a development server. Do not use it in a production deployment.
web_1    |    Use a production WSGI server instead.
web_1    |  * Debug mode: on
web_1    |  * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)
web_1    |  * Restarting with stat
web_1    |  * Debugger is active!
web_1    |  * Debugger PIN: 214-249-451
web_1    | 192.168.1.35 - - [08/Sep/2020 19:18:37] "GET / HTTP/1.1" 200 -
web_1    | 192.168.1.35 - - [08/Sep/2020 19:18:37] "GET /favicon.ico HTTP/1.1" 404 -
web_1    | 192.168.1.35 - - [08/Sep/2020 19:18:39] "GET / HTTP/1.1" 200 -
web_1    | 192.168.1.35 - - [08/Sep/2020 19:18:39] "GET /favicon.ico HTTP/1.1" 404 -
web_1    | 192.168.1.35 - - [08/Sep/2020 19:18:39] "GET / HTTP/1.1" 200 -
web_1    | 192.168.1.35 - - [08/Sep/2020 19:18:39] "GET /favicon.ico HTTP/1.1" 404 -
```

ä¹Ÿå¯ä»¥åå°è¿è¡Œcompose

```plain
[root@docker01 chaoge_compose_app]# docker-compose up -d
/usr/lib/python2.7/site-packages/paramiko/transport.py:33: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in a future release.
  from cryptography.hazmat.backends import default_backend
Starting chaoge_compose_app_redis_1 ... done
Starting chaoge_compose_app_web_1   ... done
[root@docker01 chaoge_compose_app]#
[root@docker01 chaoge_compose_app]#
[root@docker01 chaoge_compose_app]# docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
cbb605e808f7        chaoge/python_web   "python app.py"          59 seconds ago      Up 7 seconds        0.0.0.0:5000->5000/tcp   chaoge_compose_app_web_1
9e9f2039dec9        redis               "docker-entrypoint.sâ€¦"   59 seconds ago      Up 7 seconds        6379/tcp                 chaoge_compose_app_redis_1
```

ç°åœ¨æˆ‘ä»¬å°±åŸºæœ¬çš„ä¸€é”®è¿è¡Œäº†2ä¸ªå®¹å™¨æœåŠ¡ï¼Œä¸”äº’ç›¸è¿æ¥ã€‚

## composeè¿è¡Œwordpress

åªéœ€è¦å¼€å‘compose.ymlæ–‡ä»¶å³å¯

```plain
--default_authentication_plugin=mysql_native_password
æœ‰å…³mysql8çš„å¯†ç åŠ å¯†æ’ä»¶ä¿®æ”¹
ymlå‚æ•°è§£é‡Šï¼šè§£å†³å®¹å™¨çš„ä¾èµ–ã€å¯åŠ¨å…ˆåçš„é—®é¢˜ã€‚å…ˆå¯åŠ¨ï¼Œç„¶åå¯åŠ¨wordpress
depends_on:
  - db
```

ymlé…ç½®æ–‡ä»¶

```plain
[root@docker01 wordpress]# cat /chaoge_compose_app/wordpress/docker-compose.yml
version: "3"
services:
   db:
     image: mysql:8.0
     command:
      - --default_authentication_plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
     volumes:
       - db_data:/var/lib/mysql
     restart: always
     environment:
       MYSQL_ROOT_PASSWORD: chaoge888
       MYSQL_DATABASE: wordpress
       MYSQL_USER: wordpress
       MYSQL_PASSWORD: wordpress
   wordpress:
     depends_on:
       - db
     image: wordpress:latest
     ports:
       - "8000:80"
     restart: always
     environment:
       WORDPRESS_DB_HOST: db:3306
       WORDPRESS_DB_USER: wordpress
       WORDPRESS_DB_PASSWORD: wordpress
volumes:
  db_data:
```

ä¸€é”®è¿è¡Œwordpress

```plain
[root@docker01 wordpress]# docker-compose up -d
```

![img](äº‘è®¡ç®—.assets/1610862138069-123d9a4c-042a-4a11-8595-738518f43fa7.png)

# Docker Swarmé›†ç¾¤

```
swarm`ä¸€è¯çš„è§£é‡Šï¼Œæ¯”å¦‚åŠ¨ç‰©çš„ç¾¤é›†è¡Œä¸ºï¼Œé¸Ÿç¾¤ï¼Œé±¼ç¾¤ï¼Œç§‹å¤©å¾€å—é£çš„å¤§é›ç¾¤ï¼Œéƒ½ç§°ä¹‹ä¸º`Swarm behavior
```

Docker Swarmæ˜¯dockerå…¬å¸å‘å¸ƒçš„ä¸€å¥—ç®¡ç†Dockeré›†ç¾¤çš„å·¥å…·ï¼Œå°†ä¸€ç¾¤å®¹å™¨å˜æˆä¸€ä¸ªå•ä¸€çš„ä¸»æœºã€‚

Swarmä½¿ç”¨`Docker API`ä½œä¸ºå‰ç«¯è®¿é—®å…¥å£ï¼Œå„ç§å½¢å¼çš„dockerå·¥å…·éƒ½å¯ä»¥å’ŒSwarmé›†æˆä½¿ç”¨ã€‚

æ¥è‡ª Docker å®˜ç½‘çš„è¿™å¼ å›¾ç‰‡å½¢è±¡çš„å±•ç¤ºäº†é›†ç¾¤ä¸­ç®¡ç†èŠ‚ç‚¹ä¸å·¥ä½œèŠ‚ç‚¹çš„å…³ç³»ã€‚

![img](äº‘è®¡ç®—.assets/1610862205866-11a4ede4-a23d-4925-8bcb-d2eccd3f9ad3.png)

è¿è¡Œ Docker çš„ä¸»æœºå¯ä»¥ä¸»åŠ¨åˆå§‹åŒ–ä¸€ä¸ª `Swarm` é›†ç¾¤æˆ–è€…åŠ å…¥ä¸€ä¸ªå·²å­˜åœ¨çš„ `Swarm` é›†ç¾¤ï¼Œè¿™æ ·è¿™ä¸ªè¿è¡Œ Docker çš„ä¸»æœºå°±æˆä¸ºä¸€ä¸ª `Swarm` é›†ç¾¤çš„èŠ‚ç‚¹ (`node`) ã€‚

èŠ‚ç‚¹åˆ†ä¸ºç®¡ç† (`manager`) èŠ‚ç‚¹å’Œå·¥ä½œ (`worker`) èŠ‚ç‚¹ã€‚

ç®¡ç†èŠ‚ç‚¹ç”¨äº `Swarm` é›†ç¾¤çš„ç®¡ç†ï¼Œ`docker swarm` å‘½ä»¤åŸºæœ¬åªèƒ½åœ¨ç®¡ç†èŠ‚ç‚¹æ‰§è¡Œï¼ˆèŠ‚ç‚¹é€€å‡ºé›†ç¾¤å‘½ä»¤ `docker swarm leave` å¯ä»¥åœ¨å·¥ä½œèŠ‚ç‚¹æ‰§è¡Œï¼‰ã€‚ä¸€ä¸ª `Swarm` é›†ç¾¤å¯ä»¥æœ‰å¤šä¸ªç®¡ç†èŠ‚ç‚¹ï¼Œä½†åªæœ‰ä¸€ä¸ªç®¡ç†èŠ‚ç‚¹å¯ä»¥æˆä¸º `leader`ï¼Œ`leader` é€šè¿‡ `raft` åè®®å®ç°ã€‚

å·¥ä½œèŠ‚ç‚¹æ˜¯ä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹ï¼Œç®¡ç†èŠ‚ç‚¹å°†æœåŠ¡ (`service`) ä¸‹å‘è‡³å·¥ä½œèŠ‚ç‚¹æ‰§è¡Œã€‚ç®¡ç†èŠ‚ç‚¹é»˜è®¤ä¹Ÿä½œä¸ºå·¥ä½œèŠ‚ç‚¹ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®è®©æœåŠ¡åªè¿è¡Œåœ¨ç®¡ç†èŠ‚ç‚¹ã€‚

## æœåŠ¡å’Œä»»åŠ¡

ä»»åŠ¡ ï¼ˆ`Task`ï¼‰æ˜¯ `Swarm` ä¸­çš„æœ€å°çš„è°ƒåº¦å•ä½ï¼Œç›®å‰æ¥è¯´å°±æ˜¯ä¸€ä¸ªå•ä¸€çš„å®¹å™¨ã€‚

æœåŠ¡ ï¼ˆ`Services`ï¼‰ æ˜¯æŒ‡ä¸€ç»„ä»»åŠ¡çš„é›†åˆï¼ŒæœåŠ¡å®šä¹‰äº†ä»»åŠ¡çš„å±æ€§ã€‚æœåŠ¡æœ‰ä¸¤ç§æ¨¡å¼ï¼š

- `replicated services` æŒ‰ç…§ä¸€å®šè§„åˆ™åœ¨å„ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡ŒæŒ‡å®šä¸ªæ•°çš„ä»»åŠ¡ã€‚
- `global services` æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªä»»åŠ¡

ä¸¤ç§æ¨¡å¼é€šè¿‡ `docker service create` çš„ `--mode` å‚æ•°æŒ‡å®šã€‚

æ¥è‡ª Docker å®˜ç½‘çš„è¿™å¼ å›¾ç‰‡å½¢è±¡çš„å±•ç¤ºäº†å®¹å™¨ã€ä»»åŠ¡ã€æœåŠ¡çš„å…³ç³»ã€‚

![img](äº‘è®¡ç®—.assets/1610862138088-fce05034-3a82-4d50-9ed2-5f3be4699316.png)

## åˆ›å»ºSwarmé›†ç¾¤

æˆ‘ä»¬çŸ¥é“ `Swarm` é›†ç¾¤ç”± **ç®¡ç†èŠ‚ç‚¹** å’Œ **å·¥ä½œèŠ‚ç‚¹** ç»„æˆã€‚æœ¬èŠ‚æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªåŒ…å«`ä¸€ä¸ªç®¡ç†èŠ‚ç‚¹`å’Œ`ä¸¤ä¸ªå·¥ä½œèŠ‚ç‚¹`çš„æœ€å° `Swarm` é›†ç¾¤ã€‚

## Docker Machine

Docker Machine æ˜¯ Docker å®˜æ–¹ç¼–æ’ï¼ˆOrchestrationï¼‰é¡¹ç›®ä¹‹ä¸€ï¼Œè´Ÿè´£åœ¨å¤šç§å¹³å°ä¸Šå¿«é€Ÿå®‰è£… Docker ç¯å¢ƒã€‚

Docker Machine é¡¹ç›®åŸºäº Go è¯­è¨€å®ç°ï¼Œç›®å‰åœ¨ [Github](https://github.com/docker/machine) ä¸Šè¿›è¡Œç»´æŠ¤ã€‚

æœ¬ç« å°†ä»‹ç» Docker Machine çš„å®‰è£…åŠä½¿ç”¨ã€‚

![img](äº‘è®¡ç®—.assets/1610862138121-198b54e6-f88e-445e-af61-d89e8bbd3925.png)

### å®‰è£…Docker Machine

**å®¿ä¸»æœºçš„é…ç½®é«˜ä¸€ç‚¹ï¼Œå› ä¸ºè¦è¿è¡Œå¤šä¸ªdockerä¸»æœº**

```plain
2 cpu
4G
```

å®‰è£…docker-machine

```plain
åœ¨ Linux ä¸Šçš„ä¹Ÿå®‰è£…ååˆ†ç®€å•ï¼Œä» å®˜æ–¹ GitHub Release å¤„ç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶å³å¯ã€‚
ä¾‹å¦‚ï¼Œåœ¨ Linux 64 ä½ç³»ç»Ÿä¸Šç›´æ¥ä¸‹è½½å¯¹åº”çš„äºŒè¿›åˆ¶åŒ…ã€‚
$ sudo curl -L https://github.com/docker/machine/releases/download/v0.16.1/docker-machine-`uname -s`-`uname -m` > /usr/local/bin/docker-machine
$ sudo chmod +x /usr/local/bin/docker-machine
[root@docker01 ~]# docker-machine version
docker-machine version 0.16.1, build cce350d7
```

### åˆ›å»ºæœ¬åœ°ä¸»æœºå®ä¾‹

ä½¿ç”¨ `virtualbox` ç±»å‹çš„é©±åŠ¨ï¼Œåˆ›å»ºä¸€å° Docker ä¸»æœºï¼Œå‘½åä¸º testã€‚

```plain
[root@docker01 ~]# docker-machine create -d virtualbox test
Creating CA: /root/.docker/machine/certs/ca.pem
Creating client certificate: /root/.docker/machine/certs/cert.pem
Running pre-create checks...
Error with pre-create check: "VBoxManage not found. Make sure VirtualBox is installed and VBoxManage is in the path"
# æ³¨æ„è¿™é‡ŒæŠ¥é”™äº†ï¼Œéœ€è¦å®‰è£…virtualboxæº
[root@docker01 ~]# cat /etc/yum.repos.d/virtulbox.repo
[virtualbox]
name=Oracle Linux / RHEL / CentOS-$releasever / $basearch - VirtualBox
baseurl=http://download.virtualbox.org/virtualbox/rpm/el/$releasever/$basearch
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://www.virtualbox.org/download/oracle_vbox.asc
#å®‰è£…virtualbox
yum install -y VirtualBox-5.2
```

è§£å†³å®Œç¯å¢ƒé—®é¢˜ï¼Œå†æ¥å®‰è£…dockerä¸»æœº

```plain
# æ‰§è¡Œå‘½ä»¤
docker-machine create \
      -d  virtualbox  \
      --engine-opt dns=114.114.114.114 \
      --engine-registry-mirror https://hub-mirror.c.163.com \
      test
# å¦‚æœåˆå‘ç°å¦‚ä¸‹é”™è¯¯ï¼Œ
Error with pre-create check: "This computer doesn't have VT-X/AMD-v enabled. Enabling it in the BIOS is mandatory"
éœ€è¦ä½ æ‰“å¼€cpuæ”¯æŒè™šæ‹ŸåŒ–ã€‚
å»vmwareé‡Œæ‰¾åˆ°cpuè®¾ç½®æ‰“å¼€ã€‚
# å†æ¥é‡æ–°åˆ›å»ºï¼Œæ‰§è¡Œå‘½ä»¤
[root@docker01 ~]#
[root@docker01 ~]# docker-machine create \
>       -d  virtualbox  \
>       --engine-opt dns=114.114.114.114 \
>       --engine-registry-mirror https://hub-mirror.c.163.com \
>       test
Running pre-create checks...
(test) Image cache directory does not exist, creating it at /root/.docker/machine/cache...
(test) No default Boot2Docker ISO found locally, downloading the latest release...
(test) Latest release for github.com/boot2docker/boot2docker is v19.03.12
(test) Downloading /root/.docker/machine/cache/boot2docker.iso from https://github.com/boot2docker/boot2docker/releases/download/v19.03.12/boot2docker.iso...
(test) 0%....10%....20%....30%....40%....50%....60%....70%....80%....90%....100%
Creating machine...
(test) Copying /root/.docker/machine/cache/boot2docker.iso to /root/.docker/machine/machines/test/boot2docker.iso...
(test) Creating VirtualBox VM...
(test) Creating SSH key...
(test) Starting the VM...
(test) Check network to re-create if needed...
(test) Found a new host-only adapter: "vboxnet0"
(test) Waiting for an IP...
Waiting for machine to be running, this may take a few minutes...
Detecting operating system of created instance...
Waiting for SSH to be available...
Detecting the provisioner...
Provisioning with boot2docker...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Checking connection to Docker...
Docker is up and running!
To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env test
```

### ä½¿ç”¨ä¸»æœº

```plain
[root@docker01 ~]# docker-machine ls
NAME   ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER      ERRORS
test   -        virtualbox   Running   tcp://192.168.99.100:2376           v19.03.12
1.ç™»é™†testä¸»æœº
[root@docker01 ~]# docker-machine ssh test
   ( '>')
  /) TC (\   Core is distributed with ABSOLUTELY NO WARRANTY.
 (/-_--_-\)           www.tinycorelinux.net
docker@test:~$
```

åœ¨docker-machineé…ç½®å¥½äº†ä¹‹åï¼Œå¯ä»¥åˆ©ç”¨è¯¥å·¥å…·ï¼Œå­¦ä¹ `docker swarm`äº†.

åˆ©ç”¨è¯¥å·¥å…·ï¼Œå¯ä»¥å°‘å¼€å‡ ä¸ªvmè™šæ‹Ÿæœºäº†ã€‚

### docker-machineå‘½ä»¤

### æ“ä½œå‘½ä»¤

- `active` æŸ¥çœ‹æ´»è·ƒçš„ Docker ä¸»æœº
- `config` è¾“å‡ºè¿æ¥çš„é…ç½®ä¿¡æ¯
- `create` åˆ›å»ºä¸€ä¸ª Docker ä¸»æœº
- `env` æ˜¾ç¤ºè¿æ¥åˆ°æŸä¸ªä¸»æœºéœ€è¦çš„ç¯å¢ƒå˜é‡
- `inspect` è¾“å‡ºä¸»æœºæ›´å¤šä¿¡æ¯
- `ip` è·å–ä¸»æœºåœ°å€
- `kill` åœæ­¢æŸä¸ªä¸»æœº
- `ls` åˆ—å‡ºæ‰€æœ‰ç®¡ç†çš„ä¸»æœº
- `provision` é‡æ–°è®¾ç½®ä¸€ä¸ªå·²å­˜åœ¨çš„ä¸»æœº
- `regenerate-certs` ä¸ºæŸä¸ªä¸»æœºé‡æ–°ç”Ÿæˆ TLS è®¤è¯ä¿¡æ¯
- `restart` é‡å¯ä¸»æœº
- `rm` åˆ é™¤æŸå°ä¸»æœº
- `ssh` SSH åˆ°ä¸»æœºä¸Šæ‰§è¡Œå‘½ä»¤
- `scp` åœ¨ä¸»æœºä¹‹é—´å¤åˆ¶æ–‡ä»¶
- `mount` æŒ‚è½½ä¸»æœºç›®å½•åˆ°æœ¬åœ°
- `start` å¯åŠ¨ä¸€ä¸ªä¸»æœº
- `status` æŸ¥çœ‹ä¸»æœºçŠ¶æ€
- `stop` åœæ­¢ä¸€ä¸ªä¸»æœº
- `upgrade` æ›´æ–°ä¸»æœº Docker ç‰ˆæœ¬ä¸ºæœ€æ–°
- `url` è·å–ä¸»æœºçš„ URL
- `version` è¾“å‡º docker-machine ç‰ˆæœ¬ä¿¡æ¯
- `help` è¾“å‡ºå¸®åŠ©ä¿¡æ¯

æ¯ä¸ªå‘½ä»¤ï¼Œåˆå¸¦æœ‰ä¸åŒçš„å‚æ•°ï¼ŒæŸ¥çœ‹å…·ä½“ç”¨æ³•å‘½ä»¤å¦‚ä¸‹

```plain
$ docker-machine COMMAND --help
```

## åˆå§‹åŒ–swarmé›†ç¾¤

åœ¨ `Docker Machine` ä¸€èŠ‚ä¸­æˆ‘ä»¬äº†è§£åˆ° `Docker Machine` å¯ä»¥åœ¨æ•°ç§’å†…åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„ Docker ä¸»æœºï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨å®ƒæ¥åˆ›å»ºä¸‰ä¸ª Docker ä¸»æœºï¼Œå¹¶åŠ å…¥åˆ°é›†ç¾¤ä¸­ã€‚

æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ª Docker ä¸»æœºä½œä¸ºç®¡ç†èŠ‚ç‚¹ã€‚

```plain
1.åˆ›å»ºç®¡ç†èŠ‚ç‚¹
docker-machine create -d virtualbox  \
      -engine-opt dns=114.114.114.114 \
      --engine-registry-mirror https://hub-mirror.c.163.com \
      manager
2.è¿æ¥managerä¸»æœº
[root@docker01 ~]# docker-machine ssh manager
   ( '>')
  /) TC (\   Core is distributed with ABSOLUTELY NO WARRANTY.
 (/-_--_-\)           www.tinycorelinux.net
docker@manager:~$ docker swarm init --advertise-addr 192.168.99.100
Swarm initialized: current node (lo9mvfevybtcy7dqmr2bi9cxb) is now a manager.
To add a worker to this swarm, run the following command:
    docker swarm join --token SWMTKN-1-5w739v2n2bxxcmeoqc4gycmkwsbxm1j1np2uiyhwxyjhxzhe6h-8x5iwwatcan0by1no0yhtc80e 192.168.99.100:2377
To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
```

æ‰§è¡Œ `docker swarm init` å‘½ä»¤çš„èŠ‚ç‚¹è‡ªåŠ¨æˆä¸ºç®¡ç†èŠ‚ç‚¹ã€‚

### å¢åŠ å·¥ä½œèŠ‚ç‚¹

ä¸Šä¸€æ­¥æˆ‘ä»¬åˆå§‹åŒ–äº†ä¸€ä¸ª `Swarm` é›†ç¾¤ï¼Œæ‹¥æœ‰äº†ä¸€ä¸ªç®¡ç†èŠ‚ç‚¹ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­åˆ›å»ºä¸¤ä¸ª Docker ä¸»æœºä½œä¸ºå·¥ä½œèŠ‚ç‚¹ï¼Œå¹¶åŠ å…¥åˆ°é›†ç¾¤ä¸­ã€‚

```plain
# åˆ›å»ºworker1èŠ‚ç‚¹
docker-machine create -d virtualbox \
      -engine-opt dns=114.114.114.114 \
      --engine-registry-mirror https://hub-mirror.c.163.com \
      worker1
 # åŠ å…¥swarmé›†ç¾¤
 [root@docker01 ~]# docker-machine ssh worker1
   ( '>')
  /) TC (\   Core is distributed with ABSOLUTELY NO WARRANTY.
 (/-_--_-\)           www.tinycorelinux.net
# åŠ å…¥é›†ç¾¤
    docker swarm join --token SWMTKN-1-5w739v2n2bxxcmeoqc4gycmkwsbxm1j1np2uiyhwxyjhxzhe6h-8x5iwwatcan0by1no0yhtc80e 192.168.99.100:2377
    This node joined a swarm as a worker.
```

æ“ä½œwoker2èŠ‚ç‚¹

```plain
# åˆ›å»º
docker-machine create -d virtualbox \
      -engine-opt dns=114.114.114.114 \
      --engine-registry-mirror https://hub-mirror.c.163.com \
      worker2
# åŠ å…¥swarmé›†ç¾¤
[root@docker01 ~]# docker-machine ssh worker1
   ( '>')
  /) TC (\   Core is distributed with ABSOLUTELY NO WARRANTY.
 (/-_--_-\)           www.tinycorelinux.net
docker@worker1:~$
    docker swarm join --token SWMTKN-1-5w739v2n2bxxcmeoqc4gycmkwsbxm1j1np2uiyhwxyjhxzhe6h-8x5iwwatcan0by1no0yhtc80e 192.168.99.100:2377
```

### æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯

```plain
[root@docker01 ~]# docker-machine ssh manager
   ( '>')
  /) TC (\   Core is distributed with ABSOLUTELY NO WARRANTY.
 (/-_--_-\)           www.tinycorelinux.net
docker@manager:~$ docker node ls
ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
lo9mvfevybtcy7dqmr2bi9cxb *   manager             Ready               Active              Leader              19.03.12
1lfq4isfe3zf3tpk9rqt807pv     worker1             Ready               Active                                  19.03.12
fjj2y0nz5dbb8qk8srftxxxot     worker2             Ready               Active                                  19.03.12
```

## éƒ¨ç½²æœåŠ¡

æˆ‘ä»¬ä½¿ç”¨ `docker service` å‘½ä»¤æ¥ç®¡ç† `Swarm` é›†ç¾¤ä¸­çš„æœåŠ¡ï¼Œè¯¥å‘½ä»¤åªèƒ½åœ¨ç®¡ç†èŠ‚ç‚¹è¿è¡Œã€‚

### æ–°å»ºnginxæœåŠ¡

ç°åœ¨æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚åˆ›å»ºçš„ `Swarm` é›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªåä¸º `nginx` æœåŠ¡ã€‚

```plain
docker@manager:~$ docker service create --replicas 3 -p 80:80 --name nginx nginx:1.13.7-alpine
ctolfg0bzgilqcoz20bq7uzt8
overall progress: 3 out of 3 tasks
1/3: running   [==================================================>]
2/3: running   [==================================================>]
3/3: running   [==================================================>]
verify: Service converged
--replicas 3 è¡¨ç¤ºåœ¨ä¸‰ä¸ªdockerä¸»æœºä¸Šåˆ†åˆ«åˆ›å»ºnginxæœåŠ¡
[root@docker01 ~]# docker-machine ls
NAME      ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER      ERRORS
manager   -        virtualbox   Running   tcp://192.168.99.100:2376           v19.03.12
worker1   -        virtualbox   Running   tcp://192.168.99.101:2376           v19.03.12
worker2   -        virtualbox   Running   tcp://192.168.99.102:2376           v19.03.12
[root@docker01 ~]# curl 192.168.99.100
```

## æŸ¥çœ‹æœåŠ¡

```plain
[root@docker01 ~]# docker-machine ssh manager
   ( '>')
  /) TC (\   Core is distributed with ABSOLUTELY NO WARRANTY.
 (/-_--_-\)           www.tinycorelinux.net
# æŸ¥çœ‹swarmé›†ç¾¤æœåŠ¡çŠ¶æ€
docker@manager:~$ docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE                 PORTS
ctolfg0bzgil        nginx               replicated          3/3                 nginx:1.13.7-alpine   *:80->80/tcp
# æŸ¥çœ‹æœåŠ¡è¯¦æƒ…
docker@manager:~$ docker service ps nginx
ID                  NAME                IMAGE                 NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
11gbhumx91nf        nginx.1             nginx:1.13.7-alpine   worker2             Running             Running 15 minutes ago
pf5icmgqlitk        nginx.2             nginx:1.13.7-alpine   worker1             Running             Running 15 minutes ago
1hdmj18a2m2g        nginx.3             nginx:1.13.7-alpine   manager             Running             Running 15 minutes ago
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker@manager:~$ docker service logs nginx
nginx.1.11gbhumx91nf@worker2    | 10.0.0.2 - - [09/Sep/2020:10:56:01 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.29.0" "-"
nginx.3.1hdmj18a2m2g@manager    | 10.0.0.2 - - [09/Sep/2020:10:56:07 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.29.0" "-"
nginx.2.pf5icmgqlitk@worker1    | 10.0.0.3 - - [09/Sep/2020:10:48:11 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.54.1" "-"
nginx.2.pf5icmgqlitk@worker1    | 10.0.0.2 - - [09/Sep/2020:02:53:40 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.29.0" "-"
```

## æœåŠ¡ä¼¸ç¼©

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `docker service scale` å¯¹ä¸€ä¸ªæœåŠ¡è¿è¡Œçš„å®¹å™¨æ•°é‡è¿›è¡Œä¼¸ç¼©ã€‚

å½“ä¸šåŠ¡å¤„äºé«˜å³°æœŸæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å±•æœåŠ¡è¿è¡Œçš„å®¹å™¨æ•°é‡ã€‚

```plain
docker@manager:~$ docker service scale nginx=5
nginx scaled to 5
overall progress: 5 out of 5 tasks
1/5: running   [==================================================>]
2/5: running   [==================================================>]
3/5: running   [==================================================>]
4/5: running   [==================================================>]
5/5: running   [==================================================>]
verify: Service converged
# æ£€æŸ¥æœåŠ¡è¯¦æƒ…
docker@manager:~$ docker service ps nginx
ID                  NAME                IMAGE                 NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
11gbhumx91nf        nginx.1             nginx:1.13.7-alpine   worker2             Running             Running 17 minutes ago
pf5icmgqlitk        nginx.2             nginx:1.13.7-alpine   worker1             Running             Running 17 minutes ago
1hdmj18a2m2g        nginx.3             nginx:1.13.7-alpine   manager             Running             Running 17 minutes ago
wiaj3oyho8mh        nginx.4             nginx:1.13.7-alpine   worker1             Running             Running 22 seconds ago
akb0qtkwhewa        nginx.5             nginx:1.13.7-alpine   manager             Running             Running 22 seconds ago
```

å½“ä¸šåŠ¡å¹³ç¨³ï¼Œå¯ä»¥å‡å°‘è¿è¡ŒæœåŠ¡çš„å®¹å™¨æ•°é‡

```plain
docker@manager:~$ docker service scale nginx=2
nginx scaled to 2
overall progress: 2 out of 2 tasks
1/2: running   [==================================================>]
2/2: running   [==================================================>]
verify: Service converged
docker@manager:~$
docker@manager:~$
docker@manager:~$ docker service ps nginx
ID                  NAME                IMAGE                 NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
11gbhumx91nf        nginx.1             nginx:1.13.7-alpine   worker2             Running             Running 18 minutes ago
pf5icmgqlitk        nginx.2             nginx:1.13.7-alpine   worker1             Running             Running 18 minutes ago
```

## åˆ é™¤æœåŠ¡

```plain
docker@manager:~$
docker@manager:~$ docker service rm nginx
nginx
docker@manager:~$ docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE               PORTS
```

# Swarmå’ŒCompose

æ­£å¦‚ä¹‹å‰ä½¿ç”¨ `docker-compose.yml` æ¥ä¸€æ¬¡é…ç½®ã€å¯åŠ¨å¤šä¸ªå®¹å™¨ï¼Œåœ¨ `Swarm` é›†ç¾¤ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ `compose` æ–‡ä»¶ ï¼ˆ`docker-compose.yml`ï¼‰ æ¥é…ç½®ã€å¯åŠ¨å¤šä¸ªæœåŠ¡ã€‚

ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `docker service create` ä¸€æ¬¡åªèƒ½éƒ¨ç½²ä¸€ä¸ªæœåŠ¡ï¼Œä½¿ç”¨ `docker-compose.yml` æˆ‘ä»¬å¯ä»¥ä¸€æ¬¡å¯åŠ¨å¤šä¸ªå…³è”çš„æœåŠ¡ã€‚

æˆ‘ä»¬ä»¥åœ¨ `Swarm` é›†ç¾¤ä¸­éƒ¨ç½² `WordPress` ä¸ºä¾‹è¿›è¡Œè¯´æ˜ã€‚

å‡†å¤‡å¥½`docker-compose.yml`æ–‡ä»¶ï¼Œæ³¨æ„æ˜¯åœ¨`swarm managerèŠ‚ç‚¹ä¸­åˆ›å»ºcomposeæ–‡ä»¶`

```plain
docker@manager:~$ cat docker-compose.yml
version: "3"
services:
  wordpress:
    image: wordpress
    ports:
      - 80:80
    networks:
      - overlay
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: wordpress
    deploy:
      mode: replicated
      replicas: 3
  db:
    image: mysql
    networks:
       - overlay
    volumes:
      - db-data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: chaoge888
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: wordpress
    deploy:
      placement:
        constraints: [node.role == manager]
  visualizer:
    image: dockersamples/visualizer:stable
    ports:
      - "8080:8080"
    stop_grace_period: 1m30s
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      placement:
        constraints: [node.role == manager]
volumes:
  db-data:
networks:
  overlay:
docker@manager:~$
```

åœ¨ `Swarm` é›†ç¾¤ç®¡ç†èŠ‚ç‚¹æ–°å»ºè¯¥æ–‡ä»¶ï¼Œå…¶ä¸­çš„ `visualizer` æœåŠ¡æä¾›ä¸€ä¸ªå¯è§†åŒ–é¡µé¢ï¼Œæˆ‘ä»¬å¯ä»¥ä»æµè§ˆå™¨ä¸­å¾ˆç›´è§‚çš„æŸ¥çœ‹é›†ç¾¤ä¸­å„ä¸ªæœåŠ¡çš„è¿è¡ŒèŠ‚ç‚¹ã€‚

åœ¨ `Swarm` é›†ç¾¤ä¸­ä½¿ç”¨ `docker-compose.yml` æˆ‘ä»¬ç”¨ `docker stack` å‘½ä»¤ï¼Œä¸‹é¢æˆ‘ä»¬å¯¹è¯¥å‘½ä»¤è¿›è¡Œè¯¦ç»†è®²è§£ã€‚

## éƒ¨ç½²æœåŠ¡

éƒ¨ç½²æœåŠ¡ä½¿ç”¨ `docker stack deploy`ï¼Œå…¶ä¸­ `-c` å‚æ•°æŒ‡å®š compose æ–‡ä»¶åã€‚

```
docker@manager:~$ docker stack deploy -c docker-compose.yml wordpress
Creating network wordpress_overlay
Creating network wordpress_default
Creating service wordpress_db
docker@manager:~$ docker service ls
ID                  NAME                   MODE                REPLICAS            IMAGE                             PORTS
ml3a3g1tyys7        wordpress_db           replicated          0/1                 mysql:latest
i06f1rn72kzn        wordpress_visualizer   replicated          0/1                 dockersamples/visualizer:stable   *:8080->8080/tcp
u0mugqk0l666        wordpress_wordpress    replicated          0/3                 wordpress:latest
```

